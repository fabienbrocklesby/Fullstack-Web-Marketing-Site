<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline License Activation Test</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Simplified BS58 decode function (only what we need)
        const bs58 = (() => {
            const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            const ALPHABET_MAP = {};
            for (let i = 0; i < ALPHABET.length; i++) {
                ALPHABET_MAP[ALPHABET.charAt(i)] = i;
            }
            
            function decode(s) {
                if (s.length === 0) return new Uint8Array();
                
                let i, j, bytes = [0];
                for (i = 0; i < s.length; i++) {
                    let c = s[i];
                    if (!(c in ALPHABET_MAP)) throw new Error('Non-base58 character');
                    
                    for (j = 0; j < bytes.length; j++) bytes[j] *= 58;
                    bytes[0] += ALPHABET_MAP[c];
                    
                    let carry = 0;
                    for (j = 0; j < bytes.length; j++) {
                        bytes[j] += carry;
                        carry = bytes[j] >> 8;
                        bytes[j] &= 0xff;
                    }
                    while (carry) {
                        bytes.push(carry & 0xff);
                        carry >>= 8;
                    }
                }
                
                // deal with leading zeros
                for (i = 0; i < s.length && s[i] === '1'; i++) {
                    bytes.push(0);
                }
                
                return new Uint8Array(bytes.reverse());
            }
            
            return { decode };
        })();

        // Copy command functions
        function copyWindowsCommand() {
            const command = 'getmac';
            navigator.clipboard.writeText(command).then(() => {
                alert('Windows command copied to clipboard!');
            });
        }

        function copyMacCommand() {
            const command = 'ifconfig en0 | grep ether | awk \'{print $2}\'';
            navigator.clipboard.writeText(command).then(() => {
                alert('macOS command copied to clipboard!');
            });
        }

        function copyLinuxCommand() {
            const command = 'ip link show | grep -A1 -E "^[0-9]+: (eth|wlan|enp)" | grep link/ether | head -n 1 | awk \'{print $2}\'';
            navigator.clipboard.writeText(command).then(() => {
                alert('Linux command copied to clipboard!');
            });
        }

        // Normalize MAC address format
        function normalizeMacAddress(mac) {
            if (!mac) return '';
            
            // Remove any non-hex characters and convert to lowercase
            const cleaned = mac.replace(/[^a-fA-F0-9]/g, '').toLowerCase();
            
            // Ensure it's 12 characters (6 bytes)
            if (cleaned.length !== 12) {
                throw new Error('Invalid MAC address. Expected 12 hex characters (6 bytes).');
            }
            
            // Format as aa:bb:cc:dd:ee:ff
            return cleaned.match(/.{2}/g).join(':');
        }
    </script>
</head>
<body class="bg-base-200 text-base-content min-h-screen p-8">
    <div class="container mx-auto max-w-4xl">
        <h1 class="text-4xl font-bold mb-8 text-center">Offline License Activation & Deactivation Test</h1>

        <div class="alert shadow-lg mb-8">
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>This page simulates your separate, offline desktop application. Use it to test the codes from your customer dashboard.</span>
          </div>
        </div>

        <!-- Get Machine ID Section -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h2 class="card-title text-2xl">Step 0: Get Your Machine ID</h2>
                <p class="mb-4">First, get your machine's MAC address. Run the command for your operating system:</p>
                
                <div class="tabs tabs-lifted">
                    <input type="radio" name="os_tabs" role="tab" class="tab" aria-label="Windows" checked />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        <div class="alert alert-info mb-4">
                            <span>Open Command Prompt (cmd) and run:</span>
                        </div>
                        <div class="mockup-code">
                            <pre data-prefix="C:\>"><code>getmac</code></pre>
                        </div>
                        <button class="btn btn-sm btn-outline mt-2" onclick="copyWindowsCommand()">Copy Command</button>
                    </div>

                    <input type="radio" name="os_tabs" role="tab" class="tab" aria-label="macOS" />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        <div class="alert alert-info mb-4">
                            <span>Open Terminal and run:</span>
                        </div>
                        <div class="mockup-code">
                            <pre data-prefix="$"><code>ifconfig en0 | grep ether | awk '{print $2}'</code></pre>
                        </div>
                        <button class="btn btn-sm btn-outline mt-2" onclick="copyMacCommand()">Copy Command</button>
                        <p class="text-xs mt-2 opacity-70">If en0 doesn't work, try en1 or check: networksetup -listallhardwareports</p>
                    </div>

                    <input type="radio" name="os_tabs" role="tab" class="tab" aria-label="Linux" />
                    <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
                        <div class="alert alert-info mb-4">
                            <span>Open Terminal and run:</span>
                        </div>
                        <div class="mockup-code">
                            <pre data-prefix="$"><code>ip link show | grep -A1 -E "^[0-9]+: (eth|wlan|enp)" | grep link/ether | head -n 1 | awk '{print $2}'</code></pre>
                        </div>
                        <button class="btn btn-sm btn-outline mt-2" onclick="copyLinuxCommand()">Copy Command</button>
                        <p class="text-xs mt-2 opacity-70">Alternative: cat /sys/class/net/*/address | head -n 1</p>
                    </div>
                </div>

                <div class="form-control mt-4">
                    <label class="label"><span class="label-text">Enter Your Machine ID (MAC Address)</span></label>
                    <input id="machineIdInput" type="text" placeholder="e.g., aa:bb:cc:dd:ee:ff" class="input input-bordered w-full" />
                    <div class="label">
                        <span class="label-text-alt">Copy the MAC address from the command output above</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Activation Column -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl">Step 1: Activation</h2>
                    <p class="mb-4">Simulates the offline application receiving an activation code.</p>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text">Enter Your License Key</span></label>
                        <input id="licenseKeyInput" type="text" placeholder="e.g., PRO-ABCD-1234-WXYZ" class="input input-bordered w-full" />
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Enter Activation Code from Dashboard</span></label>
                        <textarea id="activationCodeInput" class="textarea textarea-bordered h-24" placeholder="Paste the Base58 activation code here..."></textarea>
                    </div>

                    <div class="card-actions justify-end mt-4">
                        <button class="btn btn-primary" onclick="extractNonce()">Validate & Extract Nonce</button>
                    </div>

                    <div id="activationResult" class="mt-4 hidden"></div>
                </div>
            </div>

            <!-- Deactivation Column -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl">Step 2: Deactivation</h2>
                    <p class="mb-4">Simulates the app using the extracted nonce to create a deactivation code.</p>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text">License Key (must match Step 1)</span></label>
                        <input id="licenseKeyDeact" type="text" placeholder="Enter the same license key" class="input input-bordered w-full" />
                        <button type="button" class="btn btn-outline btn-sm mt-2" onclick="autoFillLicenseKey()">Auto-fill from Step 1</button>
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Extracted Activation Nonce</span></label>
                        <input id="nonceInput" type="text" class="input input-bordered w-full" readonly />
                    </div>

                    <div class="card-actions justify-end mt-4">
                        <button class="btn btn-secondary" onclick="generateDeactivationCode()">Generate Deactivation Code</button>
                    </div>

                    <div id="deactivationResult" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store the extracted nonce globally within this page's context
        let extractedNonce = '';

        function extractNonce() {
            const licenseKey = document.getElementById('licenseKeyInput').value;
            const activationCode = document.getElementById('activationCodeInput').value;
            const machineId = document.getElementById('machineIdInput').value;
            const resultDiv = document.getElementById('activationResult');
            const nonceInput = document.getElementById('nonceInput');

            if (!licenseKey || !activationCode || !machineId) {
                resultDiv.innerHTML = `<div class="alert alert-error"><span>Please enter license key, activation code, and machine ID.</span></div>`;
                resultDiv.classList.remove('hidden');
                return;
            }

            try {
                // Normalize the MAC address
                const normalizedMachineId = normalizeMacAddress(machineId);
                console.log('License Key:', licenseKey);
                console.log('Activation Code:', activationCode);
                console.log('Machine ID:', normalizedMachineId);
                
                // Decode the bs58 activation code (now 12 bytes: 4 license + 4 machine + 4 nonce)
                const encryptedPayload = bs58.decode(activationCode);
                console.log('Decoded buffer length:', encryptedPayload.length);
                
                if (encryptedPayload.length !== 12) {
                    throw new Error('Invalid activation code length. Expected 12 bytes.');
                }

                // Create the same hash used by the backend for license key
                const licenseKeyHash = CryptoJS.SHA256(licenseKey);
                
                // Create machine ID hash
                const machineIdHash = CryptoJS.SHA256(normalizedMachineId);
                
                // Convert hashes to bytes for XOR key (bytes 4-15 of combined hashes)
                const xorKeyBytes = [];
                
                // Use bytes 4-7 from license key hash and bytes 8-15 from machine ID hash
                for (let i = 4; i < 8; i++) {
                    const wordIndex = Math.floor(i / 4);
                    const byteIndex = i % 4;
                    xorKeyBytes.push((licenseKeyHash.words[wordIndex] >>> (8 * (3 - byteIndex))) & 0xff);
                }
                for (let i = 8; i < 16; i++) {
                    const wordIndex = Math.floor(i / 4);
                    const byteIndex = i % 4;
                    xorKeyBytes.push((machineIdHash.words[wordIndex] >>> (8 * (3 - byteIndex))) & 0xff);
                }

                // XOR decrypt the payload
                const decryptedPayload = new Uint8Array(12);
                for (let i = 0; i < 12; i++) {
                    decryptedPayload[i] = encryptedPayload[i] ^ xorKeyBytes[i];
                }

                console.log('Decrypted payload:', Array.from(decryptedPayload).map(b => b.toString(16).padStart(2, '0')).join(' '));
                
                // Verify the license key hash (first 4 bytes should match)
                const expectedKeyHashBytes = [];
                for (let i = 0; i < 4; i++) {
                    const wordIndex = Math.floor(i / 4);
                    const byteIndex = i % 4;
                    expectedKeyHashBytes.push((licenseKeyHash.words[wordIndex] >>> (8 * (3 - byteIndex))) & 0xff);
                }

                // Check if the first 4 bytes of decrypted payload match the license key hash
                let keyHashValid = true;
                for (let i = 0; i < 4; i++) {
                    if (decryptedPayload[i] !== expectedKeyHashBytes[i]) {
                        keyHashValid = false;
                        break;
                    }
                }

                if (!keyHashValid) {
                    throw new Error('This activation code is not valid for this license key. The activation code can only be used with the license key it was generated for.');
                }

                // Verify the machine ID hash (bytes 4-7 should match)
                const expectedMachineHashBytes = [];
                for (let i = 0; i < 4; i++) {
                    const wordIndex = Math.floor(i / 4);
                    const byteIndex = i % 4;
                    expectedMachineHashBytes.push((machineIdHash.words[wordIndex] >>> (8 * (3 - byteIndex))) & 0xff);
                }

                // Check if bytes 4-7 of decrypted payload match the machine ID hash
                let machineHashValid = true;
                for (let i = 0; i < 4; i++) {
                    if (decryptedPayload[i + 4] !== expectedMachineHashBytes[i]) {
                        machineHashValid = false;
                        break;
                    }
                }

                if (!machineHashValid) {
                    throw new Error('This activation code was generated for a different machine. The activation code can only be used on the machine it was created for.');
                }

                // Extract the nonce (bytes 8-11)
                const nonceBytes = decryptedPayload.slice(8, 12);
                extractedNonce = Array.from(nonceBytes).map(b => b.toString(16).padStart(2, '0')).join('');

                console.log('Extracted nonce:', extractedNonce);
                
                // Check if nonce is all zeros (shouldn't happen with proper randomization)
                if (extractedNonce === '00000000') {
                    throw new Error('Invalid nonce extracted. Please regenerate the activation code.');
                }

                nonceInput.value = extractedNonce;
                document.getElementById('licenseKeyDeact').value = licenseKey; // Pre-fill for convenience

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>✅ Activation successful! License key and machine verified, nonce extracted.</span>
                    </div>
                    <div class="mt-2 text-sm">
                        <p class="break-all"><strong>Nonce:</strong> ${extractedNonce}</p>
                        <p><strong>Code Length:</strong> ${activationCode.length} characters</p>
                        <p><strong>Security:</strong> Code is bound to this license key AND this machine</p>
                        <p><strong>Machine ID:</strong> ${normalizedMachineId}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Activation error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error"><span>❌ Activation Failed: ${error.message}</span></div>`;
                resultDiv.classList.remove('hidden');
            }
        }        function autoFillLicenseKey() {
            const licenseKeyFromActivation = document.getElementById('licenseKeyInput').value;
            if (licenseKeyFromActivation) {
                document.getElementById('licenseKeyDeact').value = licenseKeyFromActivation;
            } else {
                alert('Please complete Step 1 first to auto-fill the license key.');
            }
        }

        function generateDeactivationCode() {
            // Use the same license key from Step 1 activation
            const licenseKeyFromActivation = document.getElementById('licenseKeyInput').value;
            const licenseKeyFromDeactivation = document.getElementById('licenseKeyDeact').value;
            
            // Prefer the deactivation field if filled, otherwise use activation field
            const licenseKey = licenseKeyFromDeactivation || licenseKeyFromActivation;
            const resultDiv = document.getElementById('deactivationResult');

            if (!licenseKey || !extractedNonce) {
                resultDiv.innerHTML = `<div class="alert alert-error"><span>Please complete Step 1 first and ensure both license key and nonce are available.</span></div>`;
                resultDiv.classList.remove('hidden');
                return;
            }

            // Auto-fill the deactivation license key field for consistency
            if (!licenseKeyFromDeactivation && licenseKeyFromActivation) {
                document.getElementById('licenseKeyDeact').value = licenseKeyFromActivation;
            }

            try {
                // Get machine ID from Step 0
                const machineId = document.getElementById('machineIdInput').value.trim();
                if (!machineId) {
                    resultDiv.innerHTML = `<div class="alert alert-error"><span>Please enter your Machine ID (MAC Address) in Step 0 first.</span></div>`;
                    resultDiv.classList.remove('hidden');
                    return;
                }

                // Create structured deactivation payload
                const deactivationPayload = {
                    license_key: licenseKey,
                    machine_id: normalizeMacAddress(machineId),
                    nonce: extractedNonce,
                    timestamp: Math.floor(Date.now() / 1000),
                    app_version: "1.0.0",
                    validation_hash: CryptoJS.SHA256(licenseKey + machineId + extractedNonce).toString()
                };

                // Encode to Base64
                const jsonPayload = JSON.stringify(deactivationPayload);
                const base64Payload = btoa(jsonPayload);
                
                // Create simple checksum (CRC32 simulation)
                let checksum = 0;
                for (let i = 0; i < base64Payload.length; i++) {
                    checksum = ((checksum << 5) - checksum + base64Payload.charCodeAt(i)) & 0xffffffff;
                }
                checksum = Math.abs(checksum).toString(16).toUpperCase().padStart(8, '0');

                // Final deactivation code format: {base64_payload}.{checksum}
                const deactivationCode = `${base64Payload}.${checksum}`;

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>Structured deactivation code generated!</span>
                    </div>
                    <div class="form-control mt-4">
                        <label class="label"><span class="label-text">Deactivation Code (Copy this to dashboard):</span></label>
                        <div class="join w-full">
                            <textarea class="textarea textarea-bordered join-item flex-1 h-20" readonly>${deactivationCode}</textarea>
                            <button class="btn btn-primary join-item" onclick="navigator.clipboard.writeText('${deactivationCode}')">Copy</button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <p class="text-xs"><strong>Payload includes:</strong></p>
                        <ul class="text-xs list-disc list-inside">
                            <li>License Key: ${deactivationPayload.license_key}</li>
                            <li>Machine ID: ${deactivationPayload.machine_id}</li>
                            <li>Nonce: ${deactivationPayload.nonce}</li>
                            <li>Timestamp: ${new Date(deactivationPayload.timestamp * 1000).toLocaleString()}</li>
                            <li>Validation Hash: ${deactivationPayload.validation_hash.substring(0, 16)}...</li>
                        </ul>
                    </div>
                `;
                resultDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Deactivation code generation error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error"><span>Failed to generate deactivation code. Error: ${error.message}</span></div>`;
                resultDiv.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
