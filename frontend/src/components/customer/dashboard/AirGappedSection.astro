---
/**
 * Air-Gapped Device Activation Section
 * Provides offline provisioning, lease refresh, and deactivation for
 * devices that cannot connect to the internet.
 */
import DashboardIcon from "./DashboardIcon.astro";
import ResponsiveBadge from "../shared/ResponsiveBadge.astro";
---

<section id="airgapped-section" class="surface rounded-xl p-6 space-y-5">
  <!-- Header: flex-wrap ensures badge drops to next line on narrow screens -->
  <div class="flex flex-wrap items-start justify-between gap-3">
    <h2 class="text-lg font-semibold flex items-center gap-2 min-w-0">
      <DashboardIcon name="lock" class="w-5 h-5 text-accent shrink-0" />
      <span>Air-Gapped Device Activation</span>
    </h2>
    <ResponsiveBadge text="Subscription Only" variant="accent" size="sm" />
  </div>

  <div
    class="alert alert-warning border border-warning/25 flex max-sm:flex-col"
  >
    <DashboardIcon name="warning" class="w-12 h-12 sm:w-5 sm:h-5 shrink-0" />
    <div class="text-sm">
      <ul>
        <li class="font-medium">
          - For devices that are never connected to the internet
        </li>
        <li class="mt-1">
          - <strong>Do not type these codes manually.</strong> They are long and
          error-prone. Use USB drive or file transfer.
        </li>
      </ul>
    </div>
  </div>

  <!-- Sub-tabs for different operations -->
  <div
    role="tablist"
    class="tabs tabs-boxed bg-base-300/50 rounded-2xl overflow-x-auto"
  >
    <button
      role="tab"
      class="tab tab-active"
      id="ag-tab-provision"
      aria-controls="ag-panel-provision"
    >
      Provision Device
    </button>
    <button
      role="tab"
      class="tab"
      id="ag-tab-refresh"
      aria-controls="ag-panel-refresh"
    >
      Refresh Lease
    </button>
    <button
      role="tab"
      class="tab"
      id="ag-tab-deactivate"
      aria-controls="ag-panel-deactivate"
    >
      Deactivate
    </button>
  </div>

  <!-- Provision Panel -->
  <div id="ag-panel-provision" role="tabpanel" class="space-y-5 pt-1">
    <!-- Load error alert (shown if entitlements API failed) -->
    <div id="ag-prov-load-error" class="alert alert-error hidden">
      <DashboardIcon name="error" class="w-5 h-5 shrink-0" />
      <span id="ag-prov-load-error-text"
        >Couldn't load entitlements. Please refresh the page.</span
      >
    </div>

    <!-- Empty state (shown if no eligible entitlements) -->
    <div id="ag-prov-empty-state" class="alert alert-warning hidden">
      <DashboardIcon name="warning" class="w-5 h-5 shrink-0" />
      <p class="text-sm whitespace-pre-line">
        No eligible entitlements for offline provisioning.
      </p>
    </div>

    <div class="form-control">
      <label class="label pb-1">
        <span class="label-text font-medium">Entitlement</span>
        <span class="label-text-alt text-base-content/60"
          >Subscription only</span
        >
      </label>
      <select id="ag-prov-entitlement" class="select select-bordered w-full">
        <option value="">Loading entitlements...</option>
      </select>
    </div>

    <div class="form-control">
      <label class="label pb-1">
        <span class="label-text font-medium">Device Setup Code</span>
        <span class="label-text-alt text-base-content/60"
          >From air-gapped machine</span
        >
      </label>
      <div class="flex flex-wrap items-center gap-2 mb-2">
        <button
          type="button"
          id="ag-prov-load-file-btn"
          class="btn btn-xs btn-outline gap-1"
        >
          <DashboardIcon name="upload" class="w-3 h-3" />
          Load from file
        </button>
        <input
          type="file"
          id="ag-prov-file-input"
          class="hidden"
          accept=".txt,.json"
        />
        <span class="text-xs text-base-content/60">or paste from clipboard</span
        >
      </div>
      <textarea
        id="ag-prov-setup-code"
        class="textarea textarea-bordered w-full min-h-32 font-mono text-xs sm:text-sm"
        placeholder="Paste the device setup code from your air-gapped machine..."
      ></textarea>
    </div>

    <div id="ag-prov-error" class="alert alert-error hidden">
      <DashboardIcon name="error" class="w-5 h-5 shrink-0" />
      <span id="ag-prov-error-text"></span>
    </div>

    <button id="ag-prov-btn" class="btn btn-primary w-full" disabled>
      <span id="ag-prov-btn-text">Generate Activation Package</span>
      <span
        id="ag-prov-btn-loading"
        class="loading loading-spinner loading-sm hidden"></span>
    </button>

    <!-- Provision Result -->
    <div id="ag-prov-result" class="hidden space-y-5">
      <div class="alert alert-success">
        <DashboardIcon name="check" class="w-5 h-5 shrink-0" />
        <div>
          <p class="font-medium">Activation Package Ready</p>
          <p class="text-sm opacity-80">
            Copy and transfer to your air-gapped machine
          </p>
        </div>
      </div>

      <div class="form-control">
        <label class="label pb-1">
          <span class="label-text font-medium">Activation Package</span>
          <span class="label-text-alt text-warning" id="ag-prov-expiry"></span>
        </label>
        <p class="text-xs text-base-content/60 mb-2">
          Copy to file and transfer via USB (recommended)
        </p>
        <div class="flex flex-col sm:flex-row gap-2">
          <textarea
            id="ag-prov-output"
            class="textarea textarea-bordered w-full min-h-32 font-mono text-xs sm:text-sm flex-1"
            readonly></textarea>
          <div class="flex sm:flex-col gap-2">
            <button
              id="ag-prov-copy-btn"
              class="btn btn-primary flex-1 sm:flex-none"
            >
              <DashboardIcon name="copy" class="w-4 h-4" />
              <span>Copy</span>
            </button>
            <button
              id="ag-prov-download-btn"
              class="btn btn-outline flex-1 sm:flex-none"
            >
              <DashboardIcon name="download" class="w-4 h-4" />
              <span>Download</span>
            </button>
          </div>
        </div>
      </div>

      <button id="ag-prov-reset-btn" class="btn btn-ghost w-full"
        >Provision Another Device</button
      >
    </div>
  </div>

  <!-- Refresh Panel -->
  <div id="ag-panel-refresh" role="tabpanel" class="hidden space-y-5 pt-1">
    <div class="form-control">
      <label class="label pb-1">
        <span class="label-text font-medium">Lease Refresh Request Code</span>
        <span class="label-text-alt text-base-content/60"
          >From air-gapped machine</span
        >
      </label>
      <div class="flex flex-wrap items-center gap-2 mb-2">
        <button
          type="button"
          id="ag-refresh-load-file-btn"
          class="btn btn-xs btn-outline gap-1"
        >
          <DashboardIcon name="upload" class="w-3 h-3" />
          Load from file
        </button>
        <input
          type="file"
          id="ag-refresh-file-input"
          class="hidden"
          accept=".txt,.json"
        />
        <span class="text-xs text-base-content/60">or paste from clipboard</span
        >
      </div>
      <textarea
        id="ag-refresh-request-code"
        class="textarea textarea-bordered w-full min-h-32 font-mono text-xs sm:text-sm"
        placeholder="Paste the lease refresh request code from your air-gapped machine..."
      ></textarea>
    </div>

    <!-- Preview panel (shows decoded info if valid) -->
    <div id="ag-refresh-preview" class="alert alert-info hidden">
      <DashboardIcon name="info" class="w-5 h-5 shrink-0" />
      <div class="text-sm">
        <p class="font-medium">Code Preview</p>
        <p id="ag-refresh-preview-content" class="text-xs font-mono opacity-80">
        </p>
      </div>
    </div>

    <div id="ag-refresh-error" class="alert alert-error hidden">
      <DashboardIcon name="error" class="w-5 h-5 shrink-0" />
      <span id="ag-refresh-error-text"></span>
    </div>

    <button id="ag-refresh-btn" class="btn btn-primary w-full" disabled>
      <span id="ag-refresh-btn-text">Refresh Lease</span>
      <span
        id="ag-refresh-btn-loading"
        class="loading loading-spinner loading-sm hidden"></span>
    </button>

    <!-- Refresh Result -->
    <div id="ag-refresh-result" class="hidden space-y-5">
      <div class="alert alert-success">
        <DashboardIcon name="check" class="w-5 h-5 shrink-0" />
        <div>
          <p class="font-medium">New Lease Token Ready</p>
          <p class="text-sm opacity-80">
            Copy and transfer to your air-gapped machine
          </p>
        </div>
      </div>

      <div class="form-control">
        <label class="label pb-1">
          <span class="label-text font-medium">Refresh Response Code</span>
          <span class="label-text-alt text-warning" id="ag-refresh-expiry"
          ></span>
        </label>
        <p class="text-xs text-base-content/60 mb-2">
          Copy to file and transfer via USB (recommended)
        </p>
        <div class="flex flex-col sm:flex-row gap-2">
          <textarea
            id="ag-refresh-output"
            class="textarea textarea-bordered w-full min-h-32 font-mono text-xs sm:text-sm flex-1"
            readonly></textarea>
          <div class="flex sm:flex-col gap-2">
            <button
              id="ag-refresh-copy-btn"
              class="btn btn-primary flex-1 sm:flex-none"
            >
              <DashboardIcon name="copy" class="w-4 h-4" />
              <span>Copy</span>
            </button>
            <button
              id="ag-refresh-download-btn"
              class="btn btn-outline flex-1 sm:flex-none"
            >
              <DashboardIcon name="download" class="w-4 h-4" />
              <span>Download</span>
            </button>
          </div>
        </div>
      </div>

      <button id="ag-refresh-reset-btn" class="btn btn-ghost w-full"
        >Refresh Another</button
      >
    </div>
  </div>

  <!-- Deactivate Panel -->
  <div id="ag-panel-deactivate" role="tabpanel" class="hidden space-y-5 pt-1">
    <div class="form-control">
      <label class="label pb-1">
        <span class="label-text font-medium">Deactivation Code</span>
        <span class="label-text-alt text-base-content/60"
          >From air-gapped machine</span
        >
      </label>
      <div class="flex flex-wrap items-center gap-2 mb-2">
        <button
          type="button"
          id="ag-deact-load-file-btn"
          class="btn btn-xs btn-outline gap-1"
        >
          <DashboardIcon name="upload" class="w-3 h-3" />
          Load from file
        </button>
        <input
          type="file"
          id="ag-deact-file-input"
          class="hidden"
          accept=".txt,.json"
        />
        <span class="text-xs text-base-content/60">or paste from clipboard</span
        >
      </div>
      <textarea
        id="ag-deact-code"
        class="textarea textarea-bordered w-full min-h-32 font-mono text-xs sm:text-sm"
        placeholder="Paste the deactivation code from your air-gapped machine..."
      ></textarea>
    </div>

    <!-- Preview panel (shows decoded info if valid) -->
    <div id="ag-deact-preview" class="alert alert-info hidden">
      <DashboardIcon name="info" class="w-5 h-5 shrink-0" />
      <div class="text-sm">
        <p class="font-medium">Code Preview</p>
        <p id="ag-deact-preview-content" class="text-xs font-mono opacity-80">
        </p>
      </div>
    </div>

    <div id="ag-deact-error" class="alert alert-error hidden">
      <DashboardIcon name="error" class="w-5 h-5 shrink-0" />
      <span id="ag-deact-error-text"></span>
    </div>

    <button id="ag-deact-btn" class="btn btn-error w-full" disabled>
      <span id="ag-deact-btn-text">Deactivate Device</span>
      <span
        id="ag-deact-btn-loading"
        class="loading loading-spinner loading-sm hidden"></span>
    </button>

    <!-- Deactivate Result -->
    <div id="ag-deact-result" class="hidden space-y-4">
      <div class="alert alert-success">
        <DashboardIcon name="check" class="w-5 h-5 shrink-0" />
        <div>
          <p class="font-medium">Device Deactivated</p>
          <p class="text-sm opacity-80">
            The device seat has been freed. You can now activate another device.
          </p>
        </div>
      </div>
      <button id="ag-deact-reset-btn" class="btn btn-ghost w-full"
        >Deactivate Another</button
      >
    </div>
  </div>
</section>
