---
type CountdownSize = "xs" | "sm" | "md" | "lg" | "xl";

interface Props {
  target: string; // ISO date e.g. 2025-10-15T00:00:00Z
  label?: string;
  align?: "left" | "center" | "right";
  size?: CountdownSize;
  class?: string;
}
const {
  target,
  label = "Offer ends in",
  align = "center",
  size = "md",
  class: klass = "",
} = Astro.props as Props;
const justifyClass =
  align === "center"
    ? "justify-center"
    : align === "right"
      ? "justify-end"
      : "justify-start";
const sizePresets: Record<
  CountdownSize,
  {
    valueTextClass: string;
    valueWidthClass: string;
    valueHeightClass: string;
    unitTextClass: string;
    labelTextClass: string;
    gapClass: string;
  }
> = {
  xs: {
    valueTextClass: "text-base",
    valueWidthClass: "w-9",
    valueHeightClass: "h-[1.15em]",
    unitTextClass: "text-[9px]",
    labelTextClass: "text-xs",
    gapClass: "gap-3",
  },
  sm: {
    valueTextClass: "text-lg",
    valueWidthClass: "w-10",
    valueHeightClass: "h-[1.25em]",
    unitTextClass: "text-[10px]",
    labelTextClass: "text-sm",
    gapClass: "gap-4",
  },
  md: {
    valueTextClass: "text-2xl",
    valueWidthClass: "w-12",
    valueHeightClass: "h-[1.4em]",
    unitTextClass: "text-[11px]",
    labelTextClass: "text-sm",
    gapClass: "gap-4",
  },
  lg: {
    valueTextClass: "text-3xl",
    valueWidthClass: "w-14",
    valueHeightClass: "h-[1.5em]",
    unitTextClass: "text-xs",
    labelTextClass: "text-base",
    gapClass: "gap-5",
  },
  xl: {
    valueTextClass: "text-4xl md:text-5xl",
    valueWidthClass: "w-20",
    valueHeightClass: "h-[1.7em]",
    unitTextClass: "text-sm",
    labelTextClass: "text-base md:text-lg",
    gapClass: "gap-6",
  },
};

const sizeConfig = sizePresets[size] ?? sizePresets.md;
---

<div
  class={`ll-countdown space-y-3 ${align === "center" ? "text-center" : align === "right" ? "text-right" : ""} ${klass}`}
  data-target={target}
>
  {
    label && (
      <div class={`${sizeConfig.labelTextClass} opacity-70`}>{label}</div>
    )
  }
  <div class={`flex ${sizeConfig.gapClass} items-end ${justifyClass}`}>
    <span class="flex flex-col items-center">
      <span
        class={`value value-days ${sizeConfig.valueTextClass} ${sizeConfig.valueWidthClass} ${sizeConfig.valueHeightClass} relative overflow-hidden font-mono tabular-nums inline-flex items-center justify-center bg-base-200/60 border border-base-300 rounded-xl px-2 py-1 shadow-sm`}
      >
        <span class="cd-days current">0</span>
      </span>
      <span class={`opacity-60 ${sizeConfig.unitTextClass} mt-1`}> days</span>
    </span>

    <span class="flex flex-col items-center">
      <span
        class={`value value-hours ${sizeConfig.valueTextClass} ${sizeConfig.valueWidthClass} ${sizeConfig.valueHeightClass} relative overflow-hidden font-mono tabular-nums inline-flex items-center justify-center bg-base-200/60 border border-base-300 rounded-xl px-2 py-1 shadow-sm`}
      >
        <span class="cd-hours current">0</span>
      </span>
      <span class={`opacity-60 ${sizeConfig.unitTextClass} mt-1`}>h</span>
    </span>

    <span class="flex flex-col items-center">
      <span
        class={`value value-mins ${sizeConfig.valueTextClass} ${sizeConfig.valueWidthClass} ${sizeConfig.valueHeightClass} relative overflow-hidden font-mono tabular-nums inline-flex items-center justify-center bg-base-200/60 border border-base-300 rounded-xl px-2 py-1 shadow-sm`}
      >
        <span class="cd-mins current">0</span>
      </span>
      <span class={`opacity-60 ${sizeConfig.unitTextClass} mt-1`}>m</span>
    </span>

    <span class="flex flex-col items-center">
      <span
        class={`value value-secs ${sizeConfig.valueTextClass} ${sizeConfig.valueWidthClass} ${sizeConfig.valueHeightClass} relative overflow-hidden font-mono tabular-nums inline-flex items-center justify-center bg-base-200/60 border border-base-300 rounded-xl px-2 py-1 shadow-sm`}
      >
        <span class="cd-secs current">0</span>
      </span>
      <span class={`opacity-60 ${sizeConfig.unitTextClass} mt-1`}>s</span>
    </span>
  </div>
</div>

<script>
  (function () {
    const EASE = "cubic-bezier(0.22, 1, 0.36, 1)";
    const DURATION = 320;
    const buildClassName = (state: string, unitClass?: string) =>
      [state, unitClass].filter(Boolean).join(" ");
    const animateValue = (
      container: HTMLElement | null,
      value: number,
      unitClass?: string,
    ) => {
      if (!container) return;
      const current = container.querySelector(".current") as HTMLElement | null;
      const nextText = String(value);
      if (current && current.textContent === nextText) return;
      container
        .querySelectorAll(":scope > span:not(.current)")
        .forEach((node) => node.remove());
      const transition = `transform ${DURATION}ms ${EASE}, opacity ${DURATION}ms ${EASE}`;
      const next = document.createElement("span");
      next.className = buildClassName("next", unitClass);
      next.textContent = nextText;
      Object.assign(next.style, {
        position: "absolute",
        left: "0",
        right: "0",
        transform: "translateY(100%)",
        opacity: "0",
        transition,
      });
      container.appendChild(next);
      if (current) {
        Object.assign(current.style, {
          position: "absolute",
          left: "0",
          right: "0",
          transform: "translateY(0)",
          opacity: "1",
          transition,
        });
      }
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          if (current) {
            current.style.transform = "translateY(-100%)";
            current.style.opacity = "0";
          }
          next.style.transform = "translateY(0)";
          next.style.opacity = "1";
        });
      });
      const finalize = () => {
        next.removeEventListener("transitionend", finalize);
        if (current && current.parentElement === container) current.remove();
        next.className = buildClassName("current", unitClass);
        next.removeAttribute("style");
        container
          .querySelectorAll(":scope > span:not(.current)")
          .forEach((node) => node.remove());
      };
      next.addEventListener("transitionend", finalize);
      setTimeout(finalize, DURATION + 100);
    };
    const roots = document.querySelectorAll(
      ".ll-countdown:not([data-initialized])",
    );
    roots.forEach((root) => {
      if (!(root instanceof HTMLElement)) return;
      root.setAttribute("data-initialized", "1");
      const targetStr = root.getAttribute("data-target") || "";
      const end = new Date(targetStr).getTime();
      if (!end || isNaN(end)) return;
      const daysContainer = root.querySelector(
        ".value-days",
      ) as HTMLElement | null;
      const hoursContainer = root.querySelector(
        ".value-hours",
      ) as HTMLElement | null;
      const minsContainer = root.querySelector(
        ".value-mins",
      ) as HTMLElement | null;
      const secsContainer = root.querySelector(
        ".value-secs",
      ) as HTMLElement | null;
      const update = () => {
        const now = Date.now();
        let diff = Math.max(0, Math.floor((end - now) / 1000));
        const days = Math.floor(diff / 86400);
        diff -= days * 86400;
        const hours = Math.floor(diff / 3600);
        diff -= hours * 3600;
        const mins = Math.floor(diff / 60);
        diff -= mins * 60;
        const secs = diff;
        animateValue(daysContainer, days, "cd-days");
        animateValue(hoursContainer, hours, "cd-hours");
        animateValue(minsContainer, mins, "cd-mins");
        animateValue(secsContainer, secs, "cd-secs");
      };
      update();
      const t = setInterval(update, 1000);
      window.addEventListener("beforeunload", () => clearInterval(t));
    });
  })();
</script>

<style is:global>
  .ll-countdown .value {
    min-width: 2ch;
    position: relative;
    overflow: hidden;
  }
</style>
