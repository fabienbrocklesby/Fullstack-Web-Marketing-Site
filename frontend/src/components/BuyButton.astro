---
export interface Props {
  text?: string;
  priceId?: string;
  tier?: "maker" | "pro";
  mode?: "payment" | "subscription";
  className?: string;
  variant?: "primary" | "secondary" | "accent" | "ghost";
}

const {
  text = "Subscribe",
  priceId = "price_default",
  tier,
  mode = "subscription",
  className = "",
  variant = "primary",
} = Astro.props;

// Generate unique button ID for each price
const buttonId = `buy-button-${priceId}`;
---

<button
  id={buttonId}
  class={`btn btn-${variant} ${className}`}
  data-price-id={priceId}
  data-tier={tier || (priceId === "price_maker" ? "maker" : "pro")}
  data-mode={mode}
>
  {text}
</button>

<script>
  import Cookies from "js-cookie";

  // Initialize buy buttons on DOM ready without waiting for tracker
  document.addEventListener("DOMContentLoaded", () => {
    initializeBuyButton();
  });

  function initializeBuyButton() {
    // Handle buy button click - find all buy buttons
    const buyButtons = document.querySelectorAll('[id^="buy-button-"]');
    buyButtons.forEach((buyButton) => {
      if (buyButton) {
        buyButton.addEventListener("click", async (e) => {
          e.preventDefault();

          const priceId = buyButton.getAttribute("data-price-id");
          const tier = buyButton.getAttribute("data-tier") as "maker" | "pro";
          const mode = buyButton.getAttribute("data-mode") || "payment";
          const affiliateCode =
            Cookies.get("affiliate_code") ||
            localStorage.getItem("affiliate_code");

          // Track button click event for conversion analysis using journey tracker
          if ((window as any).journeyTracker) {
            await (window as any).journeyTracker.trackAction(
              "pricing_button_click",
              window.location.pathname,
              {
                priceId: priceId,
                tier: tier,
                mode: mode,
                buttonText: buyButton.textContent?.trim() || "",
                timestamp: new Date().toISOString(),
              },
            );
          }

          // Store selected product in localStorage for later purchase
          localStorage.setItem(
            "selectedProduct",
            JSON.stringify({
              priceId,
              tier,
              mode,
              timestamp: Date.now(),
              affiliateCode: affiliateCode || null,
            }),
          );

          // Check if customer is already logged in
          const customerToken = localStorage.getItem("customerToken");
          const customer = JSON.parse(localStorage.getItem("customer") || "{}");

          if (customerToken && customer.id) {
            // Track checkout initiation using journey tracker
            if ((window as any).journeyTracker && affiliateCode) {
              await (window as any).journeyTracker.trackCheckoutInitiated(
                priceId || "",
                customer.id,
              );
            }

            // Customer is logged in, proceed to checkout
            if (mode === "subscription") {
              await proceedToSubscriptionCheckout(tier);
            } else {
              await proceedToCheckout(priceId || "");
            }
          } else {
            // Track registration redirect for logged-out users
            if ((window as any).journeyTracker && affiliateCode) {
              await (window as any).journeyTracker.trackAction(
                "registration_redirect",
                window.location.pathname,
                {
                  priceId: priceId,
                  tier: tier,
                  mode: mode,
                  timestamp: new Date().toISOString(),
                },
              );
            }

            // Redirect to customer registration with product info and context
            window.location.href = `/customer/register?from=pricing&product=${encodeURIComponent(priceId ?? "")}&tier=${encodeURIComponent(tier || "")}&mode=${encodeURIComponent(mode)}&redirect=checkout`;
          }
        });
      }
    });
  }

  async function proceedToCheckout(priceId: string) {
    const savedAffiliateCode = Cookies.get("affiliate_code");
    const customerToken = localStorage.getItem("customerToken");

    try {
      const cmsUrl =
        document.documentElement.getAttribute("data-cms-url") ||
        "http://localhost:1337";
      const response = await fetch(`${cmsUrl}/api/customer-checkout`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${customerToken}`,
        },
        body: JSON.stringify({
          priceId,
          affiliateCode: savedAffiliateCode || null,
          successUrl: window.location.origin + "/customer/success",
          cancelUrl: window.location.origin + "/customer/dashboard",
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("Checkout error response:", errorData);
        throw new Error(
          errorData.error?.message ||
            errorData.message ||
            "Failed to create checkout session",
        );
      }

      const { url } = await response.json();
      if (url) {
        window.location.href = url;
      } else {
        throw new Error("No checkout URL received");
      }
    } catch (error) {
      console.error("Checkout error:", error);
      alert(
        `Something went wrong: ${error instanceof Error ? error.message : "Please try again."}`,
      );
    }
  }

  async function proceedToSubscriptionCheckout(tier: "maker" | "pro") {
    const savedAffiliateCode = Cookies.get("affiliate_code");
    const customerToken = localStorage.getItem("customerToken");

    try {
      const cmsUrl =
        document.documentElement.getAttribute("data-cms-url") ||
        "http://localhost:1337";
      const response = await fetch(
        `${cmsUrl}/api/customer-checkout-subscription`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${customerToken}`,
          },
          body: JSON.stringify({
            tier,
            affiliateCode: savedAffiliateCode || null,
            successPath: "/customer/success",
            cancelPath: "/customer/dashboard",
          }),
        },
      );

      if (!response.ok) {
        const errorData = await response.json();
        console.error("Subscription checkout error response:", errorData);
        throw new Error(
          errorData.error?.message ||
            errorData.message ||
            "Failed to create subscription checkout session",
        );
      }

      const { url } = await response.json();
      if (url) {
        window.location.href = url;
      } else {
        throw new Error("No checkout URL received");
      }
    } catch (error) {
      console.error("Subscription checkout error:", error);
      alert(
        `Something went wrong: ${error instanceof Error ? error.message : "Please try again."}`,
      );
    }
  }

  // Make functions available globally for use in other scripts
  (window as any).proceedToCheckout = proceedToCheckout;
  (window as any).proceedToSubscriptionCheckout = proceedToSubscriptionCheckout;

  // Track affiliate visit function
  async function trackAffiliateVisit(affiliateCode: string) {
    try {
      const cmsUrl =
        document.documentElement.getAttribute("data-cms-url") ||
        "http://localhost:1337";

      await fetch(`${cmsUrl}/api/track-affiliate-visit`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          affiliateCode: affiliateCode,
          referrer: document.referrer,
          userAgent: navigator.userAgent,
          page: window.location.pathname,
          timestamp: new Date().toISOString(),
        }),
      });

      console.log(`[Stats] Tracked visit for affiliate: ${affiliateCode}`);
    } catch (error) {
      console.warn("Failed to track affiliate visit:", error);
    }
  }

  // Track page views for conversion funnel analysis
  async function trackPageView(affiliateCode: string, page: string) {
    try {
      const cmsUrl =
        document.documentElement.getAttribute("data-cms-url") ||
        "http://localhost:1337";

      await fetch(`${cmsUrl}/api/track-conversion-event`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          affiliateCode: affiliateCode,
          eventType: "page_view",
          eventData: {
            page: page,
            referrer: document.referrer,
            timestamp: new Date().toISOString(),
          },
        }),
      });

      console.log(
        `[PageView] Tracked page view for affiliate: ${affiliateCode} on ${page}`,
      );
    } catch (error) {
      console.warn("Failed to track page view:", error);
    }
  }

  // Track conversion events throughout the funnel
  async function trackConversionEvent(
    affiliateCode: string,
    eventType: string,
    eventData: any,
  ) {
    try {
      const cmsUrl =
        document.documentElement.getAttribute("data-cms-url") ||
        "http://localhost:1337";

      await fetch(`${cmsUrl}/api/track-conversion-event`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          affiliateCode: affiliateCode,
          eventType: eventType,
          eventData: eventData,
        }),
      });

      console.log(
        `[Conversion] Tracked conversion event: ${eventType} for affiliate: ${affiliateCode}`,
      );
    } catch (error) {
      console.warn("Failed to track conversion event:", error);
    }
  }

  // Make functions available globally
  (window as any).trackAffiliateVisit = trackAffiliateVisit;
  (window as any).trackPageView = trackPageView;
  (window as any).trackConversionEvent = trackConversionEvent;
</script>
