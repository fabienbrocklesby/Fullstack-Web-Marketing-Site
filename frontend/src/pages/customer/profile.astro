---
/**
 * Account Page (Profile) - Stage 6A Redesign
 *
 * Profile editing, password change, billing access.
 * URL remains /customer/profile for compatibility.
 */
import PortalLayout from "../../layouts/PortalLayout.astro";
---

<PortalLayout title="Account - Lightlane" activeTab="account">
  <h1 class="text-2xl font-bold mb-6 text-ll-gradient">Account Settings</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Profile Information -->
    <section class="surface rounded-xl p-5">
      <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <svg
          class="w-5 h-5 text-primary"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
          ></path>
        </svg>
        Profile Information
      </h2>

      <form id="profile-form" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label"
              ><span class="label-text">First Name</span></label
            >
            <input
              type="text"
              id="profile-first-name"
              class="input input-bordered w-full"
              placeholder="First name"
            />
          </div>
          <div class="form-control">
            <label class="label"
              ><span class="label-text">Last Name</span></label
            >
            <input
              type="text"
              id="profile-last-name"
              class="input input-bordered w-full"
              placeholder="Last name"
            />
          </div>
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text">Email</span></label>
          <input
            type="email"
            id="profile-email"
            class="input input-bordered w-full"
            placeholder="you@example.com"
          />
        </div>

        <div id="profile-message" class="alert hidden text-sm">
          <span id="profile-message-text"></span>
        </div>

        <button type="submit" class="btn btn-primary">
          <span id="profile-btn-text">Save Changes</span>
          <span
            id="profile-btn-loading"
            class="loading loading-spinner loading-sm hidden"></span>
        </button>
      </form>
    </section>

    <!-- Change Password -->
    <section class="surface rounded-xl p-5">
      <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <svg
          class="w-5 h-5 text-primary"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"
          ></path>
        </svg>
        Change Password
      </h2>

      <form id="password-form" class="space-y-4">
        <div class="form-control">
          <label class="label"
            ><span class="label-text">Current Password</span></label
          >
          <input
            type="password"
            id="password-current"
            class="input input-bordered w-full"
            placeholder="Current password"
            required
          />
        </div>

        <div class="form-control">
          <label class="label"
            ><span class="label-text">New Password</span></label
          >
          <input
            type="password"
            id="password-new"
            class="input input-bordered w-full"
            placeholder="New password (min 8 chars)"
            required
            minlength="8"
          />
        </div>

        <div class="form-control">
          <label class="label"
            ><span class="label-text">Confirm New Password</span></label
          >
          <input
            type="password"
            id="password-confirm"
            class="input input-bordered w-full"
            placeholder="Confirm new password"
            required
          />
        </div>

        <div id="password-message" class="alert hidden text-sm">
          <span id="password-message-text"></span>
        </div>

        <button type="submit" class="btn btn-primary">
          <span id="password-btn-text">Change Password</span>
          <span
            id="password-btn-loading"
            class="loading loading-spinner loading-sm hidden"></span>
        </button>
      </form>
    </section>
  </div>

  <!-- Billing & Subscription -->
  <section class="surface rounded-xl p-5 mt-6">
    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
      <svg
        class="w-5 h-5 text-primary"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
        ></path>
      </svg>
      Billing & Subscription
    </h2>

    <p class="text-base-content/60 text-sm mb-4">
      Manage your subscription, update payment methods, and view invoices in the
      Stripe billing portal.
    </p>

    <button id="billing-btn" class="btn btn-outline">
      <svg
        class="w-4 h-4 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
        ></path>
      </svg>
      <span id="billing-btn-text">Open Billing Portal</span>
      <span
        id="billing-btn-loading"
        class="loading loading-spinner loading-sm hidden"></span>
    </button>
  </section>

  <!-- Account Stats -->
  <section class="surface rounded-xl p-5 mt-6">
    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
      <svg
        class="w-5 h-5 text-primary"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
        ></path>
      </svg>
      Account Summary
    </h2>

    <div class="stats stats-vertical sm:stats-horizontal bg-base-200 w-full">
      <div class="stat">
        <div class="stat-title">Member Since</div>
        <div class="stat-value text-lg" id="stat-member-since">—</div>
      </div>
      <div class="stat">
        <div class="stat-title">Active Plans</div>
        <div class="stat-value text-lg text-primary" id="stat-plans">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Devices</div>
        <div class="stat-value text-lg text-secondary" id="stat-devices">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Status</div>
        <div class="stat-value text-lg text-success" id="stat-status">
          Active
        </div>
      </div>
    </div>
  </section>

  <!-- Danger Zone -->
  <section class="surface rounded-xl p-5 mt-6 border border-error/30">
    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-error">
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
        ></path>
      </svg>
      Danger Zone
    </h2>

    <p class="text-base-content/60 text-sm mb-4">
      Need to cancel your subscription or close your account? Please contact
      support.
    </p>

    <a
      href="/contact?subject=Account%20Support"
      class="btn btn-outline btn-error btn-sm"
    >
      Contact Support
    </a>
  </section>
</PortalLayout>

<script>
  import { getAuthState, updateCustomer } from "../../lib/portal/auth";
  import { portalFetch, parseApiError } from "../../lib/portal/api";
  import type {
    CustomerResponse,
    EntitlementsResponse,
    DevicesResponse,
  } from "../../lib/portal/types";
  import { formatDate, isActiveEntitlement } from "../../lib/portal/types";

  // === Load Profile ===
  async function loadProfile() {
    try {
      const data = await portalFetch<CustomerResponse>("/api/customers/me");
      const c = data.customer;

      (
        document.getElementById("profile-first-name") as HTMLInputElement
      ).value = c.firstName || "";
      (document.getElementById("profile-last-name") as HTMLInputElement).value =
        c.lastName || "";
      (document.getElementById("profile-email") as HTMLInputElement).value =
        c.email || "";

      // Update stats
      document.getElementById("stat-member-since")!.textContent =
        formatDate(c.createdAt) || "—";
      document.getElementById("stat-status")!.textContent = c.isActive
        ? "Active"
        : "Inactive";
      document.getElementById("stat-status")!.className = c.isActive
        ? "stat-value text-lg text-success"
        : "stat-value text-lg text-error";

      // Update localStorage
      updateCustomer(c);
    } catch (err) {
      console.error("Failed to load profile:", err);
    }
  }

  // === Load Stats ===
  async function loadStats() {
    try {
      const [entsData, devsData] = await Promise.all([
        portalFetch<EntitlementsResponse>("/api/customers/me/entitlements"),
        portalFetch<DevicesResponse>("/api/customers/me/devices"),
      ]);

      const activePlans = (entsData.entitlements || []).filter(
        isActiveEntitlement,
      ).length;
      document.getElementById("stat-plans")!.textContent = String(activePlans);
      document.getElementById("stat-devices")!.textContent = String(
        devsData.devices?.length || 0,
      );
    } catch (err) {
      console.error("Failed to load stats:", err);
    }
  }

  // === Profile Form ===
  const profileForm = document.getElementById(
    "profile-form",
  ) as HTMLFormElement;

  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const firstName = (
      document.getElementById("profile-first-name") as HTMLInputElement
    ).value.trim();
    const lastName = (
      document.getElementById("profile-last-name") as HTMLInputElement
    ).value.trim();
    const email = (
      document.getElementById("profile-email") as HTMLInputElement
    ).value.trim();

    const btnText = document.getElementById("profile-btn-text")!;
    const btnLoad = document.getElementById("profile-btn-loading")!;
    const msgEl = document.getElementById("profile-message")!;
    const msgText = document.getElementById("profile-message-text")!;

    msgEl.classList.add("hidden");
    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      const data = await portalFetch<CustomerResponse>(
        "/api/customers/profile",
        {
          method: "PUT",
          body: JSON.stringify({ firstName, lastName, email }),
        },
      );

      updateCustomer(data.customer);

      msgText.textContent = "Profile updated successfully!";
      msgEl.className = "alert alert-success text-sm";
      msgEl.classList.remove("hidden");

      setTimeout(() => msgEl.classList.add("hidden"), 5000);
    } catch (err) {
      msgText.textContent = parseApiError(err);
      msgEl.className = "alert alert-error text-sm";
      msgEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Password Form ===
  const passwordForm = document.getElementById(
    "password-form",
  ) as HTMLFormElement;

  passwordForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const currentPassword = (
      document.getElementById("password-current") as HTMLInputElement
    ).value;
    const newPassword = (
      document.getElementById("password-new") as HTMLInputElement
    ).value;
    const confirmPassword = (
      document.getElementById("password-confirm") as HTMLInputElement
    ).value;

    const btnText = document.getElementById("password-btn-text")!;
    const btnLoad = document.getElementById("password-btn-loading")!;
    const msgEl = document.getElementById("password-message")!;
    const msgText = document.getElementById("password-message-text")!;

    msgEl.classList.add("hidden");

    // Validation
    if (newPassword !== confirmPassword) {
      msgText.textContent = "New passwords do not match";
      msgEl.className = "alert alert-error text-sm";
      msgEl.classList.remove("hidden");
      return;
    }

    if (newPassword.length < 8) {
      msgText.textContent = "Password must be at least 8 characters";
      msgEl.className = "alert alert-error text-sm";
      msgEl.classList.remove("hidden");
      return;
    }

    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      await portalFetch("/api/customers/password", {
        method: "PUT",
        body: JSON.stringify({ currentPassword, newPassword }),
      });

      // Clear fields
      (document.getElementById("password-current") as HTMLInputElement).value =
        "";
      (document.getElementById("password-new") as HTMLInputElement).value = "";
      (document.getElementById("password-confirm") as HTMLInputElement).value =
        "";

      msgText.textContent = "Password changed successfully!";
      msgEl.className = "alert alert-success text-sm";
      msgEl.classList.remove("hidden");

      setTimeout(() => msgEl.classList.add("hidden"), 5000);
    } catch (err) {
      msgText.textContent = parseApiError(err);
      msgEl.className = "alert alert-error text-sm";
      msgEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Billing Portal ===
  const billingBtn = document.getElementById(
    "billing-btn",
  ) as HTMLButtonElement;

  billingBtn.addEventListener("click", async () => {
    const btnText = document.getElementById("billing-btn-text")!;
    const btnLoad = document.getElementById("billing-btn-loading")!;

    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      const data = await portalFetch<{ url: string }>(
        "/api/customers/billing-portal",
        {
          method: "POST",
          body: JSON.stringify({ returnUrl: window.location.href }),
        },
      );

      if (data.url) {
        window.location.href = data.url;
      }
    } catch (err) {
      alert("Failed to open billing portal. Please try again.");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Init ===
  loadProfile();
  loadStats();
</script>
