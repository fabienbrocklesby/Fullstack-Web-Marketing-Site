---
import Layout from "../../layouts/Layout.astro";
import DownloadButtons from "../../components/DownloadButtons.astro";
---

<Layout title="Customer Dashboard">
  <main class="min-h-screen bg-base-200">
    <div class="navbar bg-base-100 sticky top-0 z-40 shadow-sm">
      <div class="navbar-start">
        <div class="dropdown">
          <label tabindex="0" class="btn btn-ghost lg:hidden">
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h8m-8 6h16"></path>
            </svg>
          </label>
          <ul
            tabindex="0"
            class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 z-50 rounded-box w-52"
          >
            <li><a href="/customer/dashboard">Dashboard</a></li>
            <li><a href="/customer/profile">Profile</a></li>
          </ul>
        </div>
        <a href="/customer/dashboard" class="btn btn-ghost normal-case text-xl"
          >Lightlane Portal</a
        >
      </div>
      <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
          <li><a href="/customer/dashboard">Dashboard</a></li>
          <li><a href="/customer/profile">Profile</a></li>
        </ul>
      </div>
      <div class="navbar-end">
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="gap-2">
            <div
              class="md:hidden avatar avatar-placeholder hover:cursor-pointer"
            >
              <div class="bg-neutral text-neutral-content rounded-full w-10">
                <span id="nav-initials">CU</span>
              </div>
            </div>
            <span
              id="customer-name"
              class="hidden md:inline max-w-[140px] truncate hover:cursor-pointer"
              >Customer</span
            >
            <svg
              class="w-4 h-4 ml-1 hidden md:inline"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </label>
          <ul
            tabindex="0"
            class="menu menu-compact dropdown-content z-50 mt-3 p-2 shadow bg-base-100 rounded-box w-52"
          >
            <li class="md:hidden text-xs opacity-60">
              <span id="customer-name-mobile">Customer</span>
            </li>
            <li><a href="/customer/profile">Profile</a></li>
            <li><a id="logout-btn">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      <div role="alert" class="alert alert-info mb-6">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6 shrink-0"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path></svg
        >
        <div class="flex-1">
          <p class="font-semibold">Download the app</p>
          <p class="text-sm opacity-80">
            Free trial is built in - download and activate your trial inside the
            app.
          </p>
          <div class="mt-2">
            <DownloadButtons />
          </div>
        </div>
        <button
          class="btn btn-primary btn-sm"
          onclick="document.getElementById('open-purchase')?.click()"
          >Buy a License</button
        >
      </div>
      <!-- Hero Empty State (hidden until determined no licenses) -->
      <section id="purchase-hero" class="hidden mb-10">
        <div class="hero bg-base-100 rounded-2xl shadow-lg">
          <div class="hero-content flex-col lg:flex-row gap-10">
            <div class="max-w-xl">
              <h1 class="text-3xl font-bold mb-4">Get Your First License</h1>
              <p class="opacity-70 mb-6">
                Choose a plan and checkout securely. Your license key appears
                instantly and you can generate an offline activation code tied
                to your machine.
              </p>
              <div class="flex flex-col sm:flex-row gap-4 items-start">
                <select
                  id="hero-plan"
                  class="select select-bordered w-full max-w-xs"
                >
                  <option value="maker">Maker - $12/mo</option>
                  <option value="pro" selected>Pro - $24/mo</option>
                </select>
                <button id="hero-buy" class="btn btn-primary"
                  >Subscribe with Stripe</button
                >
              </div>
              <div class="mt-4 text-sm text-base-content/70">
                Enterprise or Education plans require a conversation first. <a
                  href="/contact?subject=Enterprise%20Enquiry#contact-form"
                  class="link link-primary">Contact us</a
                > for Enterprise, or <a
                  href="/contact?subject=Education%20Access%20Enquiry#contact-form"
                  class="link">Education</a
                >.
              </div>
              <p class="mt-3 text-xs opacity-60">
                One device per license â€¢ Instant key issuance â€¢ Offline
                activation supported
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- My Licenses Card -->
      <div class="card bg-base-100 shadow-xl mb-8" id="subscription-card">
        <div class="card-body">
          <h2 class="card-title">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"
              ></path>
            </svg>
            My Licenses
          </h2>

          <!-- Loading State -->
          <div id="subscription-loading" class="flex items-center gap-3 py-4">
            <span class="loading loading-spinner loading-md"></span>
            <span class="opacity-70">Loading licenses...</span>
          </div>

          <!-- Content (hidden until loaded) -->
          <div id="subscription-content" class="hidden">
            <!-- Will be populated by JavaScript -->
          </div>

          <!-- Error State (hidden by default) -->
          <div id="subscription-error" class="hidden">
            <div role="alert" class="alert alert-error">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="stroke-current shrink-0 h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <span id="subscription-error-text">Failed to load licenses</span>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Customer Info Card -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title">
              <div class="avatar placeholder">
                <div
                  class="bg-neutral-focus text-neutral-content rounded-full w-8 h-8 flex items-center justify-center"
                >
                  <span class="text-xs leading-none" id="customer-initials"
                    >CU</span
                  >
                </div>
              </div>
              Account Info
            </h2>
            <div class="space-y-2">
              <div>
                <span class="text-sm opacity-70">Name:</span>
                <span id="customer-full-name" class="ml-2">Loading...</span>
              </div>
              <div>
                <span class="text-sm opacity-70">Email:</span>
                <span id="customer-email" class="ml-2">Loading...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title">Quick Stats</h2>
            <div class="stats stats-vertical">
              <div class="stat">
                <div class="stat-title">Total Licenses</div>
                <div class="stat-value text-primary" id="total-licenses">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">Active Licenses</div>
                <div class="stat-value text-success" id="active-licenses">
                  0
                </div>
              </div>
              <div class="stat">
                <div class="stat-title">Available Licenses</div>
                <div class="stat-value text-info" id="available-licenses">
                  0
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title">Recent Activity</h2>
            <div id="recent-activity" class="space-y-2">
              <div class="text-sm opacity-70">Loading recent activity...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- License Keys Section -->
      <div class="card bg-base-100 shadow-xl mt-8">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="card-title">Your License Keys</h2>
            <button id="open-purchase" class="btn btn-primary btn-sm"
              >Buy with Stripe</button
            >
          </div>
          <div id="license-keys-container" aria-busy="true">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Skeleton license cards while loading -->
              <div class="card bg-base-100 border shadow-sm p-6 space-y-4">
                <div class="flex justify-between">
                  <div class="space-y-2">
                    <div class="skeleton h-5 w-40"></div>
                    <div class="skeleton h-4 w-24"></div>
                  </div>
                  <div class="skeleton h-6 w-20"></div>
                </div>
                <div class="skeleton h-10 w-full"></div>
                <div class="grid grid-cols-2 gap-4">
                  <div class="skeleton h-4 w-24"></div>
                  <div class="skeleton h-4 w-24"></div>
                </div>
                <div class="flex justify-end gap-2">
                  <div class="skeleton h-8 w-20"></div>
                  <div class="skeleton h-8 w-32"></div>
                </div>
              </div>
              <div
                class="card bg-base-100 border shadow-sm p-6 space-y-4 hidden md:block"
              >
                <div class="flex justify-between">
                  <div class="space-y-2">
                    <div class="skeleton h-5 w-40"></div>
                    <div class="skeleton h-4 w-24"></div>
                  </div>
                  <div class="skeleton h-6 w-20"></div>
                </div>
                <div class="skeleton h-10 w-full"></div>
                <div class="grid grid-cols-2 gap-4">
                  <div class="skeleton h-4 w-24"></div>
                  <div class="skeleton h-4 w-24"></div>
                </div>
                <div class="flex justify-end gap-2">
                  <div class="skeleton h-8 w-20"></div>
                  <div class="skeleton h-8 w-32"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <dialog id="purchase_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">Subscribe to License</h3>
      <form id="purchase-form" class="space-y-3">
        <label class="label">Plan</label>
        <select id="plan-select" class="select select-bordered w-full">
          <option value="maker">Maker ($12/mo)</option>
          <option value="pro" selected>Pro ($24/mo)</option>
        </select>
        <button class="btn btn-primary w-full">Subscribe</button>
        <p id="purchase-error" class="text-error text-sm hidden"></p>
      </form>
      <div class="text-xs text-base-content/70 mt-3">
        For Enterprise or Education plans, please <a
          href="/contact?subject=Enterprise%20Enquiry#contact-form"
          class="link link-primary">contact us</a
        > to discuss.
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Generate Activation Code Modal -->
  <dialog id="generate_activation_modal" class="modal">
    <div class="modal-box max-w-4xl">
      <h3 class="font-bold text-lg">Generate Activation Code</h3>

      <!-- Step 1: Get MAC Address -->
      <div id="mac-address-step">
        <div class="alert alert-info mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-current shrink-0 w-6 h-6"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path></svg
          >
          <span
            >For security, activation codes are bound to your specific machine.
            Please get your MAC address first.</span
          >
        </div>

        <div class="tabs tabs-boxed mb-4" id="mac-top-tabs">
          <a class="tab tab-active" onclick="showMacTopTab('via-app')"
            >Via App</a
          >
          <a class="tab" onclick="showMacTopTab('commands')">Commands</a>
        </div>

        <!-- Via App Pane (default) -->
        <div id="mac-via-app-pane" class="">
          <div class="card bg-base-200">
            <div class="card-body p-4">
              <h4 class="card-title mb-2">Find MAC address via the app</h4>
              <ul class="list list-disc ml-4 text-sm space-y-1">
                <li>
                  Open the application on the machine you want to activate.
                </li>
                <li>Open the activation options.</li>
                <li>The screen will show your device MAC address. Copy it.</li>
              </ul>
              <p class="text-xs opacity-70 mt-2">
                Tip: You can also use the system commands under the Commands
                tab.
              </p>
            </div>
          </div>
        </div>

        <!-- Commands Pane (with nested OS tabs) -->
        <div id="mac-commands-pane" class="hidden">
          <div class="tabs tabs-sm tabs-boxed mb-3" id="mac-commands-tabs">
            <a class="tab tab-active" onclick="showMacInstructions('windows')"
              >Windows</a
            >
            <a class="tab" onclick="showMacInstructions('macos')">macOS</a>
            <a class="tab" onclick="showMacInstructions('linux')">Linux</a>
          </div>

          <div id="mac-instructions">
            <!-- Windows Instructions -->
            <div id="windows-instructions" class="mac-instruction">
              <h4 class="font-semibold mb-2">Windows Command:</h4>
              <div class="mockup-code mb-2">
                <pre
                  data-prefix="$"><code>getmac /fo csv | findstr /V "Transport Name" | head -n 1</code></pre>
              </div>
              <p class="text-sm mb-2">Or use this simpler command:</p>
              <div class="mockup-code mb-2">
                <pre data-prefix="$"><code>getmac</code></pre>
              </div>
              <button
                class="btn btn-outline btn-sm"
                onclick="copyCommand('getmac')">Copy Command</button
              >
            </div>

            <!-- macOS Instructions -->
            <div id="macos-instructions" class="mac-instruction hidden">
              <h4 class="font-semibold mb-2">macOS Command:</h4>
              <div class="mockup-code mb-2">
                <pre
                  data-prefix="$"><code>ifconfig en0 | grep ether | awk '&#123;print $2&#125;'</code></pre>
              </div>
              <p class="text-sm mb-2">
                Alternative command (if en0 doesn't work):
              </p>
              <div class="mockup-code mb-2">
                <pre
                  data-prefix="$"><code>networksetup -getmacaddress Wi-Fi | awk '&#123;print $3&#125;'</code></pre>
              </div>
              <button
                class="btn btn-outline btn-sm"
                onclick="copyCommand('ifconfig en0 | grep ether | awk \'{print $2}\'')"
                >Copy Command</button
              >
            </div>

            <!-- Linux Instructions -->
            <div id="linux-instructions" class="mac-instruction hidden">
              <h4 class="font-semibold mb-2">Linux Command:</h4>
              <div class="mockup-code mb-2">
                <pre
                  data-prefix="$"><code>ip link show | grep -A1 -E "^[0-9]+: (eth|wlan|enp)" | grep link/ether | head -n 1 | awk '&#123;print $2&#125;'</code></pre>
              </div>
              <p class="text-sm mb-2">Alternative command:</p>
              <div class="mockup-code mb-2">
                <pre
                  data-prefix="$"><code>cat /sys/class/net/*/address | head -n 1</code></pre>
              </div>
              <button
                class="btn btn-outline btn-sm"
                onclick="copyCommand('ip link show | grep -A1 -E &quot;^[0-9]+: (eth|wlan|enp)&quot; | grep link/ether | head -n 1 | awk \'{print $2}\'')"
                >Copy Command</button
              >
            </div>
          </div>
        </div>

        <div class="form-control mt-4">
          <label class="label">
            <span class="label-text">Enter Your MAC Address:</span>
          </label>
          <input
            type="text"
            id="macAddressInput"
            placeholder="XX:XX:XX:XX:XX:XX"
            class="input input-bordered w-full"
            pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
          />
          <div class="label">
            <span class="label-text-alt"
              >Format: XX:XX:XX:XX:XX:XX (letters can be upper or lowercase)</span
            >
          </div>
        </div>

        <div class="modal-action">
          <button class="btn btn-primary" onclick="proceedToActivation()"
            >Generate Activation Code</button
          >
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </div>

      <!-- Step 2: Activation Code Display -->
      <div id="activation-code-step" class="hidden">
        <div class="alert alert-success mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-current shrink-0 w-6 h-6"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg
          >
          <span
            >Activation code generated! This code will only work on the machine
            with the MAC address you provided.</span
          >
        </div>

        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text font-semibold">Your License Key:</span>
          </label>
          <div class="join w-full">
            <input
              type="text"
              id="licenseKeyDisplay"
              class="input input-bordered join-item flex-1"
              readonly
            />
            <button
              class="btn btn-ghost join-item"
              onclick="copyFromDisplay('licenseKeyDisplay')">Copy</button
            >
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Your Activation Code:</span>
          </label>
          <div class="join w-full">
            <input
              type="text"
              id="activationCodeDisplay"
              class="input input-bordered join-item flex-1"
              readonly
            />
            <button
              class="btn btn-primary join-item"
              onclick="copyActivationCode()">Copy</button
            >
          </div>
        </div>

        <div class="form-control mt-4">
          <label class="label">
            <span class="label-text">Bound to MAC Address:</span>
          </label>
          <input
            type="text"
            id="boundMacDisplay"
            class="input input-bordered"
            readonly
          />
        </div>

        <div class="alert alert-warning mt-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-current shrink-0 w-6 h-6"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"
            ></path></svg
          >
          <div>
            <p class="font-semibold">Important Security Notice:</p>
            <ul class="list-disc list-inside text-sm mt-2">
              <li>
                This activation code will ONLY work on the machine with MAC
                address: <span id="securityMacDisplay" class="font-mono"></span>
              </li>
              <li>The code cannot be transferred to other machines</li>
              <li>This prevents unauthorized license sharing</li>
            </ul>
          </div>
        </div>

        <div class="modal-action">
          <form method="dialog"><button class="btn">Done</button></form>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Deactivation Modal -->
  <dialog id="deactivation_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Offline Deactivation</h3>
      <p class="py-4">
        Paste the deactivation code from your application below to deactivate
        this license.
      </p>
      <div class="form-control">
        <textarea
          id="deactivation_code_textarea"
          class="textarea textarea-bordered h-32"
          placeholder="Paste deactivation code here..."></textarea>
      </div>
      <div class="text-center mt-2 hidden" id="deactivation-loading">
        <span class="loading loading-spinner"></span>
      </div>
      <div class="modal-action">
        <button class="btn btn-primary" onclick="submitDeactivation()"
          >Submit Deactivation</button
        >
        <form method="dialog">
          <button class="btn">Close</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>
</Layout>

<script>
  // Check if customer is logged in
  const customerToken = localStorage.getItem("customerToken");
  const customer = JSON.parse(localStorage.getItem("customer") || "{}");

  if (!customerToken || !customer.id) {
    window.location.href = "/customer/login";
  } else {
    // Customer info will be loaded from API, not localStorage

    // Logout functionality
    document.getElementById("logout-btn")?.addEventListener("click", () => {
      localStorage.removeItem("customerToken");
      localStorage.removeItem("customer");
      window.location.href = "/customer/login";
    });

    // Load licenses/entitlements info (plural)
    async function loadSubscriptionInfo() {
      const loadingEl = document.getElementById("subscription-loading");
      const contentEl = document.getElementById("subscription-content");
      const errorEl = document.getElementById("subscription-error");
      const errorTextEl = document.getElementById("subscription-error-text");

      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";

        const response = await fetch(
          `${cmsUrl}/api/customers/me/entitlements`,
          {
            headers: {
              Authorization: `Bearer ${customerToken}`,
            },
          },
        );

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem("customerToken");
            localStorage.removeItem("customer");
            window.location.href = "/customer/login";
            return;
          }
          // Include HTTP status in error for easier debugging
          const errorBody = await response.text().catch(() => "");
          throw new Error(
            `HTTP ${response.status}: ${errorBody || response.statusText}`,
          );
        }

        const data = await response.json();

        // Hide loading, show content
        if (loadingEl) loadingEl.classList.add("hidden");
        if (contentEl) contentEl.classList.remove("hidden");

        renderEntitlementsList(data, contentEl);
      } catch (error) {
        console.error("Error loading licenses:", error);
        if (loadingEl) loadingEl.classList.add("hidden");
        if (errorEl) errorEl.classList.remove("hidden");
        if (errorTextEl)
          errorTextEl.textContent =
            error instanceof Error ? error.message : "Failed to load licenses";
      }
    }

    // Render multiple entitlements as a list
    function renderEntitlementsList(data: any, container: HTMLElement | null) {
      if (!container) return;

      const entitlements = data.entitlements || [];

      // No entitlements
      if (entitlements.length === 0) {
        container.innerHTML = `
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div>
              <p class="text-lg">No licenses yet</p>
              <p class="text-sm opacity-70">Purchase a license to get started</p>
            </div>
            <button class="btn btn-primary" onclick="document.getElementById('open-purchase')?.click()">
              Buy a License
            </button>
          </div>
        `;
        return;
      }

      // Render each entitlement as a row/card
      const entitlementCards = entitlements
        .map((ent: any, index: number) => {
          const {
            tier,
            status,
            isLifetime,
            expiresAt,
            currentPeriodEnd,
            cancelAtPeriodEnd,
            maxDevices,
            licenseKey,
          } = ent;

          // Format tier display
          const tierDisplay = tier
            ? tier.charAt(0).toUpperCase() + tier.slice(1)
            : "License";

          // Determine badge style based on status
          let statusBadge = "";
          let statusMessage = "";
          let showBillingButton = false;

          if (isLifetime) {
            statusBadge = `<span class="badge badge-accent">Lifetime</span>`;
            statusMessage = "No renewal needed";
            showBillingButton = false;
          } else if (status === "active") {
            statusBadge = `<span class="badge badge-success">Active</span>`;
            // Use currentPeriodEnd for subscriptions, fall back to expiresAt
            const renewDateSource = currentPeriodEnd || expiresAt;
            const renewDate = renewDateSource
              ? new Date(renewDateSource).toLocaleDateString()
              : null;
            if (cancelAtPeriodEnd && renewDate) {
              statusMessage = `Cancels ${renewDate}`;
            } else if (renewDate) {
              statusMessage = `Renews ${renewDate}`;
            } else {
              statusMessage = "Active subscription";
            }
            showBillingButton = true;
          } else if (status === "past_due") {
            statusBadge = `<span class="badge badge-error">Past Due</span>`;
            statusMessage = "Payment required";
            showBillingButton = true;
          } else if (status === "canceled" || status === "expired") {
            statusBadge = `<span class="badge badge-error">${status === "canceled" ? "Canceled" : "Expired"}</span>`;
            statusMessage = "Subscription ended";
            showBillingButton = true;
          } else if (status === "inactive") {
            statusBadge = `<span class="badge badge-neutral">Inactive</span>`;
            statusMessage = "Currently inactive";
            showBillingButton = true;
          } else {
            statusBadge = `<span class="badge badge-neutral">${status || "Unknown"}</span>`;
            statusMessage = "";
            showBillingButton = true;
          }

          // For Maker/Pro: show "One device per license" instead of count
          // For other tiers (education, enterprise): show actual device count
          const lowerTier = tier?.toLowerCase();
          const devicesInfo =
            lowerTier === "maker" || lowerTier === "pro"
              ? `<span class="text-xs opacity-60">One device per license</span>`
              : maxDevices
                ? `<span class="text-xs opacity-60">${maxDevices} device${maxDevices > 1 ? "s" : ""}</span>`
                : "";
          const licenseKeyInfo = licenseKey?.key
            ? `<span class="font-mono text-xs opacity-50">${licenseKey.key.substring(0, 8)}...</span>`
            : "";

          return `
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-4 bg-base-200 rounded-lg ${index > 0 ? "mt-3" : ""}">
            <div class="flex-1">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-semibold">${tierDisplay}</span>
                ${statusBadge}
                ${devicesInfo}
              </div>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-sm opacity-70">${statusMessage}</span>
                ${licenseKeyInfo}
              </div>
            </div>
            ${
              showBillingButton && index === 0
                ? `
              <button class="btn btn-outline btn-sm" id="manage-billing-btn" onclick="openBillingPortal()">
                Manage Billing
              </button>
            `
                : ""
            }
          </div>
        `;
        })
        .join("");

      // Add billing error placeholder and summary
      const hasAnySubscription = entitlements.some(
        (e: any) => !e.isLifetime && e.status === "active",
      );

      container.innerHTML = `
        <div class="space-y-2">
          ${entitlementCards}
          <p id="billing-error" class="text-error text-sm hidden mt-2"></p>
          ${
            hasAnySubscription
              ? ""
              : `
            <div class="mt-4 pt-4 border-t border-base-300">
              <button class="btn btn-primary btn-sm" onclick="document.getElementById('open-purchase')?.click()">
                Add Another License
              </button>
            </div>
          `
          }
        </div>
      `;
    }

    // Global function to open billing portal
    (window as any).openBillingPortal = async function () {
      const btn = document.getElementById(
        "manage-billing-btn",
      ) as HTMLButtonElement;
      const errorEl = document.getElementById("billing-error");

      if (btn) {
        btn.disabled = true;
        btn.innerHTML = `<span class="loading loading-spinner loading-sm"></span> Opening...`;
      }
      if (errorEl) errorEl.classList.add("hidden");

      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";

        const response = await fetch(`${cmsUrl}/api/customers/billing-portal`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${customerToken}`,
          },
          body: JSON.stringify({
            returnUrl: window.location.href,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(
            data.message || data.error || "Failed to open billing portal",
          );
        }

        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error("No billing portal URL returned");
        }
      } catch (error) {
        console.error("Billing portal error:", error);
        if (errorEl) {
          errorEl.textContent =
            error instanceof Error
              ? error.message
              : "Failed to open billing portal";
          errorEl.classList.remove("hidden");
        }
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Manage Billing
          `;
        }
      }
    };

    // Load subscription info on page load
    loadSubscriptionInfo();

    // Load dashboard data
    async function loadDashboardData() {
      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";

        // Get customer profile
        const profileResponse = await fetch(`${cmsUrl}/api/customers/me`, {
          headers: {
            Authorization: `Bearer ${customerToken}`,
          },
        });

        if (!profileResponse.ok) {
          if (profileResponse.status === 401) {
            localStorage.removeItem("customerToken");
            localStorage.removeItem("customer");
            window.location.href = "/customer/login";
            return;
          }
          throw new Error("Failed to fetch profile");
        }

        const profileData = await profileResponse.json();
        const customerData = profileData.customer;

        // Update customer info in UI
        updateCustomerInfo(customerData);

        // Get license keys
        const licenseResponse = await fetch(`${cmsUrl}/api/license-keys`, {
          headers: {
            Authorization: `Bearer ${customerToken}`,
          },
        });

        if (!licenseResponse.ok) {
          throw new Error("Failed to fetch license keys");
        }

        const licenseData = await licenseResponse.json();
        console.debug("License keys API raw response", licenseData);
        // Support alternative shapes: { data: [...] } or direct array
        const keys = Array.isArray(licenseData)
          ? licenseData
          : Array.isArray(licenseData.licenseKeys)
            ? licenseData.licenseKeys
            : Array.isArray(licenseData.data)
              ? licenseData.data
              : [];
        let finalKeys = keys;
        if (
          (!Array.isArray(finalKeys) || finalKeys.length === 0) &&
          Array.isArray(customerData.licenseKeys) &&
          customerData.licenseKeys.length
        ) {
          console.warn("Using licenseKeys from profile fallback");
          finalKeys = customerData.licenseKeys.map((k) => ({
            ...k,
            isUsed: k.status === "active" || k.isUsed,
          }));
        }
        if (
          (!finalKeys || finalKeys.length === 0) &&
          customerData?.purchases?.length
        ) {
          console.warn(
            "No license keys returned but purchases exist",
            customerData.purchases,
          );
        }
        displayLicenseKeys(finalKeys || []);
        updateStats(finalKeys || []);
        updateRecentActivity(customerData.purchases, finalKeys || []);
      } catch (error) {
        console.error("Error loading dashboard data:", error);
        const container = document.getElementById("license-keys-container");
        if (container) {
          container.innerHTML = `
          <div class="alert alert-error">
            <span>Error loading data: ${error.message}</span>
          </div>
        `;
        }
      }
    }

    function updateCustomerInfo(customerData) {
      const customerNameElement = document.getElementById("customer-name");
      const customerNameMobileElement = document.getElementById(
        "customer-name-mobile",
      );
      const customerInitialsElement =
        document.getElementById("customer-initials");
      const navInitialsElement = document.getElementById("nav-initials");
      const customerFullNameElement =
        document.getElementById("customer-full-name");
      const customerEmailElement = document.getElementById("customer-email");

      const fullName =
        `${customerData.firstName || ""} ${customerData.lastName || ""}`.trim() ||
        "Customer";
      if (customerNameElement) customerNameElement.textContent = fullName;
      if (customerNameMobileElement)
        customerNameMobileElement.textContent = fullName;

      const initials =
        `${customerData.firstName?.[0] || ""}${customerData.lastName?.[0] || ""}` ||
        "CU";
      if (customerInitialsElement)
        customerInitialsElement.textContent = initials || "CU";
      if (navInitialsElement) navInitialsElement.textContent = initials || "CU";

      if (customerFullNameElement) {
        customerFullNameElement.textContent =
          `${customerData.firstName || ""} ${customerData.lastName || ""}`.trim() ||
          "Customer";
      }

      if (customerEmailElement) {
        customerEmailElement.textContent = customerData.email || "No email";
      }

      // Update localStorage with fresh data
      localStorage.setItem("customer", JSON.stringify(customerData));
    }

    const purchaseBtn = document.getElementById(
      "open-purchase",
    ) as HTMLButtonElement | null;
    const purchaseModal = document.getElementById(
      "purchase_modal",
    ) as HTMLDialogElement | null;
    const purchaseForm = document.getElementById(
      "purchase-form",
    ) as HTMLFormElement | null;
    const planSelect = document.getElementById(
      "plan-select",
    ) as HTMLSelectElement | null;
    const purchaseError = document.getElementById(
      "purchase-error",
    ) as HTMLElement | null;
    const heroPlan = document.getElementById(
      "hero-plan",
    ) as HTMLSelectElement | null;
    const heroBuy = document.getElementById(
      "hero-buy",
    ) as HTMLButtonElement | null;
    purchaseBtn?.addEventListener("click", () => purchaseModal?.showModal());
    purchaseForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      purchaseError?.classList.add("hidden");
      const tier = planSelect?.value;
      const cmsUrl =
        document.documentElement.getAttribute("data-cms-url") ||
        "http://localhost:1337";
      if (!tier) {
        if (purchaseError) {
          purchaseError.textContent = "Please select a plan";
          purchaseError.classList.remove("hidden");
        }
        return;
      }
      try {
        const res = await fetch(
          `${cmsUrl}/api/customer-checkout-subscription`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${customerToken}`,
            },
            body: JSON.stringify({
              tier,
              successPath: "/customer/success",
              cancelPath: "/customer/dashboard",
            }),
          },
        );
        const out = await res.json();
        if (!res.ok) {
          // Display the most informative error message available
          const errorMessage =
            out?.message || out?.error || res.statusText || "Checkout failed";
          throw new Error(errorMessage);
        }
        if (out.url) {
          window.location.href = out.url;
        } else {
          throw new Error("No checkout URL returned");
        }
      } catch (err) {
        console.error("Checkout initiation failed:", err);
        if (purchaseError) {
          purchaseError.textContent =
            err instanceof Error ? err.message : "Failed to initiate checkout";
          purchaseError.classList.remove("hidden");
        }
      }
    });
    heroBuy?.addEventListener("click", () => {
      if (heroPlan && planSelect) {
        planSelect.value = heroPlan.value;
        purchaseModal?.showModal();
      } else {
        purchaseModal?.showModal();
      }
    });

    function showHero() {
      const hero = document.getElementById("purchase-hero");
      if (hero) hero.classList.remove("hidden");
      // Hide the license card wrapper (license-keys-container parent card remains for layout, could hide if needed)
    }

    function displayLicenseKeys(licenseKeys) {
      // Store license keys for global access
      currentLicenseKeys = licenseKeys;

      const container = document.getElementById("license-keys-container");
      if (!container) return;
      // Defensive: if API shape changed or missing
      if (!Array.isArray(licenseKeys)) {
        console.warn("licenseKeys not an array", licenseKeys);
        container.innerHTML = `<div class="alert alert-error text-sm">Unable to load license keys. Please refresh.</div>`;
        container.removeAttribute("aria-busy");
        return;
      }

      if (licenseKeys.length === 0) {
        container.removeAttribute("aria-busy");
        showHero();
        container.innerHTML = `<div class="p-4 text-sm opacity-70">No license keys yet.</div>`;
        return;
      }
      // Hide hero if licenses exist
      document.getElementById("purchase-hero")?.classList.add("hidden");
      container.removeAttribute("aria-busy");

      const licenseCardsHTML = licenseKeys
        .map(
          (license) => `
      <div class="card bg-base-100 border shadow-sm">
        <div class="card-body">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="card-title text-lg">${license.productName}</h3>
              <p class="text-sm opacity-70">License Key</p>
            </div>
            <div class="badge ${license.isActive ? "badge-success" : "badge-error"}">
              ${license.isActive ? "Active" : "Inactive"}
            </div>
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text">License Key</span>
            </label>
            <div class="input-group">
              <input type="text" value="${license.key}" class="input input-bordered flex-1" readonly />
              <button class="btn btn-primary" onclick="copyToClipboard('${license.key}')">Copy</button>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
              <span class="text-sm opacity-70">Status:</span>
              <span class="ml-2 badge ${
                license.status === "active"
                  ? "badge-success"
                  : license.isUsed
                    ? "badge-warning"
                    : "badge-info"
              }">
                ${
                  license.status === "active"
                    ? "Active"
                    : license.isUsed
                      ? "Used"
                      : "Available"
                }
              </span>
            </div>
            <div>
              <span class="text-sm opacity-70">Type:</span>
              <span class="ml-2">${license.productName}</span>
            </div>
          </div>
          
          ${
            license.isUsed || license.status === "active"
              ? `
            <div class="mt-4">
              <span class="text-sm opacity-70">Activated:</span>
              <span class="ml-2">${new Date(license.activatedAt).toLocaleDateString()}</span>
            </div>
          `
              : ""
          }
          
          <div class="card-actions justify-end mt-4">
            <button class="btn btn-ghost btn-sm" onclick="copyToClipboard('${license.key}')">
              ðŸ“‹ Copy Key
            </button>
            ${
              license.isUsed || license.status === "active"
                ? `
                <button class="btn btn-warning btn-sm" onclick="openDeactivationModal('${license.id}')">
                  ðŸ”Œ Offline Deactivate
                </button>
                `
                : `
                <button class="btn btn-secondary btn-sm" onclick="openGenerateActivationModal('${license.id}')">
                  âš¡ Offline Activate
                </button>
                `
            }
          </div>
        </div>
      </div>
    `,
        )
        .join("");

      container.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        ${licenseCardsHTML}
      </div>
    `;
    }

    function updateStats(licenseKeys) {
      const totalLicenses = licenseKeys.length;
      const activeLicenses = licenseKeys.filter(
        (license) => license.isUsed,
      ).length;
      const availableLicenses = licenseKeys.filter(
        (license) => !license.isUsed && license.isActive,
      ).length;

      const totalElement = document.getElementById("total-licenses");
      const activeElement = document.getElementById("active-licenses");
      const availableElement = document.getElementById("available-licenses");

      if (totalElement) totalElement.textContent = totalLicenses;
      if (activeElement) activeElement.textContent = activeLicenses;
      if (availableElement) availableElement.textContent = availableLicenses;
    }

    let currentLicenseId = null;
    let currentLicenseKey = "";
    let currentLicenseKeys = []; // Store current license keys

    // Helper function to get current license keys
    function getCurrentLicenseKeys() {
      return currentLicenseKeys;
    }

    (window as any).openGenerateActivationModal = function (licenseId) {
      // First check if license is already active
      const licenseKeys = getCurrentLicenseKeys();
      const license = licenseKeys.find(
        (l: any) => l.id.toString() === licenseId.toString(),
      ) as any;

      if (license && (license.isUsed || license.status === "active")) {
        alert(
          "This license is already active. Please deactivate it first before generating a new activation code.",
        );
        return;
      }

      currentLicenseId = licenseId;
      currentLicenseKey = license?.key || "";
      const modal = document.getElementById(
        "generate_activation_modal",
      ) as HTMLDialogElement;

      // Reset modal to the MAC address step
      const macStep = document.getElementById("mac-address-step");
      const codeStep = document.getElementById("activation-code-step");
      if (macStep) macStep.classList.remove("hidden");
      if (codeStep) codeStep.classList.add("hidden");

      // Reset inputs
      const macInput = document.getElementById(
        "macAddressInput",
      ) as HTMLInputElement;
      const activationCodeDisplay = document.getElementById(
        "activationCodeDisplay",
      ) as HTMLInputElement;
      const licenseKeyDisplay = document.getElementById(
        "licenseKeyDisplay",
      ) as HTMLInputElement;
      const boundMacDisplay = document.getElementById(
        "boundMacDisplay",
      ) as HTMLInputElement;
      const securityMacDisplay = document.getElementById("securityMacDisplay");

      if (macInput) macInput.value = "";
      if (activationCodeDisplay) activationCodeDisplay.value = "";
      if (licenseKeyDisplay) licenseKeyDisplay.value = currentLicenseKey || "";
      if (boundMacDisplay) boundMacDisplay.value = "";
      if (securityMacDisplay) securityMacDisplay.textContent = "";

      // Reset tabs: default to Via App and Windows under Commands
      const viaPane = document.getElementById("mac-via-app-pane");
      const cmdPane = document.getElementById("mac-commands-pane");
      const topTabs = document.getElementById("mac-top-tabs");
      if (viaPane && cmdPane && topTabs) {
        viaPane.classList.remove("hidden");
        cmdPane.classList.add("hidden");
        const tabs = topTabs.querySelectorAll(".tab");
        tabs.forEach((el) => el.classList.remove("tab-active"));
        (tabs[0] as HTMLElement)?.classList.add("tab-active");
        (window as any).showMacInstructions("windows");
      }

      modal?.showModal();
    };

    // MAC Address Modal functions
    (window as any).showMacInstructions = function (os: string) {
      const pane = document.getElementById("mac-commands-pane");
      if (!pane) return;
      pane
        .querySelectorAll(".mac-instruction")
        .forEach((el) => el.classList.add("hidden"));
      const tabs = pane.querySelectorAll("#mac-commands-tabs .tab");
      tabs.forEach((el) => el.classList.remove("tab-active"));
      const selectedInstructions = document.getElementById(
        `${os}-instructions`,
      );
      if (selectedInstructions) selectedInstructions.classList.remove("hidden");
      const osIndex = os === "windows" ? 0 : os === "macos" ? 1 : 2;
      const tabEl = tabs[osIndex] as HTMLElement | undefined;
      if (tabEl) tabEl.classList.add("tab-active");
    };

    (window as any).showMacTopTab = function (which: string) {
      const viaPane = document.getElementById("mac-via-app-pane");
      const cmdPane = document.getElementById("mac-commands-pane");
      const topTabs = document.getElementById("mac-top-tabs");
      if (!viaPane || !cmdPane || !topTabs) return;
      const tabs = topTabs.querySelectorAll(".tab");
      tabs.forEach((el) => el.classList.remove("tab-active"));
      if (which === "via-app") {
        viaPane.classList.remove("hidden");
        cmdPane.classList.add("hidden");
        (tabs[0] as HTMLElement)?.classList.add("tab-active");
      } else {
        viaPane.classList.add("hidden");
        cmdPane.classList.remove("hidden");
        (tabs[1] as HTMLElement)?.classList.add("tab-active");
        (window as any).showMacInstructions("windows");
      }
    };

    (window as any).copyCommand = function (command: string) {
      navigator.clipboard
        .writeText(command)
        .then(() => {
          // Show brief success message
          const btn =
            (event?.target as HTMLButtonElement) ||
            (document.activeElement as HTMLButtonElement);
          if (btn && btn.tagName === "BUTTON") {
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.classList.add("btn-success");
            btn.classList.remove("btn-outline");
            setTimeout(() => {
              btn.textContent = originalText;
              btn.classList.remove("btn-success");
              btn.classList.add("btn-outline");
            }, 2000);
          }
        })
        .catch(() => {
          alert("Failed to copy command to clipboard");
        });
    };

    (window as any).proceedToActivation = function () {
      const macInput = document.getElementById(
        "macAddressInput",
      ) as HTMLInputElement;
      const macAddress = macInput.value.trim();

      // Validate MAC address format
      const macPattern = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
      if (!macPattern.test(macAddress)) {
        alert("Please enter a valid MAC address in format XX:XX:XX:XX:XX:XX");
        return;
      }

      // Hide step 1, show step 2
      const macStep = document.getElementById("mac-address-step");
      const codeStep = document.getElementById("activation-code-step");
      if (macStep) macStep.classList.add("hidden");
      if (codeStep) codeStep.classList.remove("hidden");

      // Store the MAC address and proceed with activation
      generateActivationCodeWithMac(macAddress);
    };

    (window as any).resetActivationModal = function () {
      // Reset to step 1
      const codeStep = document.getElementById("activation-code-step");
      const macStep = document.getElementById("mac-address-step");
      if (codeStep) codeStep.classList.add("hidden");
      if (macStep) macStep.classList.remove("hidden");

      // Clear inputs
      const macInput = document.getElementById(
        "macAddressInput",
      ) as HTMLInputElement;
      const activationCodeDisplay = document.getElementById(
        "activationCodeDisplay",
      ) as HTMLInputElement;
      const licenseKeyDisplay = document.getElementById(
        "licenseKeyDisplay",
      ) as HTMLInputElement;
      const boundMacDisplay = document.getElementById(
        "boundMacDisplay",
      ) as HTMLInputElement;
      const securityMacDisplay = document.getElementById("securityMacDisplay");

      if (macInput) macInput.value = "";
      if (activationCodeDisplay) activationCodeDisplay.value = "";
      if (licenseKeyDisplay) licenseKeyDisplay.value = "";
      if (boundMacDisplay) boundMacDisplay.value = "";
      if (securityMacDisplay) securityMacDisplay.textContent = "";

      // Reset tabs to default state
      const viaPane2 = document.getElementById("mac-via-app-pane");
      const cmdPane2 = document.getElementById("mac-commands-pane");
      const topTabs2 = document.getElementById("mac-top-tabs");
      if (viaPane2 && cmdPane2 && topTabs2) {
        viaPane2.classList.remove("hidden");
        cmdPane2.classList.add("hidden");
        const tabs = topTabs2.querySelectorAll(".tab");
        tabs.forEach((el) => el.classList.remove("tab-active"));
        (tabs[0] as HTMLElement)?.classList.add("tab-active");
        (window as any).showMacInstructions("windows");
      }
    };

    async function generateActivationCodeWithMac(macAddress: string) {
      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";
        const response = await fetch(
          `${cmsUrl}/api/license-keys/${currentLicenseId}/generate-activation-code`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${customerToken}`,
            },
            body: JSON.stringify({ machineId: macAddress }),
          },
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(
            error.error?.message || "Failed to generate activation code",
          );
        }

        const { activationCode } = await response.json();

        // Display the activation code and bound MAC
        const activationCodeDisplay = document.getElementById(
          "activationCodeDisplay",
        ) as HTMLInputElement;
        const licenseKeyDisplay = document.getElementById(
          "licenseKeyDisplay",
        ) as HTMLInputElement;
        const boundMacDisplay = document.getElementById(
          "boundMacDisplay",
        ) as HTMLInputElement;
        const securityMacDisplay =
          document.getElementById("securityMacDisplay");

        if (activationCodeDisplay) activationCodeDisplay.value = activationCode;
        if (licenseKeyDisplay)
          licenseKeyDisplay.value = currentLicenseKey || "";
        if (boundMacDisplay) boundMacDisplay.value = macAddress;
        if (securityMacDisplay) securityMacDisplay.textContent = macAddress;

        loadDashboardData(); // Refresh data to show license is now "Active"
      } catch (error) {
        alert(`Error: ${(error as Error).message}`);
        const resetFunc = (window as any).resetActivationModal;
        if (resetFunc) resetFunc();
      }
    }

    (window as any).confirmActivation = async function () {
      // This function is deprecated - keeping for compatibility
      alert("Please use the new MAC address-based activation system.");
    };

    (window as any).copyActivationCode = function () {
      const activationCodeDisplay = document.getElementById(
        "activationCodeDisplay",
      ) as HTMLInputElement;

      if (activationCodeDisplay && activationCodeDisplay.value) {
        navigator.clipboard.writeText(activationCodeDisplay.value).then(() => {
          // Show brief success message
          const btn = event?.target as HTMLButtonElement;
          if (btn) {
            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.classList.add("btn-success");
            setTimeout(() => {
              btn.textContent = originalText;
              btn.classList.remove("btn-success");
            }, 2000);
          }
        });
      } else {
        // Fallback for old textarea (legacy support)
        const textarea = document.getElementById(
          "activation_code_textarea",
        ) as HTMLTextAreaElement;
        if (textarea) {
          navigator.clipboard.writeText(textarea.value).then(() => {
            alert("Activation code copied to clipboard!");
          });
        }
      }
    };

    (window as any).copyFromDisplay = function (elementId) {
      const input = document.getElementById(elementId) as HTMLInputElement;
      navigator.clipboard.writeText(input.value).then(() => {
        alert("Copied to clipboard!");
      });
    };

    (window as any).openDeactivationModal = function (licenseId) {
      currentLicenseId = licenseId;
      const modal = document.getElementById(
        "deactivation_modal",
      ) as HTMLDialogElement;
      const textarea = document.getElementById(
        "deactivation_code_textarea",
      ) as HTMLTextAreaElement;
      textarea.value = "";
      modal?.showModal();
    };

    (window as any).submitDeactivation = async function () {
      const modal = document.getElementById(
        "deactivation_modal",
      ) as HTMLDialogElement;
      const textarea = document.getElementById(
        "deactivation_code_textarea",
      ) as HTMLTextAreaElement;
      const loading = document.getElementById("deactivation-loading");
      const deactivationCode = textarea.value;

      if (!deactivationCode) {
        alert("Please paste the deactivation code.");
        return;
      }

      if (loading) loading.classList.remove("hidden");

      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";
        const response = await fetch(
          `${cmsUrl}/api/license-keys/${currentLicenseId}/deactivate-with-code`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${customerToken}`,
            },
            body: JSON.stringify({ deactivationCode }),
          },
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(
            error.error?.message || "Failed to deactivate license",
          );
        }

        alert("License deactivated successfully!");
        modal?.close();
        loadDashboardData(); // Refresh data
      } catch (error) {
        alert(`Error: ${(error as Error).message}`);
      } finally {
        if (loading) loading.classList.add("hidden");
      }
    };

    function updateRecentActivity(purchases, licenseKeys) {
      const container = document.getElementById("recent-activity");
      if (!container) return;

      // Combine purchases and license activations into a single activity feed
      const activities = [
        // Sample object to help TypeScript infer the type
        ...(purchases && purchases.length > 0
          ? purchases.map((purchase) => ({
              type: "purchase",
              date: new Date(purchase.createdAt),
              text: `Purchased ${purchase.metadata?.product || "product"}`,
              amount: `$${purchase.amount}`,
              icon: "ðŸ’³",
            }))
          : []),
        ...(licenseKeys && licenseKeys.length > 0
          ? licenseKeys
              .filter((license) => license.isUsed && license.activatedAt)
              .map((license) => ({
                type: "activation",
                date: new Date(license.activatedAt),
                text: `Activated ${license.productName} license`,
                icon: "ðŸ”‘",
              }))
          : []),
      ];

      // Sort activities by date (most recent first)
      activities.sort((a, b) => b.date.getTime() - a.date.getTime());

      // Take only the 5 most recent activities
      const recentActivities = activities.slice(0, 5);

      if (recentActivities.length === 0) {
        container.innerHTML = `
        <div class="text-center py-4">
          <div class="text-4xl mb-2">ðŸ“‹</div>
          <p class="text-sm opacity-70">No recent activity</p>
        </div>
      `;
        return;
      }

      let activitiesHTML = "";
      for (const activity of recentActivities) {
        const dateStr = new Date(activity.date).toLocaleDateString();
        const timeStr = new Date(activity.date).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const amountStr = activity.amount
          ? `<div class="text-sm font-semibold text-primary">${activity.amount}</div>`
          : "";

        activitiesHTML += `
        <div class="flex items-center space-x-3 py-2">
          <div class="text-lg">${activity.icon}</div>
          <div class="flex-1">
            <p class="text-sm font-medium">${activity.text}</p>
            <p class="text-xs opacity-70">${dateStr} ${timeStr}</p>
          </div>
          ${amountStr}
        </div>
      `;
      }

      container.innerHTML = activitiesHTML;
    }

    // Global functions for license management
    (window as any).copyToClipboard = function (text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("License key copied to clipboard!");
      });
    };

    (window as any).activateLicense = async function (licenseId) {
      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";
        const response = await fetch(
          `${cmsUrl}/api/license-keys/${licenseId}/activate`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${customerToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              deviceInfo: {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                timestamp: new Date().toISOString(),
              },
            }),
          },
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Failed to activate license");
        }

        alert("License activated successfully!");
        loadDashboardData(); // Reload data
      } catch (error) {
        alert(`Error activating license: ${(error as Error).message}`);
      }
    };

    (window as any).deactivateLicense = async function (licenseId: string) {
      if (!confirm("Are you sure you want to deactivate this license?")) {
        return;
      }

      try {
        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";
        const response = await fetch(
          `${cmsUrl}/api/license-keys/${licenseId}/deactivate`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${customerToken}`,
            },
          },
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Failed to deactivate license");
        }

        alert("License deactivated successfully!");
        loadDashboardData(); // Reload data
      } catch (error) {
        alert(`Error deactivating license: ${(error as Error).message}`);
      }
    };

    // Load dashboard data on page load
    loadDashboardData();
  } // End of login check
</script>
