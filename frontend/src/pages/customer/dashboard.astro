---
/**
 * Customer Dashboard - Stage 6A Redesign
 *
 * Overview Tab (default): Guided "Next action" hero with state-dependent CTA
 * Advanced Tab: Device management, offline refresh (subscriptions only)
 */
import PortalLayout from "../../layouts/PortalLayout.astro";
import DownloadButtons from "../../components/DownloadButtons.astro";
---

<PortalLayout title="Dashboard - Lightlane" activeTab="dashboard">
  <!-- Overview / Advanced Tabs -->
  <div role="tablist" class="tabs tabs-lift mb-6">
    <button
      role="tab"
      class="tab tab-active"
      id="tab-overview"
      aria-controls="panel-overview"
    >
      Overview
    </button>
    <button
      role="tab"
      class="tab"
      id="tab-advanced"
      aria-controls="panel-advanced"
    >
      Advanced
    </button>
  </div>

  <!-- ========== OVERVIEW TAB ========== -->
  <div id="panel-overview" role="tabpanel" class="space-y-6">
    <!-- Next Action Hero (state-dependent) -->
    <section id="next-action-hero" class="surface rounded-2xl p-6 md:p-8">
      <div id="hero-loading" class="flex items-center justify-center py-12">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>

      <!-- Hero: No Entitlements -->
      <div id="hero-no-entitlements" class="hidden">
        <div class="flex flex-col lg:flex-row gap-6 lg:gap-10 items-start">
          <div class="flex-1">
            <h1 class="text-2xl md:text-3xl font-bold mb-3 text-ll-gradient">
              Get Started with Lightlane
            </h1>
            <p class="text-base-content/70 mb-6">
              Choose a plan to unlock professional laser engraving features.
              Your license activates instantly after checkout.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <button id="hero-buy-btn" class="btn btn-gradient">
                <svg
                  class="w-5 h-5 mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                  ></path>
                </svg>
                Subscribe Now
              </button>
              <a href="/pricing" class="btn btn-ghost">View Plans</a>
            </div>
            <p class="mt-4 text-xs text-base-content/50">
              Cancel anytime • One device per license • Instant activation
            </p>
          </div>
          <div class="hidden lg:block">
            <DownloadButtons />
          </div>
        </div>
      </div>

      <!-- Hero: Has Entitlements, No Devices -->
      <div id="hero-no-devices" class="hidden">
        <div class="flex flex-col lg:flex-row gap-6 lg:gap-10 items-start">
          <div class="flex-1">
            <div class="badge badge-success mb-3">License Active</div>
            <h1 class="text-2xl md:text-3xl font-bold mb-3 text-ll-gradient">
              Download & Sign In
            </h1>
            <p class="text-base-content/70 mb-6">
              Download Lightlane, then sign in with your account. The app will
              automatically link your device to your license.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <button
                id="hero-download-btn"
                class="btn btn-gradient"
                data-download-modal-trigger
              >
                <svg
                  class="w-5 h-5 mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                  ></path>
                </svg>
                Download App
              </button>
              <button id="hero-advanced-btn" class="btn btn-ghost">
                Advanced Tools
              </button>
            </div>
            <p class="mt-4 text-xs text-base-content/50">
              Sign in with your email and password in the app to link
              automatically
            </p>
          </div>
        </div>
      </div>

      <!-- Hero: Has Devices, Not Activated -->
      <div id="hero-not-activated" class="hidden">
        <div class="flex flex-col lg:flex-row gap-6 lg:gap-10 items-start">
          <div class="flex-1">
            <div class="badge badge-warning mb-3">Device Registered</div>
            <h1 class="text-2xl md:text-3xl font-bold mb-3 text-ll-gradient">
              Link Your Device
            </h1>
            <p class="text-base-content/70 mb-6">
              Your device is registered. Open Lightlane and sign in to link it
              to your license automatically.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <button class="btn btn-gradient" data-download-modal-trigger>
                <svg
                  class="w-5 h-5 mr-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  ></path>
                </svg>
                Open App
              </button>
              <button id="hero-activate-btn" class="btn btn-ghost">
                Manual Activation
              </button>
            </div>
            <p class="mt-4 text-xs text-base-content/50">
              Need to activate manually? Use the Advanced tab.
            </p>
          </div>
        </div>
      </div>

      <!-- Hero: All Good (has activated device) -->
      <div id="hero-all-good" class="hidden">
        <div class="flex flex-col lg:flex-row gap-6 lg:gap-10 items-center">
          <div class="flex-1">
            <div class="badge badge-success mb-3">All Set</div>
            <h1 class="text-2xl md:text-3xl font-bold mb-3 text-ll-gradient">
              You're Ready to Engrave
            </h1>
            <p class="text-base-content/70 mb-6">
              Your device is linked and ready. Open Lightlane on your machine to
              get started.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
              <button class="btn btn-gradient" data-download-modal-trigger>
                Open Lightlane
              </button>
              <a href="/blog" class="btn btn-ghost">View Tutorials</a>
            </div>
          </div>
          <div class="hidden lg:block">
            <svg
              class="w-16 h-16 text-success"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </section>

    <!-- Plans Summary Card -->
    <section class="surface rounded-xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <svg
            class="w-5 h-5 text-primary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"
            ></path>
          </svg>
          Your Plans
        </h2>
        <div class="flex items-center gap-2">
          <button
            id="refresh-data-btn"
            class="btn btn-xs btn-ghost"
            title="Refresh"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>
          <button id="add-plan-btn" class="btn btn-sm btn-ghost">
            <svg
              class="w-4 h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"></path>
            </svg>
            Add Plan
          </button>
        </div>
      </div>

      <div id="plans-loading" class="flex items-center gap-3 py-4">
        <span class="loading loading-spinner loading-sm"></span>
        <span class="text-sm text-base-content/60">Loading plans...</span>
      </div>

      <div id="plans-empty" class="hidden text-center py-6">
        <p class="text-base-content/60 mb-3">No active plans</p>
        <button id="plans-empty-buy" class="btn btn-primary btn-sm">
          Get Your First License
        </button>
      </div>

      <div id="plans-list" class="hidden space-y-3">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Devices Summary Card -->
    <section class="surface rounded-xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <svg
            class="w-5 h-5 text-primary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            ></path>
          </svg>
          Devices
          <span id="devices-count" class="badge badge-sm badge-ghost">0</span>
        </h2>
        <button id="overview-register-btn" class="btn btn-sm btn-ghost">
          <svg
            class="w-4 h-4 mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"></path>
          </svg>
          Register
        </button>
      </div>

      <div id="devices-overview-loading" class="flex items-center gap-3 py-4">
        <span class="loading loading-spinner loading-sm"></span>
        <span class="text-sm text-base-content/60">Loading devices...</span>
      </div>

      <div id="devices-overview-empty" class="hidden text-center py-6">
        <p class="text-base-content/60 mb-3">No devices registered</p>
        <button id="devices-empty-register" class="btn btn-primary btn-sm">
          Register Your First Device
        </button>
      </div>

      <div id="devices-overview-list" class="hidden">
        <!-- Quick device cards populated by JS -->
      </div>

      <div id="devices-overview-more" class="hidden mt-4 text-center">
        <button id="view-all-devices" class="btn btn-ghost btn-sm">
          View All in Advanced Tab →
        </button>
      </div>
    </section>
  </div>

  <!-- ========== ADVANCED TAB ========== -->
  <div id="panel-advanced" role="tabpanel" class="hidden space-y-6">
    <!-- Devices Table -->
    <section class="surface rounded-xl p-5">
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4"
      >
        <div>
          <h2 class="text-lg font-semibold flex items-center gap-2">
            <svg
              class="w-5 h-5 text-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              ></path>
            </svg>
            Device Management
          </h2>
          <p class="text-sm text-base-content/60">
            Register, activate, and manage your devices
          </p>
        </div>
        <button id="adv-register-device-btn" class="btn btn-primary btn-sm">
          <svg
            class="w-4 h-4 mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"></path>
          </svg>
          Register Device
        </button>
      </div>

      <div
        id="adv-devices-loading"
        class="flex items-center justify-center py-8"
      >
        <span class="loading loading-spinner loading-lg"></span>
      </div>

      <div id="adv-devices-error" class="hidden">
        <div class="alert alert-error">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="adv-devices-error-text">Failed to load devices</span>
        </div>
      </div>

      <div id="adv-devices-empty" class="hidden text-center py-8">
        <svg
          class="w-12 h-12 mx-auto mb-4 text-base-content/30"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          ></path>
        </svg>
        <p class="text-lg font-medium mb-2">No devices registered</p>
        <p class="text-sm text-base-content/60 mb-4">
          Sign in from the Lightlane app to link your device automatically
        </p>
        <button id="adv-devices-empty-register" class="btn btn-primary">
          Manual Registration
        </button>
      </div>

      <div id="adv-devices-table" class="hidden overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Device</th>
              <th>Platform</th>
              <th>Status</th>
              <th>Last Seen</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="adv-devices-tbody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Offline Refresh Section (Subscriptions Only) -->
    <section id="offline-section" class="surface rounded-xl p-5 hidden">
      <div class="flex items-center gap-2 mb-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <svg
            class="w-5 h-5 text-secondary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"
            ></path>
          </svg>
          Offline Refresh
        </h2>
        <span class="badge badge-secondary badge-sm">Subscription Only</span>
      </div>

      <div class="alert alert-info mb-4">
        <svg
          class="w-5 h-5 shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <div class="text-sm">
          <p class="font-medium">For air-gapped/offline machines</p>
          <p class="text-base-content/70">
            Generate a challenge on the offline machine, paste it here to get a
            7-day lease token, then transfer the token back.
          </p>
        </div>
      </div>

      <!-- Step 1: Input -->
      <div id="offline-step-1" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label"
              ><span class="label-text">Entitlement</span></label
            >
            <select
              id="offline-entitlement"
              class="select select-bordered w-full"
            >
              <option value="">Select subscription...</option>
            </select>
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">Device</span></label>
            <select id="offline-device" class="select select-bordered w-full">
              <option value="">Select device...</option>
            </select>
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Challenge Token</span>
          </label>
          <textarea
            id="offline-challenge"
            class="textarea textarea-bordered h-24 font-mono text-xs"
            placeholder="Paste the challenge token from your offline machine..."
          ></textarea>
        </div>

        <div id="offline-error" class="alert alert-error hidden">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="offline-error-text"></span>
        </div>

        <button
          id="offline-redeem-btn"
          class="btn btn-secondary w-full"
          disabled
        >
          Redeem Challenge for Lease Token
        </button>
      </div>

      <!-- Step 2: Result -->
      <div id="offline-step-2" class="hidden space-y-4">
        <div class="alert alert-success">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="font-medium">Lease Token Generated</p>
            <p class="text-sm text-base-content/70">
              Copy and transfer to your offline machine
            </p>
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Lease Token</span>
            <span class="label-text-alt text-warning" id="lease-expiry"></span>
          </label>
          <div class="join w-full">
            <textarea
              id="lease-token-output"
              class="textarea textarea-bordered join-item flex-1 font-mono text-xs h-28"
              readonly></textarea>
            <button id="copy-lease-btn" class="btn btn-secondary join-item">
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                ></path>
              </svg>
              <span>Copy</span>
            </button>
          </div>
        </div>

        <div class="bg-base-200 rounded-lg p-4 text-sm space-y-1">
          <div class="flex justify-between">
            <span class="text-base-content/60">Entitlement:</span>
            <span id="lease-ent-display" class="font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/60">Device:</span>
            <span id="lease-dev-display" class="font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/60">Expires:</span>
            <span id="lease-exp-display" class="font-medium"></span>
          </div>
        </div>

        <button id="offline-reset-btn" class="btn btn-outline w-full">
          Generate Another
        </button>
      </div>
    </section>

    <!-- Air-Gapped Device Activation Section (USB/Copy-Paste) -->
    <section id="airgapped-section" class="surface rounded-xl p-5 hidden">
      <div class="flex items-center gap-2 mb-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <svg
            class="w-5 h-5 text-accent"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
            ></path>
          </svg>
          Air-Gapped Device Activation
        </h2>
        <span class="badge badge-accent badge-sm">Subscription Only</span>
      </div>

      <div class="alert alert-warning mb-4">
        <svg
          class="w-5 h-5 shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
        <div class="text-sm">
          <p class="font-medium">
            For devices that are never connected to the internet
          </p>
          <p class="text-base-content/70">
            <strong>Do not type these codes manually.</strong> They are long and
            error-prone. Use USB drive or file transfer to move codes between machines.
          </p>
        </div>
      </div>

      <!-- Sub-tabs for different operations -->
      <div role="tablist" class="tabs tabs-boxed mb-4">
        <button
          role="tab"
          class="tab tab-active"
          id="ag-tab-provision"
          aria-controls="ag-panel-provision"
        >
          Provision Device
        </button>
        <button
          role="tab"
          class="tab"
          id="ag-tab-refresh"
          aria-controls="ag-panel-refresh"
        >
          Refresh Lease
        </button>
        <button
          role="tab"
          class="tab"
          id="ag-tab-deactivate"
          aria-controls="ag-panel-deactivate"
        >
          Deactivate
        </button>
      </div>

      <!-- Provision Panel -->
      <div id="ag-panel-provision" role="tabpanel" class="space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Entitlement</span>
          </label>
          <select
            id="ag-prov-entitlement"
            class="select select-bordered w-full"
          >
            <option value="">Select subscription...</option>
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Device Setup Code</span>
            <span class="label-text-alt text-base-content/50"
              >From air-gapped machine</span
            >
          </label>
          <div class="flex gap-2 mb-1">
            <button
              type="button"
              id="ag-prov-load-file-btn"
              class="btn btn-xs btn-outline gap-1"
            >
              <svg
                class="w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                ></path>
              </svg>
              Load from file
            </button>
            <input
              type="file"
              id="ag-prov-file-input"
              class="hidden"
              accept=".txt,.json"
            />
            <span class="text-xs text-base-content/50 self-center"
              >Paste from file/clipboard (recommended)</span
            >
          </div>
          <textarea
            id="ag-prov-setup-code"
            class="textarea textarea-bordered h-24 font-mono text-xs"
            placeholder="Paste the device setup code from your air-gapped machine..."
          ></textarea>
        </div>

        <div id="ag-prov-error" class="alert alert-error hidden">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="ag-prov-error-text"></span>
        </div>

        <button id="ag-prov-btn" class="btn btn-accent w-full" disabled>
          <span id="ag-prov-btn-text">Generate Activation Package</span>
          <span
            id="ag-prov-btn-loading"
            class="loading loading-spinner loading-sm hidden"></span>
        </button>

        <!-- Provision Result -->
        <div id="ag-prov-result" class="hidden space-y-4">
          <div class="alert alert-success">
            <svg
              class="w-5 h-5 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <p class="font-medium">Activation Package Ready</p>
              <p class="text-sm text-base-content/70">
                Copy and transfer to your air-gapped machine
              </p>
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Activation Package</span>
              <span class="label-text-alt text-warning" id="ag-prov-expiry"
              ></span>
            </label>
            <p class="text-xs text-base-content/50 mb-1">
              Copy to file and transfer via USB (recommended)
            </p>
            <div class="join w-full">
              <textarea
                id="ag-prov-output"
                class="textarea textarea-bordered join-item flex-1 font-mono text-xs h-28"
                readonly></textarea>
              <div class="join join-vertical">
                <button id="ag-prov-copy-btn" class="btn btn-accent join-item">
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                    ></path>
                  </svg>
                  <span>Copy</span>
                </button>
                <button
                  id="ag-prov-download-btn"
                  class="btn btn-outline join-item"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    ></path>
                  </svg>
                  <span>Download</span>
                </button>
              </div>
            </div>
          </div>

          <button id="ag-prov-reset-btn" class="btn btn-outline w-full"
            >Provision Another Device</button
          >
        </div>
      </div>

      <!-- Refresh Panel -->
      <div id="ag-panel-refresh" role="tabpanel" class="hidden space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Lease Refresh Request Code</span>
            <span class="label-text-alt text-base-content/50"
              >From air-gapped machine</span
            >
          </label>
          <div class="flex gap-2 mb-1">
            <button
              type="button"
              id="ag-refresh-load-file-btn"
              class="btn btn-xs btn-outline gap-1"
            >
              <svg
                class="w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                ></path>
              </svg>
              Load from file
            </button>
            <input
              type="file"
              id="ag-refresh-file-input"
              class="hidden"
              accept=".txt,.json"
            />
            <span class="text-xs text-base-content/50 self-center"
              >Paste from file/clipboard (recommended)</span
            >
          </div>
          <textarea
            id="ag-refresh-request-code"
            class="textarea textarea-bordered h-24 font-mono text-xs"
            placeholder="Paste the lease refresh request code from your air-gapped machine..."
          ></textarea>
        </div>

        <!-- Preview panel (shows decoded info if valid) -->
        <div id="ag-refresh-preview" class="alert alert-info hidden">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <div class="text-sm">
            <p class="font-medium">Code Preview</p>
            <p
              id="ag-refresh-preview-content"
              class="text-xs font-mono opacity-80"
            >
            </p>
          </div>
        </div>

        <div id="ag-refresh-error" class="alert alert-error hidden">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="ag-refresh-error-text"></span>
        </div>

        <button id="ag-refresh-btn" class="btn btn-accent w-full" disabled>
          <span id="ag-refresh-btn-text">Refresh Lease</span>
          <span
            id="ag-refresh-btn-loading"
            class="loading loading-spinner loading-sm hidden"></span>
        </button>

        <!-- Refresh Result -->
        <div id="ag-refresh-result" class="hidden space-y-4">
          <div class="alert alert-success">
            <svg
              class="w-5 h-5 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <p class="font-medium">New Lease Token Ready</p>
              <p class="text-sm text-base-content/70">
                Copy and transfer to your air-gapped machine
              </p>
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Refresh Response Code</span>
              <span class="label-text-alt text-warning" id="ag-refresh-expiry"
              ></span>
            </label>
            <p class="text-xs text-base-content/50 mb-1">
              Copy to file and transfer via USB (recommended)
            </p>
            <div class="join w-full">
              <textarea
                id="ag-refresh-output"
                class="textarea textarea-bordered join-item flex-1 font-mono text-xs h-28"
                readonly></textarea>
              <div class="join join-vertical">
                <button
                  id="ag-refresh-copy-btn"
                  class="btn btn-accent join-item"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                    ></path>
                  </svg>
                  <span>Copy</span>
                </button>
                <button
                  id="ag-refresh-download-btn"
                  class="btn btn-outline join-item"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                    ></path>
                  </svg>
                  <span>Download</span>
                </button>
              </div>
            </div>
          </div>

          <button id="ag-refresh-reset-btn" class="btn btn-outline w-full"
            >Refresh Another</button
          >
        </div>
      </div>

      <!-- Deactivate Panel -->
      <div id="ag-panel-deactivate" role="tabpanel" class="hidden space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Deactivation Code</span>
            <span class="label-text-alt text-base-content/50"
              >From air-gapped machine</span
            >
          </label>
          <div class="flex gap-2 mb-1">
            <button
              type="button"
              id="ag-deact-load-file-btn"
              class="btn btn-xs btn-outline gap-1"
            >
              <svg
                class="w-3 h-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                ></path>
              </svg>
              Load from file
            </button>
            <input
              type="file"
              id="ag-deact-file-input"
              class="hidden"
              accept=".txt,.json"
            />
            <span class="text-xs text-base-content/50 self-center"
              >Paste from file/clipboard (recommended)</span
            >
          </div>
          <textarea
            id="ag-deact-code"
            class="textarea textarea-bordered h-24 font-mono text-xs"
            placeholder="Paste the deactivation code from your air-gapped machine..."
          ></textarea>
        </div>

        <!-- Preview panel (shows decoded info if valid) -->
        <div id="ag-deact-preview" class="alert alert-info hidden">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <div class="text-sm">
            <p class="font-medium">Code Preview</p>
            <p
              id="ag-deact-preview-content"
              class="text-xs font-mono opacity-80"
            >
            </p>
          </div>
        </div>

        <div id="ag-deact-error" class="alert alert-error hidden">
          <svg
            class="w-5 h-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span id="ag-deact-error-text"></span>
        </div>

        <button id="ag-deact-btn" class="btn btn-error w-full" disabled>
          <span id="ag-deact-btn-text">Deactivate Device</span>
          <span
            id="ag-deact-btn-loading"
            class="loading loading-spinner loading-sm hidden"></span>
        </button>

        <!-- Deactivate Result -->
        <div id="ag-deact-result" class="hidden">
          <div class="alert alert-success">
            <svg
              class="w-5 h-5 shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <p class="font-medium">Device Deactivated</p>
              <p class="text-sm text-base-content/70">
                The device seat has been freed. You can now activate another
                device.
              </p>
            </div>
          </div>
          <button id="ag-deact-reset-btn" class="btn btn-outline w-full mt-4"
            >Deactivate Another</button
          >
        </div>
      </div>
    </section>
  </div>

  <!-- ========== MODALS ========== -->

  <!-- Purchase Modal -->
  <dialog id="purchase-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Subscribe to Lightlane</h3>
      <form id="purchase-form" class="space-y-4">
        <div class="form-control">
          <label class="label"><span class="label-text">Plan</span></label>
          <select id="purchase-tier" class="select select-bordered w-full">
            <option value="maker">Maker — $12/month</option>
            <option value="pro" selected>Pro — $24/month</option>
          </select>
        </div>
        <div id="purchase-error" class="alert alert-error hidden text-sm">
          <span id="purchase-error-text"></span>
        </div>
        <button type="submit" class="btn btn-primary w-full">
          <span id="purchase-btn-text">Continue to Checkout</span>
          <span
            id="purchase-btn-loading"
            class="loading loading-spinner loading-sm hidden"></span>
        </button>
      </form>
      <p class="text-xs text-base-content/50 mt-4">
        For Enterprise or Education, <a
          href="/contact"
          class="link link-primary">contact us</a
        >.
      </p>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Register Device Modal -->
  <dialog id="register-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">Register Device</h3>
      <p class="text-sm text-base-content/60 mb-4">
        Register a machine to activate your license on it.
      </p>
      <form id="register-form" class="space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Device ID</span>
            <span class="label-text-alt text-error">Required</span>
          </label>
          <input
            type="text"
            id="register-device-id"
            class="input input-bordered w-full"
            placeholder="e.g., factory-cnc-01"
            required
          />
          <label class="label">
            <span class="label-text-alt"
              >Unique identifier (alphanumeric, dashes, underscores)</span
            >
          </label>
        </div>
        <div class="form-control">
          <label class="label"
            ><span class="label-text">Name (optional)</span></label
          >
          <input
            type="text"
            id="register-device-name"
            class="input input-bordered w-full"
            placeholder="My Workstation"
          />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text">Platform</span></label>
          <select
            id="register-device-platform"
            class="select select-bordered w-full"
          >
            <option value="">Unknown</option>
            <option value="windows">Windows</option>
            <option value="macos">macOS</option>
            <option value="linux">Linux</option>
            <option value="embedded">Embedded</option>
          </select>
        </div>
        <div id="register-error" class="alert alert-error hidden text-sm">
          <span id="register-error-text"></span>
        </div>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">
            <span id="register-btn-text">Register Device</span>
            <span
              id="register-btn-loading"
              class="loading loading-spinner loading-sm hidden"></span>
          </button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Activate Device Modal -->
  <dialog id="activate-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">Activate Device</h3>
      <p class="text-sm text-base-content/60 mb-4">
        Link this device to an entitlement to use Lightlane on it.
      </p>
      <form id="activate-form" class="space-y-4">
        <input type="hidden" id="activate-device-id" />
        <div class="bg-base-200 rounded-lg p-3 text-sm">
          <span class="text-base-content/60">Device:</span>
          <span id="activate-device-name" class="font-medium ml-2"></span>
        </div>
        <div class="form-control">
          <label class="label"
            ><span class="label-text">Entitlement</span></label
          >
          <select
            id="activate-entitlement"
            class="select select-bordered w-full"
          >
            <option value="">Select entitlement...</option>
          </select>
        </div>
        <div id="activate-error" class="alert alert-error hidden text-sm">
          <span id="activate-error-text"></span>
        </div>
        <div id="activate-success" class="alert alert-success hidden text-sm">
          <span id="activate-success-text"></span>
        </div>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">
            <span id="activate-btn-text">Activate</span>
            <span
              id="activate-btn-loading"
              class="loading loading-spinner loading-sm hidden"></span>
          </button>
          <form method="dialog"><button class="btn">Close</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Deactivate Device Modal -->
  <dialog id="deactivate-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">Deactivate Device</h3>
      <p class="text-sm text-base-content/60 mb-4">
        This will unbind the entitlement from this device, freeing up a slot.
      </p>
      <form id="deactivate-form" class="space-y-4">
        <input type="hidden" id="deactivate-device-id" />
        <input type="hidden" id="deactivate-entitlement-id" />
        <div class="bg-base-200 rounded-lg p-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-base-content/60">Device:</span>
            <span id="deactivate-device-name" class="font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/60">Entitlement:</span>
            <span id="deactivate-ent-name" class="font-medium"></span>
          </div>
        </div>
        <div id="deactivate-error" class="alert alert-error hidden text-sm">
          <span id="deactivate-error-text"></span>
        </div>
        <div class="modal-action">
          <button type="submit" class="btn btn-error">
            <span id="deactivate-btn-text">Deactivate</span>
            <span
              id="deactivate-btn-loading"
              class="loading loading-spinner loading-sm hidden"></span>
          </button>
          <form method="dialog"><button class="btn">Cancel</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Refresh Device Modal -->
  <dialog id="refresh-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">Refresh Activation</h3>
      <p class="text-sm text-base-content/60 mb-4">
        Manually trigger a heartbeat refresh for this device.
      </p>
      <form id="refresh-form" class="space-y-4">
        <input type="hidden" id="refresh-device-id" />
        <input type="hidden" id="refresh-entitlement-id" />
        <div class="bg-base-200 rounded-lg p-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-base-content/60">Device:</span>
            <span id="refresh-device-name" class="font-medium"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-base-content/60">Entitlement:</span>
            <span id="refresh-ent-name" class="font-medium"></span>
          </div>
        </div>
        <div id="refresh-error" class="alert alert-error hidden text-sm">
          <span id="refresh-error-text"></span>
        </div>
        <div id="refresh-success" class="alert alert-success hidden text-sm">
          <span id="refresh-success-text"></span>
        </div>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">
            <span id="refresh-btn-text">Refresh</span>
            <span
              id="refresh-btn-loading"
              class="loading loading-spinner loading-sm hidden"></span>
          </button>
          <form method="dialog"><button class="btn">Close</button></form>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>
</PortalLayout>

<script>
  import { getAuthState, logout } from "../../lib/portal/auth";
  import { portalFetch, getCmsUrl, parseApiError } from "../../lib/portal/api";
  import type {
    EntitlementsResponse,
    DevicesResponse,
    Entitlement,
    Device,
    CheckoutResponse,
    RegisterDeviceResponse,
    ActivateResponse,
    DeactivateResponse,
    RefreshResponse,
    OfflineRefreshResponse,
  } from "../../lib/portal/types";
  import {
    formatDate,
    formatTier,
    isActiveEntitlement,
    isSubscriptionEntitlement,
  } from "../../lib/portal/types";

  // === State ===
  let entitlements: Entitlement[] = [];
  let devices: Device[] = [];

  // === Tab Switching ===
  const tabOverview = document.getElementById("tab-overview")!;
  const tabAdvanced = document.getElementById("tab-advanced")!;
  const panelOverview = document.getElementById("panel-overview")!;
  const panelAdvanced = document.getElementById("panel-advanced")!;

  function switchTab(tab: "overview" | "advanced") {
    if (tab === "overview") {
      tabOverview.classList.add("tab-active");
      tabAdvanced.classList.remove("tab-active");
      panelOverview.classList.remove("hidden");
      panelAdvanced.classList.add("hidden");
    } else {
      tabOverview.classList.remove("tab-active");
      tabAdvanced.classList.add("tab-active");
      panelOverview.classList.add("hidden");
      panelAdvanced.classList.remove("hidden");
    }
  }

  tabOverview.addEventListener("click", () => switchTab("overview"));
  tabAdvanced.addEventListener("click", () => switchTab("advanced"));

  // "View all in Advanced" button
  document.getElementById("view-all-devices")?.addEventListener("click", () => {
    switchTab("advanced");
  });

  // "Advanced Tools" button in hero
  document
    .getElementById("hero-advanced-btn")
    ?.addEventListener("click", () => {
      switchTab("advanced");
    });

  // === Hero State Logic ===
  function updateHeroState() {
    const loading = document.getElementById("hero-loading")!;
    const heroNoEnt = document.getElementById("hero-no-entitlements")!;
    const heroNoDevices = document.getElementById("hero-no-devices")!;
    const heroNotActivated = document.getElementById("hero-not-activated")!;
    const heroAllGood = document.getElementById("hero-all-good")!;

    // Hide all
    loading.classList.add("hidden");
    heroNoEnt.classList.add("hidden");
    heroNoDevices.classList.add("hidden");
    heroNotActivated.classList.add("hidden");
    heroAllGood.classList.add("hidden");

    const activeEnts = entitlements.filter(isActiveEntitlement);

    // No active entitlements → buy
    if (activeEnts.length === 0) {
      heroNoEnt.classList.remove("hidden");
      return;
    }

    // Has entitlements but no devices → download/register
    if (devices.length === 0) {
      heroNoDevices.classList.remove("hidden");
      return;
    }

    // Has devices but none activated → activate
    const hasActivated = devices.some((d) => d.isActivated);
    if (!hasActivated) {
      heroNotActivated.classList.remove("hidden");
      return;
    }

    // All good
    heroAllGood.classList.remove("hidden");
  }

  // === Plans List ===
  function renderPlans() {
    const loading = document.getElementById("plans-loading")!;
    const empty = document.getElementById("plans-empty")!;
    const list = document.getElementById("plans-list")!;

    loading.classList.add("hidden");

    if (entitlements.length === 0) {
      empty.classList.remove("hidden");
      list.classList.add("hidden");
      return;
    }

    empty.classList.add("hidden");
    list.classList.remove("hidden");

    // Render each entitlement (no deduplication by name)
    list.innerHTML = entitlements
      .map((ent) => {
        const statusClass = isActiveEntitlement(ent)
          ? "badge-success"
          : ent.status === "canceled"
            ? "badge-error"
            : "badge-ghost";

        const statusText =
          ent.status === "active"
            ? ent.cancelAtPeriodEnd
              ? "Canceling"
              : "Active"
            : ent.status.charAt(0).toUpperCase() + ent.status.slice(1);

        const typeLabel = ent.isLifetime ? "Lifetime" : "Subscription";
        const renewInfo = ent.isLifetime
          ? "No renewal needed"
          : ent.currentPeriodEnd
            ? `${ent.cancelAtPeriodEnd ? "Ends" : "Renews"} ${formatDate(ent.currentPeriodEnd)}`
            : "";

        // Device association
        const linkedCount = getLinkedDeviceCount(ent.id);
        const deviceBadge =
          linkedCount > 0
            ? `<span class="badge badge-sm badge-outline badge-success">Linked to ${linkedCount} device${linkedCount > 1 ? "s" : ""}</span>`
            : `<span class="badge badge-sm badge-outline badge-ghost">Not linked</span>`;

        return `
          <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg" data-entitlement-id="${ent.id}">
            <div>
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-semibold">${formatTier(ent.tier)}</span>
                <span class="badge badge-sm ${statusClass}">${statusText}</span>
                <span class="badge badge-sm badge-ghost">${typeLabel}</span>
                ${deviceBadge}
              </div>
              <p class="text-sm text-base-content/60 mt-1">${renewInfo}</p>
            </div>
            ${
              !ent.isLifetime
                ? `<button class="btn btn-ghost btn-sm billing-btn" data-ent-id="${ent.id}">Manage</button>`
                : ""
            }
          </div>
        `;
      })
      .join("");

    // Attach billing portal handlers
    list.querySelectorAll(".billing-btn").forEach((btn) => {
      btn.addEventListener("click", openBillingPortal);
    });
  }

  // === Devices Overview (compact cards) ===
  function renderDevicesOverview() {
    const loading = document.getElementById("devices-overview-loading")!;
    const empty = document.getElementById("devices-overview-empty")!;
    const list = document.getElementById("devices-overview-list")!;
    const more = document.getElementById("devices-overview-more")!;
    const count = document.getElementById("devices-count")!;

    loading.classList.add("hidden");
    count.textContent = String(devices.length);

    if (devices.length === 0) {
      empty.classList.remove("hidden");
      list.classList.add("hidden");
      more.classList.add("hidden");
      return;
    }

    empty.classList.add("hidden");
    list.classList.remove("hidden");

    // Show first 3 devices
    const shown = devices.slice(0, 3);
    list.innerHTML = shown
      .map((d) => {
        const icon = getPlatformIcon(d.platform);
        const entName = getDeviceEntitlementName(d);
        const statusInfo = d.isActivated
          ? `<span class="badge badge-success badge-xs">${entName || "Linked"}</span>`
          : `<span class="badge badge-ghost badge-xs">Not linked</span>`;

        return `
          <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg mb-2">
            <div class="flex items-center gap-3">
              <span class="text-base-content/70">${icon}</span>
              <div>
                <div class="font-medium">${d.name || d.deviceId}</div>
                <div class="text-xs text-base-content/50 font-mono">${d.deviceId}</div>
              </div>
            </div>
            ${statusInfo}
          </div>
        `;
      })
      .join("");

    // Show "View all" if more than 3
    if (devices.length > 3) {
      more.classList.remove("hidden");
    } else {
      more.classList.add("hidden");
    }
  }

  // === Advanced Devices Table ===
  function renderDevicesTable() {
    const loading = document.getElementById("adv-devices-loading")!;
    const error = document.getElementById("adv-devices-error")!;
    const empty = document.getElementById("adv-devices-empty")!;
    const table = document.getElementById("adv-devices-table")!;
    const tbody = document.getElementById("adv-devices-tbody")!;

    loading.classList.add("hidden");
    error.classList.add("hidden");

    if (devices.length === 0) {
      empty.classList.remove("hidden");
      table.classList.add("hidden");
      return;
    }

    empty.classList.add("hidden");
    table.classList.remove("hidden");

    tbody.innerHTML = devices
      .map((d) => {
        const icon = getPlatformIcon(d.platform);
        const entName = getDeviceEntitlementName(d);
        const statusBadge = d.isActivated
          ? `<span class="badge badge-success badge-sm">${entName || "Linked"}</span>`
          : `<span class="badge badge-ghost badge-sm">Not linked</span>`;
        const lastSeen = d.lastSeen ? formatDate(d.lastSeen) : "Never";

        let actions = "";
        if (d.isActivated && d.entitlement) {
          actions = `
            <button class="btn btn-ghost btn-xs refresh-btn" data-device-id="${d.deviceId}" data-ent-id="${d.entitlement.id}" data-device-name="${d.name || d.deviceId}" data-ent-tier="${d.entitlement.tier}" title="Refresh">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </button>
            <button class="btn btn-ghost btn-xs text-error deactivate-btn" data-device-id="${d.deviceId}" data-ent-id="${d.entitlement.id}" data-device-name="${d.name || d.deviceId}" data-ent-tier="${d.entitlement.tier}" title="Deactivate">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
              </svg>
            </button>
          `;
        } else {
          actions = `
            <button class="btn btn-primary btn-xs activate-btn" data-device-id="${d.deviceId}" data-device-name="${d.name || d.deviceId}">Link</button>
          `;
        }

        return `
          <tr>
            <td>
              <div class="flex items-center gap-2">
                <span class="text-base-content/70">${icon}</span>
                <div>
                  <div class="font-medium">${d.name || d.deviceId}</div>
                  <div class="text-xs text-base-content/50 font-mono">${d.deviceId}</div>
                </div>
              </div>
            </td>
            <td>${d.platform || "-"}</td>
            <td>${statusBadge}</td>
            <td class="text-sm">${lastSeen}</td>
            <td class="text-right">
              <div class="flex justify-end gap-1">${actions}</div>
            </td>
          </tr>
        `;
      })
      .join("");

    // Attach event handlers
    tbody.querySelectorAll(".activate-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const deviceId = btn.getAttribute("data-device-id")!;
        const deviceName = btn.getAttribute("data-device-name")!;
        openActivateModal(deviceId, deviceName);
      });
    });

    tbody.querySelectorAll(".deactivate-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const deviceId = btn.getAttribute("data-device-id")!;
        const entId = btn.getAttribute("data-ent-id")!;
        const deviceName = btn.getAttribute("data-device-name")!;
        const entTier = btn.getAttribute("data-ent-tier")!;
        openDeactivateModal(deviceId, entId, deviceName, entTier);
      });
    });

    tbody.querySelectorAll(".refresh-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const deviceId = btn.getAttribute("data-device-id")!;
        const entId = btn.getAttribute("data-ent-id")!;
        const deviceName = btn.getAttribute("data-device-name")!;
        const entTier = btn.getAttribute("data-ent-tier")!;
        openRefreshModal(deviceId, entId, deviceName, entTier);
      });
    });
  }

  // === Offline Refresh Section ===
  function renderOfflineSection() {
    const section = document.getElementById("offline-section")!;
    const entSelect = document.getElementById(
      "offline-entitlement",
    ) as HTMLSelectElement;
    const devSelect = document.getElementById(
      "offline-device",
    ) as HTMLSelectElement;

    // Only show for subscription entitlements
    const subscriptionEnts = entitlements.filter(
      (e) => isSubscriptionEntitlement(e) && isActiveEntitlement(e),
    );

    if (subscriptionEnts.length === 0) {
      section.classList.add("hidden");
      return;
    }

    section.classList.remove("hidden");

    // Populate dropdowns
    entSelect.innerHTML =
      '<option value="">Select subscription...</option>' +
      subscriptionEnts
        .map(
          (e) =>
            `<option value="${e.id}">${formatTier(e.tier)} (Subscription)</option>`,
        )
        .join("");

    devSelect.innerHTML =
      '<option value="">Select device...</option>' +
      devices
        .map(
          (d) =>
            `<option value="${d.deviceId}">${d.name || d.deviceId}</option>`,
        )
        .join("");

    updateOfflineBtn();
  }

  function updateOfflineBtn() {
    const entSelect = document.getElementById(
      "offline-entitlement",
    ) as HTMLSelectElement;
    const devSelect = document.getElementById(
      "offline-device",
    ) as HTMLSelectElement;
    const challenge = document.getElementById(
      "offline-challenge",
    ) as HTMLTextAreaElement;
    const btn = document.getElementById(
      "offline-redeem-btn",
    ) as HTMLButtonElement;

    btn.disabled = !(
      entSelect.value &&
      devSelect.value &&
      challenge.value.trim()
    );
  }

  document
    .getElementById("offline-entitlement")
    ?.addEventListener("change", updateOfflineBtn);
  document
    .getElementById("offline-device")
    ?.addEventListener("change", updateOfflineBtn);
  document
    .getElementById("offline-challenge")
    ?.addEventListener("input", updateOfflineBtn);

  // === Platform Icon (SVG) ===
  function getPlatformIcon(platform: string | null): string {
    switch (platform?.toLowerCase()) {
      case "windows":
        return `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 5.5L10.5 4.5V11.5H3V5.5zM12 4.3L21 3V11.5H12V4.3zM3 13H10.5V20L3 19V13zM12 13H21V21.5L12 20.2V13z"/></svg>`;
      case "macos":
        return `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>`;
      case "linux":
        return `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12.504 0c-.155 0-.311.006-.467.018C9.39.14 7.436 1.59 6.18 3.746c-.896 1.532-1.39 3.31-1.526 5.104-.137 1.793.05 3.678.774 5.367.163.38.377.73.617 1.057l-.143.065c-.658.3-1.196.626-1.58 1.01-.436.438-.701.966-.804 1.582a2.96 2.96 0 0 0 .218 1.607 2.67 2.67 0 0 0 1.12 1.25c.614.345 1.346.52 2.165.585a8.92 8.92 0 0 0 2.71-.176c.434-.093.847-.22 1.236-.384.39.165.802.292 1.237.385.872.185 1.808.23 2.71.175.819-.065 1.55-.24 2.165-.585a2.67 2.67 0 0 0 1.12-1.25c.288-.535.365-1.107.218-1.607-.103-.616-.368-1.144-.804-1.582-.384-.384-.922-.71-1.58-1.01l-.143-.066c.24-.327.454-.677.617-1.056.724-1.69.911-3.574.774-5.367-.136-1.793-.63-3.572-1.526-5.104C16.564 1.59 14.61.14 11.963.018A6.41 6.41 0 0 0 12.504 0zm.086 1.995c2.26.065 3.867 1.34 4.61 2.969.595 1.3.869 2.83.932 4.255.063 1.426-.076 2.8-.424 3.82a5.74 5.74 0 0 1-.56 1.19c-.148.226-.31.423-.466.599l-.04.044-.09.085a6.57 6.57 0 0 1-.654.5c-.486.32-1.055.56-1.672.71a7.15 7.15 0 0 1-3.424.008 5.81 5.81 0 0 1-1.672-.718 6.24 6.24 0 0 1-.653-.5l-.089-.083-.04-.044a3.82 3.82 0 0 1-.466-.6 5.75 5.75 0 0 1-.56-1.188c-.348-1.02-.487-2.394-.424-3.82.063-1.426.337-2.957.932-4.256.743-1.629 2.35-2.904 4.61-2.969h.21z"/></svg>`;
      case "embedded":
        return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>`;
      default:
        return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>`;
    }
  }

  // === Helper: Count devices linked to an entitlement ===
  function getLinkedDeviceCount(entitlementId: number): number {
    return devices.filter(
      (d) => d.isActivated && d.entitlement?.id === entitlementId,
    ).length;
  }

  // === Helper: Get entitlement name for a device ===
  function getDeviceEntitlementName(device: Device): string | null {
    if (!device.isActivated || !device.entitlement) return null;
    return formatTier(device.entitlement.tier);
  }

  // === Data Loading ===
  async function loadEntitlements() {
    try {
      const data = await portalFetch<EntitlementsResponse>(
        "/api/customers/me/entitlements",
        {
          cache: "no-store",
        },
      );
      entitlements = data.entitlements || [];
    } catch (err) {
      console.error("Failed to load entitlements:", err);
      entitlements = [];
    }
  }

  async function loadDevices() {
    try {
      const data = await portalFetch<DevicesResponse>(
        "/api/customers/me/devices",
        {
          cache: "no-store",
        },
      );
      devices = data.devices || [];
    } catch (err) {
      console.error("Failed to load devices:", err);
      devices = [];
    }
  }

  async function loadAllData() {
    await Promise.all([loadEntitlements(), loadDevices()]);
    updateHeroState();
    renderPlans();
    renderDevicesOverview();
    renderDevicesTable();
    renderOfflineSection();
    renderAirgappedSection();
  }

  // === Billing Portal ===
  async function openBillingPortal() {
    try {
      const data = await portalFetch<{ url: string }>(
        "/api/customers/billing-portal",
        {
          method: "POST",
          body: JSON.stringify({ returnUrl: window.location.href }),
        },
      );
      if (data.url) {
        window.location.href = data.url;
      }
    } catch (err) {
      alert("Failed to open billing portal. Please try again.");
    }
  }

  // === Purchase Modal ===
  const purchaseModal = document.getElementById(
    "purchase-modal",
  ) as HTMLDialogElement;
  const purchaseForm = document.getElementById(
    "purchase-form",
  ) as HTMLFormElement;

  function openPurchaseModal() {
    purchaseModal.showModal();
  }

  document
    .getElementById("hero-buy-btn")
    ?.addEventListener("click", openPurchaseModal);
  document
    .getElementById("add-plan-btn")
    ?.addEventListener("click", openPurchaseModal);
  document
    .getElementById("plans-empty-buy")
    ?.addEventListener("click", openPurchaseModal);

  purchaseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const tier = (document.getElementById("purchase-tier") as HTMLSelectElement)
      .value;
    const btnText = document.getElementById("purchase-btn-text")!;
    const btnLoad = document.getElementById("purchase-btn-loading")!;
    const errorEl = document.getElementById("purchase-error")!;
    const errorText = document.getElementById("purchase-error-text")!;

    errorEl.classList.add("hidden");
    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      const data = await portalFetch<CheckoutResponse>(
        "/api/customer-checkout-subscription",
        {
          method: "POST",
          body: JSON.stringify({
            tier,
            successPath: "/customer/success",
            cancelPath: "/customer/dashboard",
          }),
        },
      );
      if (data.url) {
        window.location.href = data.url;
      }
    } catch (err) {
      errorText.textContent = parseApiError(err);
      errorEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Register Modal ===
  const registerModal = document.getElementById(
    "register-modal",
  ) as HTMLDialogElement;
  const registerForm = document.getElementById(
    "register-form",
  ) as HTMLFormElement;

  function openRegisterModal() {
    (document.getElementById("register-device-id") as HTMLInputElement).value =
      "";
    (
      document.getElementById("register-device-name") as HTMLInputElement
    ).value = "";
    (
      document.getElementById("register-device-platform") as HTMLSelectElement
    ).value = "";
    document.getElementById("register-error")!.classList.add("hidden");
    registerModal.showModal();
  }

  document
    .getElementById("hero-register-btn")
    ?.addEventListener("click", openRegisterModal);
  document
    .getElementById("overview-register-btn")
    ?.addEventListener("click", openRegisterModal);
  document
    .getElementById("adv-register-device-btn")
    ?.addEventListener("click", openRegisterModal);
  document
    .getElementById("devices-empty-register")
    ?.addEventListener("click", openRegisterModal);
  document
    .getElementById("adv-devices-empty-register")
    ?.addEventListener("click", openRegisterModal);

  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const deviceId = (
      document.getElementById("register-device-id") as HTMLInputElement
    ).value.trim();
    const deviceName = (
      document.getElementById("register-device-name") as HTMLInputElement
    ).value.trim();
    const platform = (
      document.getElementById("register-device-platform") as HTMLSelectElement
    ).value;

    const btnText = document.getElementById("register-btn-text")!;
    const btnLoad = document.getElementById("register-btn-loading")!;
    const errorEl = document.getElementById("register-error")!;
    const errorText = document.getElementById("register-error-text")!;

    if (!deviceId) {
      errorText.textContent = "Device ID is required";
      errorEl.classList.remove("hidden");
      return;
    }

    errorEl.classList.add("hidden");
    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      await portalFetch<RegisterDeviceResponse>("/api/device/register", {
        method: "POST",
        body: JSON.stringify({
          deviceId,
          deviceName: deviceName || undefined,
          platform: platform || undefined,
        }),
      });
      registerModal.close();
      await loadAllData();
    } catch (err) {
      errorText.textContent = parseApiError(err);
      errorEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Activate Modal ===
  const activateModal = document.getElementById(
    "activate-modal",
  ) as HTMLDialogElement;
  const activateForm = document.getElementById(
    "activate-form",
  ) as HTMLFormElement;

  function openActivateModal(deviceId: string, deviceName: string) {
    (document.getElementById("activate-device-id") as HTMLInputElement).value =
      deviceId;
    document.getElementById("activate-device-name")!.textContent = deviceName;

    const select = document.getElementById(
      "activate-entitlement",
    ) as HTMLSelectElement;
    select.innerHTML =
      '<option value="">Select entitlement...</option>' +
      entitlements
        .filter(isActiveEntitlement)
        .map(
          (e) =>
            `<option value="${e.id}">${formatTier(e.tier)} (${e.isLifetime ? "Lifetime" : "Subscription"})</option>`,
        )
        .join("");

    document.getElementById("activate-error")!.classList.add("hidden");
    document.getElementById("activate-success")!.classList.add("hidden");
    activateModal.showModal();
  }

  // Hero activate button - activate first unactivated device
  document
    .getElementById("hero-activate-btn")
    ?.addEventListener("click", () => {
      const unactivated = devices.find((d) => !d.isActivated);
      if (unactivated) {
        openActivateModal(
          unactivated.deviceId,
          unactivated.name || unactivated.deviceId,
        );
      }
    });

  activateForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const deviceId = (
      document.getElementById("activate-device-id") as HTMLInputElement
    ).value;
    const entitlementId = (
      document.getElementById("activate-entitlement") as HTMLSelectElement
    ).value;

    const btnText = document.getElementById("activate-btn-text")!;
    const btnLoad = document.getElementById("activate-btn-loading")!;
    const errorEl = document.getElementById("activate-error")!;
    const errorText = document.getElementById("activate-error-text")!;
    const successEl = document.getElementById("activate-success")!;
    const successText = document.getElementById("activate-success-text")!;

    if (!entitlementId) {
      errorText.textContent = "Please select an entitlement";
      errorEl.classList.remove("hidden");
      return;
    }

    errorEl.classList.add("hidden");
    successEl.classList.add("hidden");
    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      const data = await portalFetch<ActivateResponse>(
        "/api/licence/activate",
        {
          method: "POST",
          body: JSON.stringify({
            deviceId,
            entitlementId: parseInt(entitlementId, 10),
          }),
        },
      );
      successText.textContent = `Activated! ${data.expiresAt ? `Expires ${formatDate(data.expiresAt)}` : ""}`;
      successEl.classList.remove("hidden");
      setTimeout(() => {
        activateModal.close();
        loadAllData();
      }, 1500);
    } catch (err) {
      errorText.textContent = parseApiError(err);
      errorEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Deactivate Modal ===
  const deactivateModal = document.getElementById(
    "deactivate-modal",
  ) as HTMLDialogElement;
  const deactivateForm = document.getElementById(
    "deactivate-form",
  ) as HTMLFormElement;

  function openDeactivateModal(
    deviceId: string,
    entId: string,
    deviceName: string,
    entTier: string,
  ) {
    (
      document.getElementById("deactivate-device-id") as HTMLInputElement
    ).value = deviceId;
    (
      document.getElementById("deactivate-entitlement-id") as HTMLInputElement
    ).value = entId;
    document.getElementById("deactivate-device-name")!.textContent = deviceName;
    document.getElementById("deactivate-ent-name")!.textContent =
      formatTier(entTier);
    document.getElementById("deactivate-error")!.classList.add("hidden");
    deactivateModal.showModal();
  }

  deactivateForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const deviceId = (
      document.getElementById("deactivate-device-id") as HTMLInputElement
    ).value;
    const entitlementId = (
      document.getElementById("deactivate-entitlement-id") as HTMLInputElement
    ).value;

    const btnText = document.getElementById("deactivate-btn-text")!;
    const btnLoad = document.getElementById("deactivate-btn-loading")!;
    const errorEl = document.getElementById("deactivate-error")!;
    const errorText = document.getElementById("deactivate-error-text")!;

    errorEl.classList.add("hidden");
    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      await portalFetch<DeactivateResponse>("/api/licence/deactivate", {
        method: "POST",
        body: JSON.stringify({
          deviceId,
          entitlementId: parseInt(entitlementId, 10),
        }),
      });
      deactivateModal.close();
      await loadAllData();
    } catch (err) {
      errorText.textContent = parseApiError(err);
      errorEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Refresh Modal ===
  const refreshModal = document.getElementById(
    "refresh-modal",
  ) as HTMLDialogElement;
  const refreshForm = document.getElementById(
    "refresh-form",
  ) as HTMLFormElement;

  function openRefreshModal(
    deviceId: string,
    entId: string,
    deviceName: string,
    entTier: string,
  ) {
    (document.getElementById("refresh-device-id") as HTMLInputElement).value =
      deviceId;
    (
      document.getElementById("refresh-entitlement-id") as HTMLInputElement
    ).value = entId;
    document.getElementById("refresh-device-name")!.textContent = deviceName;
    document.getElementById("refresh-ent-name")!.textContent =
      formatTier(entTier);
    document.getElementById("refresh-error")!.classList.add("hidden");
    document.getElementById("refresh-success")!.classList.add("hidden");
    refreshModal.showModal();
  }

  refreshForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const deviceId = (
      document.getElementById("refresh-device-id") as HTMLInputElement
    ).value;
    const entitlementId = (
      document.getElementById("refresh-entitlement-id") as HTMLInputElement
    ).value;

    const btnText = document.getElementById("refresh-btn-text")!;
    const btnLoad = document.getElementById("refresh-btn-loading")!;
    const errorEl = document.getElementById("refresh-error")!;
    const errorText = document.getElementById("refresh-error-text")!;
    const successEl = document.getElementById("refresh-success")!;
    const successText = document.getElementById("refresh-success-text")!;

    errorEl.classList.add("hidden");
    successEl.classList.add("hidden");
    btnText.classList.add("hidden");
    btnLoad.classList.remove("hidden");

    try {
      const data = await portalFetch<RefreshResponse>("/api/licence/refresh", {
        method: "POST",
        body: JSON.stringify({
          deviceId,
          entitlementId: parseInt(entitlementId, 10),
        }),
      });
      let msg = "Refreshed successfully";
      if (data.leaseToken && data.leaseExpiresAt) {
        msg = `Lease renewed until ${formatDate(data.leaseExpiresAt)}`;
      }
      successText.textContent = msg;
      successEl.classList.remove("hidden");
      setTimeout(() => {
        refreshModal.close();
        loadAllData();
      }, 1500);
    } catch (err) {
      errorText.textContent = parseApiError(err);
      errorEl.classList.remove("hidden");
    } finally {
      btnText.classList.remove("hidden");
      btnLoad.classList.add("hidden");
    }
  });

  // === Offline Refresh ===
  document
    .getElementById("offline-redeem-btn")
    ?.addEventListener("click", async () => {
      const entId = (
        document.getElementById("offline-entitlement") as HTMLSelectElement
      ).value;
      const deviceId = (
        document.getElementById("offline-device") as HTMLSelectElement
      ).value;
      const challenge = (
        document.getElementById("offline-challenge") as HTMLTextAreaElement
      ).value.trim();

      const btn = document.getElementById(
        "offline-redeem-btn",
      ) as HTMLButtonElement;
      const errorEl = document.getElementById("offline-error")!;
      const errorText = document.getElementById("offline-error-text")!;

      if (!entId || !deviceId || !challenge) return;

      // Basic validation
      if (!challenge.includes(".")) {
        errorText.textContent = "Invalid challenge token format";
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      btn.disabled = true;
      btn.innerHTML =
        '<span class="loading loading-spinner loading-sm"></span> Redeeming...';

      try {
        const data = await portalFetch<OfflineRefreshResponse>(
          "/api/licence/offline-refresh",
          {
            method: "POST",
            body: JSON.stringify({ challenge }),
          },
        );

        // Show result
        document.getElementById("offline-step-1")!.classList.add("hidden");
        document.getElementById("offline-step-2")!.classList.remove("hidden");

        (
          document.getElementById("lease-token-output") as HTMLTextAreaElement
        ).value = data.leaseToken;

        const ent = entitlements.find((e) => e.id === parseInt(entId));
        const dev = devices.find((d) => d.deviceId === deviceId);

        document.getElementById("lease-ent-display")!.textContent = ent
          ? formatTier(ent.tier)
          : entId;
        document.getElementById("lease-dev-display")!.textContent = dev
          ? dev.name || dev.deviceId
          : deviceId;

        // Parse token for expiry
        try {
          const payload = JSON.parse(atob(data.leaseToken.split(".")[1]));
          const expiry = new Date(payload.exp * 1000);
          document.getElementById("lease-exp-display")!.textContent =
            expiry.toLocaleString();
          const daysLeft = Math.round(
            (expiry.getTime() - Date.now()) / (1000 * 60 * 60 * 24),
          );
          document.getElementById("lease-expiry")!.textContent =
            `Valid for ${daysLeft} days`;
        } catch {
          document.getElementById("lease-exp-display")!.textContent = "Unknown";
          document.getElementById("lease-expiry")!.textContent = "";
        }
      } catch (err) {
        errorText.textContent = parseApiError(err);
        errorEl.classList.remove("hidden");
      } finally {
        btn.disabled = false;
        btn.textContent = "Redeem Challenge for Lease Token";
        updateOfflineBtn();
      }
    });

  // Copy lease token
  document
    .getElementById("copy-lease-btn")
    ?.addEventListener("click", async () => {
      const token = (
        document.getElementById("lease-token-output") as HTMLTextAreaElement
      ).value;
      const btn = document.getElementById(
        "copy-lease-btn",
      ) as HTMLButtonElement;
      try {
        await navigator.clipboard.writeText(token);
        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Copied!</span>`;
        btn.classList.remove("btn-secondary");
        btn.classList.add("btn-success");
        setTimeout(() => {
          btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg><span>Copy</span>`;
          btn.classList.remove("btn-success");
          btn.classList.add("btn-secondary");
        }, 2000);
      } catch {
        // Fallback
        const textarea = document.getElementById(
          "lease-token-output",
        ) as HTMLTextAreaElement;
        textarea.select();
        document.execCommand("copy");
      }
    });

  // Reset offline refresh
  document
    .getElementById("offline-reset-btn")
    ?.addEventListener("click", () => {
      document.getElementById("offline-step-1")!.classList.remove("hidden");
      document.getElementById("offline-step-2")!.classList.add("hidden");
      (
        document.getElementById("offline-entitlement") as HTMLSelectElement
      ).value = "";
      (document.getElementById("offline-device") as HTMLSelectElement).value =
        "";
      (
        document.getElementById("offline-challenge") as HTMLTextAreaElement
      ).value = "";
      document.getElementById("offline-error")!.classList.add("hidden");
      updateOfflineBtn();
    });

  // === Air-Gapped Device Activation Section ===
  // Types for API responses
  interface OfflineProvisionResponse {
    activationPackage: string;
    leaseExpiresAt: string;
  }

  interface OfflineLeaseRefreshResponse {
    refreshResponseCode: string;
    leaseExpiresAt: string;
  }

  interface OfflineDeactivateResponse {
    deactivatedAt: string;
  }

  // === File handling utilities for air-gapped codes ===

  // Load code from a file (supports .txt and .json with { value: "..." } format)
  function loadCodeFromFile(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const content = (e.target?.result as string) || "";
          // Try parsing as JSON first
          try {
            const json = JSON.parse(content);
            if (json.value && typeof json.value === "string") {
              resolve(json.value.trim());
              return;
            }
          } catch {
            // Not JSON, treat as plain text
          }
          // Plain text - trim and normalize
          resolve(content.trim().replace(/\r\n/g, "\n").replace(/\n/g, ""));
        } catch (err) {
          reject(new Error("Failed to read file"));
        }
      };
      reader.onerror = () => reject(new Error("Failed to read file"));
      reader.readAsText(file);
    });
  }

  // Download a code as a JSON file
  function downloadCodeAsFile(
    code: string,
    type: "activation_package" | "lease_refresh_response",
    deviceId?: string,
  ) {
    const now = new Date();
    const timestamp = now
      .toISOString()
      .slice(0, 16)
      .replace(/[-:T]/g, "")
      .replace(/(\d{8})(\d{4})/, "$1-$2");
    const devicePart = deviceId ? `-${deviceId.slice(0, 16)}` : "";
    const filename =
      type === "activation_package"
        ? `lightlane-activation-package${devicePart}-${timestamp}.json`
        : `lightlane-lease-response${devicePart}-${timestamp}.json`;

    const data = {
      type,
      createdAt: now.toISOString(),
      value: code,
      notes:
        type === "activation_package"
          ? "Paste the 'value' field into the LightLane desktop app to complete activation"
          : "Paste the 'value' field into the LightLane desktop app to refresh the lease",
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], {
      type: "application/json",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Setup file input handler for a textarea
  function setupFileLoader(
    buttonId: string,
    inputId: string,
    textareaId: string,
    onLoad?: () => void,
  ) {
    const btn = document.getElementById(buttonId);
    const input = document.getElementById(inputId) as HTMLInputElement;
    const textarea = document.getElementById(textareaId) as HTMLTextAreaElement;

    if (!btn || !input || !textarea) return;

    btn.addEventListener("click", () => input.click());

    input.addEventListener("change", async () => {
      const file = input.files?.[0];
      if (!file) return;

      try {
        const code = await loadCodeFromFile(file);
        textarea.value = code;
        // Trigger input event to update validation/preview
        textarea.dispatchEvent(new Event("input", { bubbles: true }));
        if (onLoad) onLoad();
      } catch (err) {
        console.error("Failed to load file:", err);
      }

      // Reset input so same file can be loaded again
      input.value = "";
    });
  }

  // Show/hide section based on whether user has subscription entitlements
  function renderAirgappedSection() {
    const section = document.getElementById("airgapped-section");
    if (!section) return;

    // Only show for customers with active subscription entitlements (non-lifetime, lease-required)
    const subscriptionEnts = entitlements.filter(
      (e) => isActiveEntitlement(e) && !e.isLifetime && e.leaseRequired,
    );

    if (subscriptionEnts.length > 0) {
      section.classList.remove("hidden");

      // Populate entitlement dropdown for provision panel
      const provSelect = document.getElementById(
        "ag-prov-entitlement",
      ) as HTMLSelectElement;
      if (provSelect) {
        provSelect.innerHTML =
          '<option value="">Select subscription...</option>';
        subscriptionEnts.forEach((ent) => {
          const linkedCount = getLinkedDeviceCount(ent.id);
          const opt = document.createElement("option");
          opt.value = ent.id.toString();
          opt.textContent = `${formatTier(ent.tier)} (${linkedCount}/${ent.maxDevices} devices)`;
          provSelect.appendChild(opt);
        });
      }
    } else {
      section.classList.add("hidden");
    }
  }

  // Tab switching
  function setupAirgappedTabs() {
    const tabs = ["provision", "refresh", "deactivate"];
    tabs.forEach((tabName) => {
      const tab = document.getElementById(`ag-tab-${tabName}`);
      if (tab) {
        tab.addEventListener("click", () => {
          // Update tab states
          tabs.forEach((t) => {
            const tabEl = document.getElementById(`ag-tab-${t}`);
            const panelEl = document.getElementById(`ag-panel-${t}`);
            if (tabEl && panelEl) {
              if (t === tabName) {
                tabEl.classList.add("tab-active");
                panelEl.classList.remove("hidden");
              } else {
                tabEl.classList.remove("tab-active");
                panelEl.classList.add("hidden");
              }
            }
          });
        });
      }
    });
  }

  // Update provision button state
  function updateAgProvBtn() {
    const entId = (
      document.getElementById("ag-prov-entitlement") as HTMLSelectElement
    )?.value;
    const setupCode = (
      document.getElementById("ag-prov-setup-code") as HTMLTextAreaElement
    )?.value.trim();
    const btn = document.getElementById("ag-prov-btn") as HTMLButtonElement;
    if (btn) {
      btn.disabled = !entId || !setupCode;
    }
  }

  // Update refresh button state
  function updateAgRefreshBtn() {
    const requestCode = (
      document.getElementById("ag-refresh-request-code") as HTMLTextAreaElement
    )?.value.trim();
    const btn = document.getElementById("ag-refresh-btn") as HTMLButtonElement;
    if (btn) {
      btn.disabled = !requestCode;
    }
  }

  // Update deactivate button state
  function updateAgDeactBtn() {
    const deactCode = (
      document.getElementById("ag-deact-code") as HTMLTextAreaElement
    )?.value.trim();
    const btn = document.getElementById("ag-deact-btn") as HTMLButtonElement;
    if (btn) {
      btn.disabled = !deactCode;
    }
  }

  // Setup event listeners for input changes
  document
    .getElementById("ag-prov-entitlement")
    ?.addEventListener("change", updateAgProvBtn);
  document
    .getElementById("ag-prov-setup-code")
    ?.addEventListener("input", updateAgProvBtn);
  document
    .getElementById("ag-refresh-request-code")
    ?.addEventListener("input", () => {
      updateAgRefreshBtn();
      updateRefreshPreview();
    });
  document.getElementById("ag-deact-code")?.addEventListener("input", () => {
    updateAgDeactBtn();
    updateDeactivatePreview();
  });

  // Update refresh code preview panel
  function updateRefreshPreview() {
    const code = (
      document.getElementById("ag-refresh-request-code") as HTMLTextAreaElement
    )?.value.trim();
    const previewEl = document.getElementById("ag-refresh-preview");
    const contentEl = document.getElementById("ag-refresh-preview-content");
    if (!previewEl || !contentEl) return;

    if (!code) {
      previewEl.classList.add("hidden");
      return;
    }

    const decoded = tryDecodeCode(code);
    if (decoded.ok) {
      const data = decoded.data;
      // Build preview string with available fields
      const parts: string[] = [];
      if (data.type) parts.push(`Type: ${data.type}`);
      if (data.deviceId)
        parts.push(`Device: ${String(data.deviceId).slice(0, 16)}...`);
      if (data.entitlementId) parts.push(`Entitlement: ${data.entitlementId}`);
      if (data.iat)
        parts.push(`Issued: ${new Date(String(data.iat)).toLocaleString()}`);
      contentEl.textContent = parts.join(" | ");
      previewEl.classList.remove("hidden");
    } else {
      previewEl.classList.add("hidden");
    }
  }

  // Update deactivation code preview panel
  function updateDeactivatePreview() {
    const code = (
      document.getElementById("ag-deact-code") as HTMLTextAreaElement
    )?.value.trim();
    const previewEl = document.getElementById("ag-deact-preview");
    const contentEl = document.getElementById("ag-deact-preview-content");
    if (!previewEl || !contentEl) return;

    if (!code) {
      previewEl.classList.add("hidden");
      return;
    }

    const decoded = tryDecodeCode(code);
    if (decoded.ok) {
      const data = decoded.data;
      // Build preview string with available fields
      const parts: string[] = [];
      if (data.type) parts.push(`Type: ${data.type}`);
      if (data.deviceId)
        parts.push(`Device: ${String(data.deviceId).slice(0, 16)}...`);
      if (data.entitlementId) parts.push(`Entitlement: ${data.entitlementId}`);
      if (data.iat)
        parts.push(`Issued: ${new Date(String(data.iat)).toLocaleString()}`);
      contentEl.textContent = parts.join(" | ");
      previewEl.classList.remove("hidden");
    } else {
      previewEl.classList.add("hidden");
    }
  }

  // Base64URL validation regex (no padding, URL-safe chars only)
  const BASE64URL_REGEX = /^[A-Za-z0-9_-]+$/;

  // Validate a base64url code and return error message if invalid
  function validateBase64UrlCode(
    code: string,
    fieldName: string,
  ): string | null {
    if (!code || !code.trim()) {
      return `Please paste the ${fieldName} from your air-gapped machine`;
    }
    const trimmed = code.trim();
    if (trimmed.length < 20) {
      return `${fieldName} is too short - check you copied the complete code`;
    }
    if (trimmed.length > 50000) {
      return `${fieldName} is too large`;
    }
    if (!BASE64URL_REGEX.test(trimmed)) {
      return `Invalid ${fieldName} format - must be a base64url encoded string`;
    }
    return null;
  }

  // Try to decode and parse a base64url JSON code for preview
  function tryDecodeCode(
    code: string,
  ): { ok: true; data: Record<string, unknown> } | { ok: false } {
    try {
      const trimmed = code.trim();
      if (!BASE64URL_REGEX.test(trimmed)) return { ok: false };
      // Decode base64url to string
      const decoded = atob(trimmed.replace(/-/g, "+").replace(/_/g, "/"));
      const data = JSON.parse(decoded);
      if (typeof data !== "object" || data === null) return { ok: false };
      return { ok: true, data };
    } catch {
      return { ok: false };
    }
  }

  // Map backend error codes to user-friendly messages
  function mapAirgapError(err: unknown): string {
    const errObj = err as { code?: string; message?: string };
    const code = errObj?.code || "";
    const message = errObj?.message || "An error occurred";

    // Map specific error codes to friendly messages
    const errorMap: Record<string, string> = {
      VALIDATION_ERROR: message.includes("required")
        ? "Missing required field - please check your input"
        : "Invalid input format",
      INVALID_SETUP_CODE: "Invalid device setup code format or structure",
      INVALID_REQUEST_CODE: "Invalid refresh request code format or structure",
      INVALID_DEACTIVATION_CODE:
        "Invalid deactivation code format or structure",
      INVALID_PUBLIC_KEY:
        "The device public key in the code is invalid or corrupted",
      SIGNATURE_VERIFICATION_FAILED:
        "Signature verification failed - the code may be corrupted or tampered",
      REPLAY_REJECTED: "This code has already been used (replay rejected)",
      DEVICE_NOT_FOUND: "Device not found - it may not be registered yet",
      DEVICE_NOT_OWNED: "Device is not registered to your account",
      DEVICE_NOT_BOUND:
        "Device is not bound to this entitlement - provision it first",
      ENTITLEMENT_NOT_FOUND: "Entitlement not found",
      ENTITLEMENT_NOT_ACTIVE: "Entitlement is not active",
      MAX_DEVICES_EXCEEDED:
        "Maximum devices reached - deactivate another device first",
      LIFETIME_NOT_SUPPORTED:
        "Lifetime licenses do not support offline activation",
    };

    // Check if error message contains JSON parse garbage and sanitize
    if (
      message.includes("JSON") ||
      message.includes("Unexpected token") ||
      message.includes("SyntaxError")
    ) {
      return "Invalid code format - not a valid encoded code";
    }

    return errorMap[code] || message;
  }

  // Provision device handler
  document
    .getElementById("ag-prov-btn")
    ?.addEventListener("click", async () => {
      const entId = (
        document.getElementById("ag-prov-entitlement") as HTMLSelectElement
      ).value;
      const setupCode = (
        document.getElementById("ag-prov-setup-code") as HTMLTextAreaElement
      ).value.trim();

      const btn = document.getElementById("ag-prov-btn") as HTMLButtonElement;
      const btnText = document.getElementById("ag-prov-btn-text")!;
      const btnLoad = document.getElementById("ag-prov-btn-loading")!;
      const errorEl = document.getElementById("ag-prov-error")!;
      const errorText = document.getElementById("ag-prov-error-text")!;

      // Client-side validation
      if (!entId) {
        errorText.textContent = "Please select an entitlement";
        errorEl.classList.remove("hidden");
        return;
      }

      const validationError = validateBase64UrlCode(
        setupCode,
        "Device Setup Code",
      );
      if (validationError) {
        errorText.textContent = validationError;
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      btnText.classList.add("hidden");
      btnLoad.classList.remove("hidden");
      btn.disabled = true;

      try {
        const data = await portalFetch<OfflineProvisionResponse>(
          "/api/licence/offline-provision",
          {
            method: "POST",
            body: JSON.stringify({
              entitlementId: parseInt(entId, 10),
              deviceSetupCode: setupCode,
            }),
          },
        );

        // Show result
        document.getElementById("ag-prov-result")!.classList.remove("hidden");
        (
          document.getElementById("ag-prov-output") as HTMLTextAreaElement
        ).value = data.activationPackage;

        // Show expiry
        const expiry = new Date(data.leaseExpiresAt);
        const daysLeft = Math.round(
          (expiry.getTime() - Date.now()) / (1000 * 60 * 60 * 24),
        );
        document.getElementById("ag-prov-expiry")!.textContent =
          `Valid for ${daysLeft} days`;

        // Hide form elements
        (document.getElementById("ag-prov-entitlement") as HTMLSelectElement)
          .closest(".form-control")!
          .classList.add("hidden");
        (document.getElementById("ag-prov-setup-code") as HTMLTextAreaElement)
          .closest(".form-control")!
          .classList.add("hidden");
        btn.classList.add("hidden");

        // Reload data to show new device
        await loadAllData();
      } catch (err) {
        errorText.textContent = mapAirgapError(err);
        errorEl.classList.remove("hidden");
      } finally {
        btnText.classList.remove("hidden");
        btnLoad.classList.add("hidden");
        btn.disabled = false;
      }
    });

  // Copy activation package
  document
    .getElementById("ag-prov-copy-btn")
    ?.addEventListener("click", async () => {
      const output = document.getElementById(
        "ag-prov-output",
      ) as HTMLTextAreaElement;
      const btn = document.getElementById(
        "ag-prov-copy-btn",
      ) as HTMLButtonElement;
      try {
        await navigator.clipboard.writeText(output.value);
        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Copied!</span>`;
        btn.classList.remove("btn-accent");
        btn.classList.add("btn-success");
        setTimeout(() => {
          btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg><span>Copy</span>`;
          btn.classList.remove("btn-success");
          btn.classList.add("btn-accent");
        }, 2000);
      } catch {
        output.select();
        document.execCommand("copy");
      }
    });

  // Reset provision panel
  document
    .getElementById("ag-prov-reset-btn")
    ?.addEventListener("click", () => {
      document.getElementById("ag-prov-result")!.classList.add("hidden");
      (
        document.getElementById("ag-prov-entitlement") as HTMLSelectElement
      ).value = "";
      (
        document.getElementById("ag-prov-setup-code") as HTMLTextAreaElement
      ).value = "";
      (document.getElementById("ag-prov-output") as HTMLTextAreaElement).value =
        "";

      // Show form elements again
      (document.getElementById("ag-prov-entitlement") as HTMLSelectElement)
        .closest(".form-control")!
        .classList.remove("hidden");
      (document.getElementById("ag-prov-setup-code") as HTMLTextAreaElement)
        .closest(".form-control")!
        .classList.remove("hidden");
      document.getElementById("ag-prov-btn")!.classList.remove("hidden");
      document.getElementById("ag-prov-error")!.classList.add("hidden");
      updateAgProvBtn();
    });

  // Lease refresh handler
  document
    .getElementById("ag-refresh-btn")
    ?.addEventListener("click", async () => {
      const requestCode = (
        document.getElementById(
          "ag-refresh-request-code",
        ) as HTMLTextAreaElement
      ).value.trim();

      const btn = document.getElementById(
        "ag-refresh-btn",
      ) as HTMLButtonElement;
      const btnText = document.getElementById("ag-refresh-btn-text")!;
      const btnLoad = document.getElementById("ag-refresh-btn-loading")!;
      const errorEl = document.getElementById("ag-refresh-error")!;
      const errorText = document.getElementById("ag-refresh-error-text")!;

      // Client-side validation
      const validationError = validateBase64UrlCode(
        requestCode,
        "Lease Refresh Request Code",
      );
      if (validationError) {
        errorText.textContent = validationError;
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      btnText.classList.add("hidden");
      btnLoad.classList.remove("hidden");
      btn.disabled = true;

      try {
        const data = await portalFetch<OfflineLeaseRefreshResponse>(
          "/api/licence/offline-lease-refresh",
          {
            method: "POST",
            body: JSON.stringify({ requestCode }),
          },
        );

        // Show result
        document
          .getElementById("ag-refresh-result")!
          .classList.remove("hidden");
        (
          document.getElementById("ag-refresh-output") as HTMLTextAreaElement
        ).value = data.refreshResponseCode;

        // Show expiry
        const expiry = new Date(data.leaseExpiresAt);
        const daysLeft = Math.round(
          (expiry.getTime() - Date.now()) / (1000 * 60 * 60 * 24),
        );
        document.getElementById("ag-refresh-expiry")!.textContent =
          `Valid for ${daysLeft} days`;

        // Hide form elements
        (
          document.getElementById(
            "ag-refresh-request-code",
          ) as HTMLTextAreaElement
        )
          .closest(".form-control")!
          .classList.add("hidden");
        btn.classList.add("hidden");
      } catch (err) {
        errorText.textContent = mapAirgapError(err);
        errorEl.classList.remove("hidden");
      } finally {
        btnText.classList.remove("hidden");
        btnLoad.classList.add("hidden");
        btn.disabled = false;
      }
    });

  // Copy refresh response code
  document
    .getElementById("ag-refresh-copy-btn")
    ?.addEventListener("click", async () => {
      const output = document.getElementById(
        "ag-refresh-output",
      ) as HTMLTextAreaElement;
      const btn = document.getElementById(
        "ag-refresh-copy-btn",
      ) as HTMLButtonElement;
      try {
        await navigator.clipboard.writeText(output.value);
        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Copied!</span>`;
        btn.classList.remove("btn-accent");
        btn.classList.add("btn-success");
        setTimeout(() => {
          btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg><span>Copy</span>`;
          btn.classList.remove("btn-success");
          btn.classList.add("btn-accent");
        }, 2000);
      } catch {
        output.select();
        document.execCommand("copy");
      }
    });

  // Reset refresh panel
  document
    .getElementById("ag-refresh-reset-btn")
    ?.addEventListener("click", () => {
      document.getElementById("ag-refresh-result")!.classList.add("hidden");
      (
        document.getElementById(
          "ag-refresh-request-code",
        ) as HTMLTextAreaElement
      ).value = "";
      (
        document.getElementById("ag-refresh-output") as HTMLTextAreaElement
      ).value = "";

      // Show form elements again
      (
        document.getElementById(
          "ag-refresh-request-code",
        ) as HTMLTextAreaElement
      )
        .closest(".form-control")!
        .classList.remove("hidden");
      document.getElementById("ag-refresh-btn")!.classList.remove("hidden");
      document.getElementById("ag-refresh-error")!.classList.add("hidden");
      updateAgRefreshBtn();
    });

  // Deactivate handler
  document
    .getElementById("ag-deact-btn")
    ?.addEventListener("click", async () => {
      const deactCode = (
        document.getElementById("ag-deact-code") as HTMLTextAreaElement
      ).value.trim();

      const btn = document.getElementById("ag-deact-btn") as HTMLButtonElement;
      const btnText = document.getElementById("ag-deact-btn-text")!;
      const btnLoad = document.getElementById("ag-deact-btn-loading")!;
      const errorEl = document.getElementById("ag-deact-error")!;
      const errorText = document.getElementById("ag-deact-error-text")!;

      // Client-side validation
      const validationError = validateBase64UrlCode(
        deactCode,
        "Deactivation Code",
      );
      if (validationError) {
        errorText.textContent = validationError;
        errorEl.classList.remove("hidden");
        return;
      }

      errorEl.classList.add("hidden");
      btnText.classList.add("hidden");
      btnLoad.classList.remove("hidden");
      btn.disabled = true;

      try {
        await portalFetch<OfflineDeactivateResponse>(
          "/api/licence/offline-deactivate",
          {
            method: "POST",
            body: JSON.stringify({ deactivationCode: deactCode }),
          },
        );

        // Show result
        document.getElementById("ag-deact-result")!.classList.remove("hidden");

        // Hide form elements
        (document.getElementById("ag-deact-code") as HTMLTextAreaElement)
          .closest(".form-control")!
          .classList.add("hidden");
        btn.classList.add("hidden");

        // Reload data to reflect removed device
        await loadAllData();
      } catch (err) {
        errorText.textContent = mapAirgapError(err);
        errorEl.classList.remove("hidden");
      } finally {
        btnText.classList.remove("hidden");
        btnLoad.classList.add("hidden");
        btn.disabled = false;
      }
    });

  // Reset deactivate panel
  document
    .getElementById("ag-deact-reset-btn")
    ?.addEventListener("click", () => {
      document.getElementById("ag-deact-result")!.classList.add("hidden");
      (document.getElementById("ag-deact-code") as HTMLTextAreaElement).value =
        "";

      // Show form elements again
      (document.getElementById("ag-deact-code") as HTMLTextAreaElement)
        .closest(".form-control")!
        .classList.remove("hidden");
      document.getElementById("ag-deact-btn")!.classList.remove("hidden");
      document.getElementById("ag-deact-error")!.classList.add("hidden");
      updateAgDeactBtn();
    });

  // Initialize air-gapped tabs
  setupAirgappedTabs();

  // Setup file loaders for air-gapped code inputs
  setupFileLoader(
    "ag-prov-load-file-btn",
    "ag-prov-file-input",
    "ag-prov-setup-code",
    updateAgProvBtn,
  );
  setupFileLoader(
    "ag-refresh-load-file-btn",
    "ag-refresh-file-input",
    "ag-refresh-request-code",
    () => {
      updateAgRefreshBtn();
      updateRefreshPreview();
    },
  );
  setupFileLoader(
    "ag-deact-load-file-btn",
    "ag-deact-file-input",
    "ag-deact-code",
    () => {
      updateAgDeactBtn();
      updateDeactivatePreview();
    },
  );

  // Download activation package handler
  document
    .getElementById("ag-prov-download-btn")
    ?.addEventListener("click", () => {
      const output = (
        document.getElementById("ag-prov-output") as HTMLTextAreaElement
      )?.value;
      if (!output) return;
      // Try to extract deviceId from the setup code input for filename
      const setupCode = (
        document.getElementById("ag-prov-setup-code") as HTMLTextAreaElement
      )?.value;
      let deviceId: string | undefined;
      if (setupCode) {
        const decoded = tryDecodeCode(setupCode);
        if (decoded.ok && decoded.data.deviceId) {
          deviceId = String(decoded.data.deviceId);
        }
      }
      downloadCodeAsFile(output, "activation_package", deviceId);
    });

  // Download lease refresh response handler
  document
    .getElementById("ag-refresh-download-btn")
    ?.addEventListener("click", () => {
      const output = (
        document.getElementById("ag-refresh-output") as HTMLTextAreaElement
      )?.value;
      if (!output) return;
      // Try to extract deviceId from the request code for filename
      const requestCode = (
        document.getElementById(
          "ag-refresh-request-code",
        ) as HTMLTextAreaElement
      )?.value;
      let deviceId: string | undefined;
      if (requestCode) {
        const decoded = tryDecodeCode(requestCode);
        if (decoded.ok && decoded.data.deviceId) {
          deviceId = String(decoded.data.deviceId);
        }
      }
      downloadCodeAsFile(output, "lease_refresh_response", deviceId);
    });

  // === Refresh button ===
  document
    .getElementById("refresh-data-btn")
    ?.addEventListener("click", async () => {
      const btn = document.getElementById(
        "refresh-data-btn",
      ) as HTMLButtonElement;
      btn.classList.add("loading", "btn-disabled");
      await loadAllData();
      btn.classList.remove("loading", "btn-disabled");
    });

  // === Init ===
  // Check for refresh flag from success page
  const needsRefresh = localStorage.getItem("portalNeedsRefresh");
  if (needsRefresh) {
    localStorage.removeItem("portalNeedsRefresh");
  }

  // Also check URL param
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has("refresh")) {
    // Clean up URL
    const url = new URL(window.location.href);
    url.searchParams.delete("refresh");
    window.history.replaceState({}, "", url.pathname);
  }

  // Always load fresh data
  loadAllData();
</script>
