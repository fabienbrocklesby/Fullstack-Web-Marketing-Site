---
import Layout from "../layouts/Layout.astro";
import Footer from "../components/Footer.astro";
import DownloadButtons from "../components/DownloadButtons.astro";
import Icon from "../components/icons/Icon.astro";
---

<Layout
  title="Success - Subscription Started"
  description="Welcome to Light Lane!"
>
  <!-- Header rendered by Layout.astro -->

  <main>
    <section class="py-20">
      <div class="container mx-auto px-4">
        <div class="text-center max-w-2xl mx-auto">
          <div class="flex justify-center mb-8">
            <div
              class="w-16 h-16 rounded-2xl bg-success/10 text-success flex items-center justify-center"
            >
              <Icon name="sparkles" class="w-9 h-9" ariaLabel="Success" />
            </div>
          </div>
          <h1 class="text-4xl font-bold mb-4">Subscription Started!</h1>
          <p class="text-xl text-base-content/70 mb-6">
            Welcome to Light Lane. Download the app below and sign in to start
            using all features. Manage your subscription anytime in your
            dashboard.
          </p>
          <div class="mb-8">
            <DownloadButtons align="center" />
          </div>
          <div class="space-y-4">
            <p class="text-base-content/70">
              Need help? Visit your dashboard or contact support.
            </p>
            <div class="flex justify-center space-x-4">
              <a href="/" class="btn btn-primary">Back to Home</a>
              <a href="/contact" class="btn btn-outline">Contact Support</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  // Auto-create purchase record for development
  document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get("session_id");
    const priceId = urlParams.get("price_id");
    const amount = urlParams.get("amount");

    if (sessionId && priceId && amount) {
      try {
        console.log("[Purchase] Creating purchase record for session:", sessionId);

        const inlineIcon = (path: string) =>
          `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"inline-block w-4 h-4 mr-1 align-text-bottom\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"${path}\"></path></svg>`;

        const fileIcon = inlineIcon(
          "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8",
        );
        const coinsIcon = inlineIcon(
          "M3 6c0 1.1 2.7 2 6 2s6-.9 6-2-2.7-2-6-2-6 .9-6 2z M3 12c0 1.1 2.7 2 6 2s6-.9 6-2 M3 18c0 1.1 2.7 2 6 2s6-.9 6-2",
        );
        const warningIcon = inlineIcon(
          "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z",
        );

        const cmsUrl =
          document.documentElement.getAttribute("data-cms-url") ||
          "http://localhost:1337";

        // Get affiliate code from cookies (same as BuyButton)
        const getCookie = (name: string) => {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop()?.split(";").shift();
        };

        const affiliateCode = getCookie("affiliate_code");

        const response = await fetch(`${cmsUrl}/api/dev/create-purchase`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            sessionId: sessionId,
            amount: parseInt(amount) / 100, // Convert from cents to dollars
            priceId: priceId,
            affiliateCode: affiliateCode,
            // Note: customerEmail will be fetched from Stripe session by backend
          }),
        });

        if (response.ok) {
          const result = await response.json();
          console.log("[Purchase] Purchase record created:", result);

          // Show success message with purchase details
          const purchaseInfo = document.createElement("div");
          purchaseInfo.className = "alert alert-success mt-4";
          purchaseInfo.innerHTML = `
            <div>
              <h3>${fileIcon}Purchase Details</h3>
              <p><strong>Session ID:</strong> ${sessionId}</p>
              <p><strong>Amount:</strong> $${result.purchase.amount}</p>
              <p><strong>Product:</strong> ${priceId}</p>
              <p><strong>Customer Email:</strong> ${result.purchase.customerEmail}</p>
            </div>
          `;

          // Show affiliate info if applicable
          if (result.affiliate) {
            const affiliateInfo = document.createElement("div");
            affiliateInfo.className = "alert alert-info mt-4";
            affiliateInfo.innerHTML = `
              <div>
                <h3>${coinsIcon}Affiliate Credit Applied!</h3>
                <p>Affiliate <strong>${result.affiliate.name}</strong> (${result.affiliate.code}) will receive a commission of $${result.purchase.commissionAmount}.</p>
              </div>
            `;
            document.querySelector(".text-center")?.appendChild(affiliateInfo);
          }

          document.querySelector(".text-center")?.appendChild(purchaseInfo);
        } else {
          const error = await response.json();
          console.error("[Purchase] Failed to create purchase record:", error);

          const errorInfo = document.createElement("div");
          errorInfo.className = "alert alert-warning mt-4";
          errorInfo.innerHTML = `
            <div>
              <h3>${warningIcon}Note</h3>
              <p>Your payment was successful, but we couldn't automatically create the purchase record. Please contact support with session ID: ${sessionId}</p>
            </div>
          `;
          document.querySelector(".text-center")?.appendChild(errorInfo);
        }
      } catch (error) {
        console.error("[Purchase] Error creating purchase record:", error);
      }
    } else {
      console.log("[Purchase] No session details found in URL");
    }
  });
</script>
