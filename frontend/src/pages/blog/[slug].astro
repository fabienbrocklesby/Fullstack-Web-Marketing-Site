---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getAllPosts, getPostBySlug, type Post } from "../../lib/strapi";

// Disable full static prerender so we can serve on-demand if Strapi wasn't reachable at build time
export const prerender = false;

export async function getStaticPaths() {
  try {
    const posts = await getAllPosts();
    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (e) {
    // If Strapi is down during build, return no paths; runtime will fetch (SSR)
    return [];
  }
}

// Prefer the statically provided post, otherwise fetch at runtime (SSR) using the slug param
let currentPost: Post | null = (Astro.props as any)?.post || null;
if (!currentPost) {
  const { slug } = Astro.params;
  if (slug) {
    try {
      currentPost = await getPostBySlug(slug);
    } catch {
      currentPost = null;
    }
  }
}

// Helper for meta description + reading time + formatted date
function strip(html: string) {
  return html
    .replace(/<script[\s\S]*?<\/script>/gi, "")
    .replace(/<style[\s\S]*?<\/style>/gi, "")
    .replace(/<[^>]+>/g, " ")
    .replace(/&nbsp;/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
const metaDescription = currentPost
  ? strip(currentPost.content).slice(0, 160)
  : "Post not found";
const wordCount = currentPost
  ? strip(currentPost.content).split(/\s+/).filter(Boolean).length
  : 0;
const readingMinutes = wordCount ? Math.max(1, Math.round(wordCount / 200)) : 0;
const displayDate = currentPost
  ? new Date(currentPost.date).toLocaleDateString(undefined, {
      year: "numeric",
      month: "long",
      day: "numeric",
    })
  : "";
const fallbackSite = new URL("https://lightlane.app");
const siteBase = Astro.site ?? fallbackSite;
const toAbsolute = (path: string) => new URL(path, siteBase).href;
const organizationId = `${toAbsolute("/")}#organization`;
const blogKeywords = currentPost
  ? ([
      currentPost.title,
      "laser engraving software blog",
      "Lightlane product updates",
      currentPost.author ? `${currentPost.author} Lightlane` : undefined,
    ].filter(Boolean) as string[])
  : ["laser engraving software blog", "Lightlane blog"];

const structuredData = currentPost
  ? [
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "@id": `${Astro.url.href}#article`,
        mainEntityOfPage: { "@type": "WebPage", "@id": Astro.url.href },
        headline: currentPost.seoTitle || currentPost.title,
        description: currentPost.seoDescription || metaDescription,
        image: currentPost.coverImageUrl
          ? [currentPost.coverImageUrl]
          : [toAbsolute("/og-lightlane.png")],
        author: {
          "@type": "Person",
          name: currentPost.author || "Lightlane Editorial",
        },
        datePublished: currentPost.date,
        dateModified: currentPost.date,
        wordCount,
        publisher: { "@id": organizationId },
        keywords: blogKeywords.join(", "),
      },
    ]
  : [];
---

<Layout
  title={currentPost
    ? currentPost.seoTitle || `${currentPost.title} - Blog`
    : "Post not found"}
  description={currentPost
    ? currentPost.seoDescription || metaDescription
    : metaDescription}
  image={currentPost?.coverImageUrl || undefined}
  canonical={currentPost?.canonical
    ? Astro.site
      ? new URL(currentPost.canonical, Astro.site).href
      : currentPost.canonical
    : Astro.url.href}
  ogType={currentPost ? "article" : "website"}
  keywords={blogKeywords.join(", ")}
  structuredData={structuredData}
  breadcrumbs={currentPost
    ? [
        { name: "Home", url: "/" },
        { name: "Blog", url: "/blog" },
        { name: currentPost.title, url: `/blog/${currentPost.slug}` },
      ]
    : undefined}
>
  <Header />

  <main>
    {
      currentPost ? (
        <>
          {/* Reading Progress Bar */}
          <div
            id="reading-progress"
            role="progressbar"
            aria-label="Reading progress"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="0"
            class="fixed top-0 left-0 w-full h-1.5 bg-base-300/40 backdrop-blur z-50"
          >
            <div
              data-progress-bar
              class="h-full w-0 bg-primary transition-[width] duration-100 ease-linear"
            />
          </div>
          <section class="relative">
            <div class="hero min-h-[50vh]">
              <div class="absolute inset-0 overflow-hidden">
                {currentPost.coverImageUrl ? (
                  <>
                    <img
                      src={currentPost.coverImageUrl}
                      alt={currentPost.coverImageAlt || currentPost.title}
                      class="w-full h-full object-cover"
                    />
                    <div class="absolute inset-0 bg-gradient-to-b from-base-100/10 via-base-100/70 to-base-100" />
                  </>
                ) : (
                  <div class="absolute inset-0 bg-gradient-to-br from-primary/20 via-secondary/10 to-base-100" />
                )}
              </div>
              <div class="hero-content relative z-10 w-full max-w-5xl mx-auto px-4 py-24">
                <div class="w-full flex flex-col items-center text-center gap-8">
                  <nav class="breadcrumbs text-xs sm:text-sm opacity-80 -mt-4 hidden sm:flex">
                    <ul>
                      <li>
                        <a href="/">Home</a>
                      </li>
                      <li>
                        <a href="/blog">Blog</a>
                      </li>
                      <li>
                        {currentPost.title.length > 40
                          ? currentPost.title.slice(0, 40) + "…"
                          : currentPost.title}
                      </li>
                    </ul>
                  </nav>
                  <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight leading-tight bg-gradient-to-br from-base-content to-base-content/70 bg-clip-text text-transparent">
                    {currentPost.title}
                  </h1>
                  <div class="flex flex-col sm:flex-row sm:flex-wrap justify-center items-center gap-3 sm:gap-6 text-xs sm:text-sm text-base-content/70">
                    {currentPost.author && (
                      <span class="inline-flex items-center gap-2">
                        <span class="status status-success" />
                        {currentPost.author}
                      </span>
                    )}
                    {displayDate && <span>{displayDate}</span>}
                    {readingMinutes > 0 && (
                      <span>{readingMinutes} min read</span>
                    )}
                    <span>{wordCount} words</span>
                  </div>
                  <div class="h-px w-28 bg-gradient-to-r from-transparent via-base-content/30 to-transparent" />
                  <div class="flex flex-wrap justify-center gap-3 pt-2">
                    <a
                      class="btn btn-sm btn-outline"
                      href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(currentPost.title)}&url=${encodeURIComponent(Astro.url.href)}`}
                      target="_blank"
                      rel="noopener"
                    >
                      Share
                    </a>
                    <a
                      class="btn btn-sm btn-outline"
                      href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
                      target="_blank"
                      rel="noopener"
                    >
                      LinkedIn
                    </a>
                    <button
                      class="btn btn-sm"
                      data-copy-link
                      aria-label="Copy link"
                    >
                      Copy Link
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <article class="relative z-10 -mt-12 pb-32">
            <div class="container mx-auto px-4 max-w-7xl">
              <div class="grid lg:grid-cols-[1fr_18rem] gap-12">
                <div>
                  <div class="card bg-base-100/80 backdrop-blur shadow-xl border border-base-300/50">
                    <div class="card-body px-6 md:px-10 py-10">
                      <div
                        class="article-content prose prose-lg max-w-none"
                        set:html={currentPost.content}
                      />
                    </div>
                  </div>
                  <div class="mt-10 flex flex-wrap gap-4">
                    <a href="/blog" class="btn btn-soft">
                      ← Back to Blog
                    </a>
                    <button class="btn btn-outline" data-scroll-top>
                      Back to top
                    </button>
                  </div>
                </div>
                <aside class="hidden lg:block">
                  <div class="sticky top-28 flex flex-col gap-6">
                    <div class="card bg-base-100 shadow border border-base-300/50">
                      <div class="card-body p-5">
                        <h2 class="card-title text-sm mb-2">On this page</h2>
                        <nav
                          id="toc"
                          class="text-sm space-y-2 max-h-[60vh] overflow-auto pr-1"
                        />
                      </div>
                    </div>
                    <div class="card bg-base-100 shadow border border-base-300/50">
                      <div class="card-body p-5">
                        <h2 class="card-title text-sm mb-3">Share</h2>
                        <div class="flex flex-col gap-2">
                          <a
                            class="btn btn-xs btn-outline"
                            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(currentPost.title)}&url=${encodeURIComponent(Astro.url.href)}`}
                            target="_blank"
                            rel="noopener"
                          >
                            Twitter / X
                          </a>
                          <a
                            class="btn btn-xs btn-outline"
                            href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`}
                            target="_blank"
                            rel="noopener"
                          >
                            LinkedIn
                          </a>
                          <button class="btn btn-xs btn-outline" data-copy-link>
                            Copy Link
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
          </article>
          <script
            is:inline
            set:html={`(function(){var root=document.querySelector('.article-content');var toc=document.getElementById('toc');if(root&&toc){var headings=Array.prototype.slice.call(root.querySelectorAll('h2, h3'));var items=headings.map(function(h){var id=h.id||h.textContent.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-');if(!h.id) h.id=id;var depth=h.tagName==='H3'?3:2;return {id:id,text:h.textContent,depth:depth};});if(items.length===0){var h1=root.querySelector('h1');if(h1&&!h1.id){h1.id=h1.textContent.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-');}if(h1){toc.innerHTML='<a class="block hover:text-primary transition" href="#'+h1.id+'">'+h1.textContent+'</a>';}else{toc.innerHTML='<p class="text-xs opacity-60">Add sub-headings (## in Markdown) to populate this table of contents.</p>';}}else{toc.innerHTML=items.map(function(i){return '<a class="block hover:text-primary transition '+(i.depth===3?'pl-4 opacity-80':'')+'" href="#'+i.id+'">'+i.text+'</a>';}).join('');}document.querySelectorAll('[data-copy-link]').forEach(function(btn){btn.addEventListener('click',function(){navigator.clipboard.writeText(window.location.href).then(function(){var original=btn.textContent;btn.textContent='Copied!';setTimeout(function(){btn.textContent=original;},1800);});});});document.querySelectorAll('[data-scroll-top]').forEach(function(btn){btn.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'});});});}var progressOuter=document.getElementById('reading-progress');var progressInner=progressOuter?progressOuter.querySelector('[data-progress-bar]'):null;function updateProgress(){if(!progressOuter||!progressInner)return;var doc=document.documentElement;var scrollTop=window.scrollY||doc.scrollTop;var maxScroll=doc.scrollHeight-window.innerHeight;var percent=0;if(maxScroll>0){percent=scrollTop/maxScroll*100;if(percent>100) percent=100;if(percent<0) percent=0;}else{percent=100;}progressInner.style.width=percent+'%';progressOuter.setAttribute('aria-valuenow',String(Math.round(percent)));}['scroll','resize','orientationchange'].forEach(function(evt){window.addEventListener(evt,updateProgress,{passive:true});});window.addEventListener('load',updateProgress);setTimeout(updateProgress,50);setTimeout(updateProgress,300);})();`}
          />
        </>
      ) : (
        <section class="py-32 text-center">
          <div class="container mx-auto px-4">
            <h1 class="text-4xl font-bold mb-6">Post not found</h1>
            <p class="mb-8 text-base-content/70">
              We couldn’t locate the blog post you were looking for. It may have
              been unpublished or the slug is incorrect.
            </p>
            <a href="/blog" class="btn btn-primary">
              Back to Blog
            </a>
          </div>
        </section>
      )
    }
  </main>

  <Footer />
</Layout>
