# LightLane App Integration Reference

**Document Version:** 1.0  
**Date:** 2026-01-23  
**Purpose:** Complete specification for implementing LightLane licensing in the desktop app, including online activation and air-gapped (offline) flows.

---

## A. What the App Must Implement (Scope)

### Online Activation Flow

1. **User signs in** → app obtains a customer JWT
2. **List entitlements** → display available subscriptions
3. **Register device** → register this machine with the backend
4. **Activate** → bind device to a chosen entitlement
5. **Periodic refresh** → renew lease tokens (subscriptions only)

### Offline (Air-Gapped) Activation Flow

1. **Generate device setup code** (app) → user transfers to portal
2. **Provision** (portal) → returns activation package
3. **Import activation package** (app) → app is now activated
4. **Periodic lease refresh** → app generates request code, user transfers to portal, portal returns response code
5. **Deactivation** → app generates deactivation code, user transfers to portal

### Key Constraints

- **Activation happens in the app.** The portal is for management and offline tooling only.
- **Offline lifetime is NOT supported.** Lifetime/founders entitlements (`isLifetime: true`) are online-only. All offline endpoints reject lifetime entitlements with `LIFETIME_NOT_SUPPORTED`.

---

## B. Terminology and Objects

| Term                           | Definition                                                                                                             |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------- |
| **Entitlement**                | A customer's right to use the software (subscription or lifetime). Has a tier, status, and device limit.               |
| **Device**                     | A registered machine identified by `deviceId` + `publicKey`. Bound to at most one entitlement at a time.               |
| **deviceId**                   | App-generated UUID. Persisted across installs.                                                                         |
| **publicKey**                  | Ed25519 public key (SPKI DER, base64). Required for air-gapped operations.                                             |
| **publicKeyHash**              | SHA256 hex hash of the SPKI DER bytes. Stored server-side for binding verification.                                    |
| **Lease Token**                | RS256 JWT proving active subscription. 7-day TTL by default.                                                           |
| **Challenge JWT**              | Short-lived RS256 JWT (10-minute TTL) for portal-to-portal offline refresh.                                            |
| **Activation Package**         | Base64url JSON containing activation token + lease token. Used for air-gapped initial activation.                      |
| **Device Setup Code**          | Base64url JSON generated by app. Contains deviceId, publicKey, metadata.                                               |
| **Lease Refresh Request Code** | Base64url JSON generated by app, Ed25519-signed. Contains deviceId, entitlementId, jti, iat, sig.                      |
| **Deactivation Code**          | Base64url JSON generated by app, Ed25519-signed. Same structure as refresh request but with `type: deactivation_code`. |
| **jti**                        | Unique identifier for replay protection.                                                                               |

---

## C. Config & Environment

### App-Required Configuration

| Name             | Purpose                                                                 | Example                                               |
| ---------------- | ----------------------------------------------------------------------- | ----------------------------------------------------- |
| `API_BASE_URL`   | Backend API base URL                                                    | `https://api.lightlane.io` or `http://localhost:1337` |
| `JWT_PUBLIC_KEY` | RS256 public key (PEM) for verifying lease tokens and activation tokens | See below                                             |

**RS256 Public Key:** The app must have access to the server's RS256 public key to verify lease token signatures locally. This key should be bundled with the app or fetched once at startup.

### Backend Environment Variables (Reference)

These are set server-side. The app does not need them directly but should understand their effect:

| Variable                         | Default             | Description                                           |
| -------------------------------- | ------------------- | ----------------------------------------------------- |
| `JWT_SECRET`                     | (required)          | HS256 key for customer auth tokens                    |
| `JWT_PRIVATE_KEY`                | (required)          | RS256 private key for signing lease/activation tokens |
| `JWT_PUBLIC_KEY`                 | (required)          | RS256 public key for verification                     |
| `JWT_ISSUER`                     | `lightlane`         | JWT issuer claim                                      |
| `LEASE_TOKEN_TTL_SECONDS`        | `604800` (7 days)   | Lease token validity                                  |
| `OFFLINE_ACTIVATION_TTL_SECONDS` | `259200` (72 hours) | Activation token validity                             |

### Local Development

For local dev against the website repo:

- Backend runs at `http://localhost:1337`
- Use the same `JWT_PUBLIC_KEY` configured in backend

---

## D. Auth Model

### Token Acquisition

1. User provides email + password
2. Call `POST /api/customers/login` (no auth required)
3. Response includes `{ customer: {...}, token: "<JWT>" }`
4. Store `token` securely

### Header Format

All authenticated endpoints require:

```
Authorization: Bearer <token>
```

### Token Claims (HS256)

```json
{
  "id": 123,
  "email": "user@example.com",
  "type": "customer",
  "iat": 1737547200,
  "exp": 1738152000
}
```

### Expected Error Patterns

| Status | Meaning                                            | Action                                |
| ------ | -------------------------------------------------- | ------------------------------------- |
| 401    | Token missing, invalid, or expired                 | Clear stored token, redirect to login |
| 403    | Authenticated but not authorized for this resource | Show error, do not clear token        |

---

## E. Endpoint Matrix (App Must Call)

### E.1 Customer Auth

#### Login

**`POST /api/customers/login`** — Unauthenticated

**Request:**

```json
{
  "email": "user@example.com",
  "password": "secret123"
}
```

**Response (200):**

```json
{
  "customer": {
    "id": 123,
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Doe",
    "isActive": true,
    "createdAt": "2025-01-01T00:00:00.000Z"
  },
  "token": "<HS256 JWT>"
}
```

**Errors:**
| Status | Message |
|--------|---------|
| 400 | `"Email and password are required"` |
| 400 | `"Invalid credentials"` |
| 400 | `"Account is deactivated"` |

---

### E.2 Entitlements

#### List Entitlements

**`GET /api/customers/me/entitlements`** — Requires `customer-auth`

**Response (200):**

```json
{
  "ok": true,
  "entitlements": [
    {
      "id": 123,
      "tier": "pro",
      "status": "active",
      "isLifetime": false,
      "leaseRequired": true,
      "maxDevices": 2,
      "expiresAt": "2026-12-31T23:59:59.000Z",
      "currentPeriodEnd": "2026-02-22T00:00:00.000Z",
      "cancelAtPeriodEnd": false,
      "source": "stripe",
      "createdAt": "2025-01-01T00:00:00.000Z",
      "licenseKey": {
        "id": 456,
        "key": "PRO-0123-ABCD-EFGH",
        "typ": "subscription",
        "isActive": true
      }
    }
  ],
  "meta": {
    "total": 1,
    "hasActiveEntitlement": true
  }
}
```

**Key Fields:**

- `isLifetime`: If `true`, no lease tokens needed (online-only verification)
- `leaseRequired`: Server-computed; `true` for subscriptions, `false` for lifetime
- `status`: `"active"`, `"inactive"`, `"canceled"`, `"expired"`, `"trialing"`, `"past_due"`

**Errors:**
| Status | Code | Message |
|--------|------|---------|
| 401 | N/A | `"Not authenticated"` |
| 500 | `INTERNAL_ERROR` | `"Failed to fetch entitlements"` |

---

### E.3 Device Management

#### Register Device

**`POST /api/device/register`** — Requires `customer-auth`

**Request:**

```json
{
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "publicKey": "<base64 Ed25519 SPKI DER>",
  "deviceName": "My Workstation",
  "platform": "windows"
}
```

| Field        | Required                     | Constraints                            |
| ------------ | ---------------------------- | -------------------------------------- |
| `deviceId`   | Yes                          | ≥3 chars, unique                       |
| `publicKey`  | No (required for air-gapped) | ≥32 chars if provided                  |
| `deviceName` | No                           | Human-readable                         |
| `platform`   | No                           | `windows`, `macos`, `linux`, `unknown` |

**Response (200):**

```json
{
  "ok": true,
  "data": {
    "deviceId": "550e8400-e29b-41d4-a716-446655440000",
    "status": "active",
    "message": "Device registered"
  }
}
```

**Errors:**
| Status | Code | Message |
|--------|------|---------|
| 400 | `VALIDATION_ERROR` | `"deviceId is required and must be at least 3 characters"` |
| 400 | `VALIDATION_ERROR` | `"If provided, publicKey must be at least 32 characters"` |
| 401 | `UNAUTHENTICATED` | `"Authentication required"` |
| 409 | `DEVICE_NOT_OWNED` | `"Device is registered to another account"` |

**Notes:**

- Idempotent: calling again with same deviceId updates the device
- `publicKey` should be provided if air-gapped activation will be used later

#### List Devices

**`GET /api/customers/me/devices`** — Requires `customer-auth`

**Response (200):**

```json
{
  "ok": true,
  "devices": [
    {
      "id": 789,
      "deviceId": "550e8400-e29b-41d4-a716-446655440000",
      "name": "My Workstation",
      "platform": "windows",
      "status": "active",
      "lastSeen": "2026-01-22T12:00:00.000Z",
      "isActivated": true,
      "entitlement": {
        "id": 123,
        "tier": "pro",
        "isLifetime": false
      }
    }
  ],
  "meta": {
    "total": 1,
    "activatedCount": 1
  }
}
```

---

### E.4 Online Activation

#### Activate

**`POST /api/licence/activate`** — Requires `customer-auth`

**Request:**

```json
{
  "entitlementId": 123,
  "deviceId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response (200):**

```json
{
  "ok": true,
  "data": {
    "message": "Device activated",
    "entitlement": {
      "id": 123,
      "tier": "pro",
      "status": "active",
      "isLifetime": false,
      "expiresAt": "2026-12-31T23:59:59.000Z",
      "currentPeriodEnd": "2026-02-22T00:00:00.000Z",
      "maxDevices": 2
    },
    "device": {
      "deviceId": "550e8400-e29b-41d4-a716-446655440000",
      "boundAt": "2026-01-22T12:00:00.000Z"
    }
  }
}
```

**Errors:**
| Status | Code | Message |
|--------|------|---------|
| 400 | `VALIDATION_ERROR` | `"entitlementId is required"` / `"deviceId is required"` |
| 401 | `UNAUTHENTICATED` | `"Authentication required"` |
| 403 | `FORBIDDEN` | `"You do not own this entitlement"` |
| 403 | `ENTITLEMENT_NOT_ACTIVE` | `"Entitlement is not active"` |
| 403 | `DEVICE_NOT_OWNED` | `"Device belongs to another customer"` |
| 404 | `ENTITLEMENT_NOT_FOUND` | `"Entitlement not found"` |
| 404 | `DEVICE_NOT_FOUND` | `"Device not registered"` |
| 409 | `MAX_DEVICES_EXCEEDED` | `"Maximum devices limit reached"` |

**Notes:**

- Idempotent: activating same device on same entitlement succeeds

#### Refresh (Online)

**`POST /api/licence/refresh`** — Requires `customer-auth`

**Request:**

```json
{
  "entitlementId": 123,
  "deviceId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response (200) — Subscription:**

```json
{
  "ok": true,
  "data": {
    "status": "active",
    "isLifetime": false,
    "expiresAt": "2026-12-31T23:59:59.000Z",
    "currentPeriodEnd": "2026-02-22T00:00:00.000Z",
    "serverTime": "2026-01-22T12:00:00.000Z",
    "leaseRequired": true,
    "leaseToken": "<RS256 JWT>",
    "leaseExpiresAt": "2026-01-29T12:00:00.000Z"
  }
}
```

**Response (200) — Lifetime:**

```json
{
  "ok": true,
  "data": {
    "status": "active",
    "isLifetime": true,
    "expiresAt": null,
    "currentPeriodEnd": null,
    "serverTime": "2026-01-22T12:00:00.000Z",
    "leaseRequired": false,
    "leaseToken": null,
    "leaseExpiresAt": null
  }
}
```

**Errors:**
| Status | Code | Message |
|--------|------|---------|
| 400 | `VALIDATION_ERROR` | `"entitlementId and deviceId are required"` |
| 401 | `UNAUTHENTICATED` | `"Authentication required"` |
| 403 | `DEVICE_NOT_BOUND` | `"Device is not activated for this entitlement"` |
| 403 | `DEVICE_NOT_OWNED` | `"Device is not registered to your account"` |
| 403 | `ENTITLEMENT_NOT_ACTIVE` | `"Entitlement is no longer active"` |
| 403 | `FORBIDDEN` | `"Device is not active"` |
| 404 | `DEVICE_NOT_FOUND` | `"Device not found"` |
| 404 | `ENTITLEMENT_NOT_FOUND` | `"Entitlement not found"` |

#### Deactivate (Online)

**`POST /api/licence/deactivate`** — Requires `customer-auth`

**Request:**

```json
{
  "entitlementId": 123,
  "deviceId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response (200):**

```json
{
  "ok": true,
  "data": {
    "message": "Device deactivated"
  }
}
```

**Errors:**
| Status | Code | Message |
|--------|------|---------|
| 400 | `VALIDATION_ERROR` | `"entitlementId and deviceId are required"` |
| 400 | `DEVICE_NOT_BOUND` | `"Device is not activated for this entitlement"` |
| 401 | `UNAUTHENTICATED` | `"Authentication required"` |
| 403 | `DEVICE_NOT_OWNED` | `"Device is not registered to your account"` |
| 404 | `DEVICE_NOT_FOUND` | `"Device not found"` |

---

## F. Endpoint Matrix (Portal-Only, App Should Not Call)

These endpoints are used by the web portal for management and billing. The app should not call them directly.

| Endpoint                                   | Purpose                                                 |
| ------------------------------------------ | ------------------------------------------------------- |
| `POST /api/customers/register`             | New account creation                                    |
| `GET /api/customers/me`                    | Profile fetch                                           |
| `PUT /api/customers/profile`               | Profile update                                          |
| `PUT /api/customers/password`              | Password change                                         |
| `POST /api/stripe/billing-portal`          | Stripe billing portal session                           |
| `POST /api/customer-checkout`              | One-time purchase checkout                              |
| `POST /api/customer-checkout-subscription` | Subscription checkout                                   |
| `GET /api/customer/purchase-status`        | Stripe session status polling                           |
| `POST /api/licence/offline-challenge`      | Generate challenge for portal-to-portal offline refresh |
| `POST /api/licence/offline-refresh`        | Redeem challenge for lease (portal-to-portal)           |

---

## G. Online Activation Sequences (Copy/Paste Ready)

### G.1 Initial Setup & Activation

```
1. LOGIN
   POST /api/customers/login
   Body: { "email": "...", "password": "..." }
   → Store token

2. LIST ENTITLEMENTS
   GET /api/customers/me/entitlements
   Headers: { Authorization: Bearer <token> }
   → Display available subscriptions

3. REGISTER DEVICE
   POST /api/device/register
   Headers: { Authorization: Bearer <token> }
   Body: {
     "deviceId": "<uuid>",
     "publicKey": "<base64 Ed25519 SPKI DER>",  // Optional
     "deviceName": "My Workstation",
     "platform": "windows"
   }
   → Device is now known to server

4. ACTIVATE
   POST /api/licence/activate
   Headers: { Authorization: Bearer <token> }
   Body: { "entitlementId": 123, "deviceId": "<uuid>" }
   → Device is now bound to entitlement
   → For subscriptions: immediately call REFRESH to get lease token

5. REFRESH (subscriptions only)
   POST /api/licence/refresh
   Headers: { Authorization: Bearer <token> }
   Body: { "entitlementId": 123, "deviceId": "<uuid>" }
   → Get leaseToken and leaseExpiresAt
   → Store locally, verify signature, schedule next refresh
```

### G.2 Periodic Refresh

```
On app startup and periodically (e.g., daily):

1. Check local lease expiry
2. If < 48 hours remaining OR expired:
   POST /api/licence/refresh
   → Get new lease token
3. Verify RS256 signature locally
4. Update stored lease
```

---

## H. Air-Gapped Activation System

### H.1 Overview

Air-gapped activation allows devices without internet access to activate and refresh via USB/copy-paste transfer of codes through the web portal.

**Requirements:**

- App must generate and store Ed25519 keypair
- App must sign refresh/deactivation codes with private key
- App must verify RS256 signatures on tokens from server

### H.2 Device Setup Code (App → Portal)

Generated by the app. User copies this and pastes into portal.

**Format (JSON, then base64url encoded):**

```json
{
  "v": 1,
  "type": "device_setup",
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "deviceName": "Air-Gapped Workstation",
  "platform": "linux",
  "publicKey": "<base64 Ed25519 SPKI DER>",
  "createdAt": "2026-01-22T12:00:00.000Z"
}
```

| Field        | Required | Constraints              |
| ------------ | -------- | ------------------------ |
| `v`          | Yes      | Must be `1`              |
| `type`       | Yes      | Must be `"device_setup"` |
| `deviceId`   | Yes      | 3–256 chars              |
| `deviceName` | No       | Max 256 chars            |
| `platform`   | No       | Max 64 chars             |
| `publicKey`  | Yes      | 32–1024 chars            |
| `createdAt`  | Yes      | ISO 8601 timestamp       |

### H.3 Activation Package (Portal → App)

User downloads from portal after provisioning. Base64url-encoded JSON:

```json
{
  "v": 1,
  "type": "activation_package",
  "activationToken": "<RS256 JWT>",
  "leaseToken": "<RS256 JWT>",
  "leaseExpiresAt": "2026-01-29T12:00:00.000Z"
}
```

**Activation Token Claims (RS256 JWT, 72-hour TTL):**

```json
{
  "iss": "lightlane",
  "sub": "offline_activation:123:550e8400-...",
  "jti": "<uuid>",
  "iat": 1737547200,
  "exp": 1737806400,
  "typ": "offline_activation",
  "customerId": 456,
  "entitlementId": 123,
  "deviceId": "550e8400-...",
  "devicePublicKeyHash": "<sha256 hex>"
}
```

**App must verify:**

1. RS256 signature is valid (using server public key)
2. `devicePublicKeyHash` matches SHA256 of local public key
3. `deviceId` matches local device ID
4. Token is not expired

### H.4 Lease Refresh Request Code (App → Portal)

Generated by app when lease is expiring. Signed with Ed25519 private key.

**Format (JSON, then base64url encoded):**

```json
{
  "v": 1,
  "type": "lease_refresh_request",
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "entitlementId": 123,
  "jti": "<uuid>",
  "iat": "2026-01-22T12:00:00.000Z",
  "sig": "<base64url Ed25519 signature>"
}
```

**Signature Message (UTF-8 bytes):**

```
LL|v1|lease_refresh_request
<deviceId>
<entitlementId>
<jti>
<iat>
```

### H.5 Lease Refresh Response (Portal → App)

User downloads from portal. Base64url-encoded JSON:

```json
{
  "v": 1,
  "type": "lease_refresh_response",
  "leaseToken": "<RS256 JWT>",
  "leaseExpiresAt": "2026-01-29T12:00:00.000Z"
}
```

### H.6 Deactivation Code (App → Portal)

Signed with Ed25519 private key.

**Format (JSON, then base64url encoded):**

```json
{
  "v": 1,
  "type": "deactivation_code",
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "entitlementId": 123,
  "jti": "<uuid>",
  "iat": "2026-01-22T12:00:00.000Z",
  "sig": "<base64url Ed25519 signature>"
}
```

**Signature Message (UTF-8 bytes):**

```
LL|v1|deactivation_code
<deviceId>
<entitlementId>
<jti>
<iat>
```

### H.7 Cryptographic Operations

#### Ed25519 Keypair Generation

The app must generate an Ed25519 keypair on first run:

```
1. Generate Ed25519 keypair (32-byte seed)
2. Export public key as SPKI DER
3. Base64 encode for storage/transmission
4. Store private key securely (Keychain, Credential Manager, etc.)
5. Store public key and deviceId persistently
```

#### Public Key Hash

```
publicKeyHash = SHA256(SPKI_DER_bytes).hex()
```

Used to bind activation tokens to specific devices.

#### Ed25519 Signing

```python
# Pseudocode
message = "LL|v1|lease_refresh_request\n{deviceId}\n{entitlementId}\n{jti}\n{iat}"
message_bytes = message.encode("utf-8")
signature = ed25519_sign(private_key, message_bytes)
sig = base64url_encode(signature)
```

#### RS256 Verification

```python
# Pseudocode
token = "<JWT>"
public_key = load_pem_public_key(JWT_PUBLIC_KEY)
claims = jwt_verify(token, public_key, algorithms=["RS256"])
# Verify claims: iss, exp, deviceId, etc.
```

### H.8 State Machine

```
┌──────────────┐
│ UNPROVISIONED│ ← App installed, no activation
└──────┬───────┘
       │ Import activation package
       ▼
┌──────────────┐
│  PROVISIONED │ ← Has activationToken + initial leaseToken
└──────┬───────┘
       │ Verify tokens
       ▼
┌──────────────┐
│ ACTIVE LEASE │ ← leaseExpiresAt > now
└──────┬───────┘
       │ Time passes...
       ▼
┌──────────────┐
│ EXPIRED LEASE│ ← leaseExpiresAt < now, grace period
└──────┬───────┘
       │ Import refresh response
       ▼
┌──────────────┐
│ ACTIVE LEASE │ (refreshed)
└──────────────┘
       │ Deactivation code processed
       ▼
┌──────────────┐
│ DEACTIVATED  │ ← Slot freed for another device
└──────────────┘
```

### H.9 Error Handling

| Error Code                      | Meaning                                 | User Action                         |
| ------------------------------- | --------------------------------------- | ----------------------------------- |
| `INVALID_SETUP_CODE`            | Malformed setup code                    | Re-generate from app                |
| `INVALID_REQUEST_CODE`          | Malformed refresh request               | Re-generate from app                |
| `INVALID_DEACTIVATION_CODE`     | Malformed deactivation code             | Re-generate from app                |
| `INVALID_PUBLIC_KEY`            | Public key corrupt or wrong format      | Re-provision device                 |
| `SIGNATURE_VERIFICATION_FAILED` | Ed25519 sig invalid                     | Code may be corrupted; regenerate   |
| `REPLAY_REJECTED`               | JTI already used                        | Generate new code (new jti)         |
| `DEVICE_NOT_BOUND`              | Device not activated for entitlement    | Re-provision device                 |
| `LIFETIME_NOT_SUPPORTED`        | Attempted offline with lifetime license | Lifetime requires online connection |
| `MAX_DEVICES_EXCEEDED`          | Too many active devices                 | Deactivate another device first     |

---

## I. Data the App Must Persist

### Required Storage

| Item                | When Set                 | Purpose                          |
| ------------------- | ------------------------ | -------------------------------- |
| `deviceId`          | First run                | Unique machine identifier (UUID) |
| Ed25519 private key | First run                | Signs air-gapped codes           |
| Ed25519 public key  | First run                | Sent to server, verified against |
| `entitlementId`     | After activation         | Identifies bound subscription    |
| `leaseToken`        | After activation/refresh | Proves active subscription       |
| `leaseExpiresAt`    | After activation/refresh | When to refresh                  |
| `activationToken`   | Air-gapped only          | Proves initial offline binding   |

### Storage Recommendations

**Sensitive (use OS secure storage):**

- Ed25519 private key → macOS Keychain, Windows Credential Manager, Linux Secret Service

**Configuration (can be plaintext file):**

- deviceId
- entitlementId
- leaseExpiresAt

**Tokens (encrypt at rest recommended):**

- leaseToken
- activationToken

---

## J. Appendix: Canonical JSON Examples

### J.1 Full Entitlement Response

```json
{
  "ok": true,
  "entitlements": [
    {
      "id": 123,
      "tier": "pro",
      "status": "active",
      "isLifetime": false,
      "leaseRequired": true,
      "maxDevices": 2,
      "expiresAt": "2026-12-31T23:59:59.000Z",
      "currentPeriodEnd": "2026-02-22T00:00:00.000Z",
      "cancelAtPeriodEnd": false,
      "source": "stripe",
      "createdAt": "2025-01-01T00:00:00.000Z",
      "licenseKey": {
        "id": 456,
        "key": "PRO-0123-ABCD-EFGH",
        "typ": "subscription",
        "isActive": true
      }
    },
    {
      "id": 124,
      "tier": "maker",
      "status": "active",
      "isLifetime": true,
      "leaseRequired": false,
      "maxDevices": 1,
      "expiresAt": null,
      "currentPeriodEnd": null,
      "cancelAtPeriodEnd": false,
      "source": "founders",
      "createdAt": "2024-06-01T00:00:00.000Z",
      "licenseKey": null
    }
  ],
  "meta": {
    "total": 2,
    "hasActiveEntitlement": true
  }
}
```

### J.2 Lease Token Claims

```json
{
  "iss": "lightlane",
  "sub": "ent:123:dev:550e8400-e29b-41d4-a716-446655440000",
  "jti": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "iat": 1737547200,
  "exp": 1738152000,
  "purpose": "lease",
  "entitlementId": 123,
  "customerId": 456,
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "tier": "pro",
  "isLifetime": false
}
```

### J.3 Device Setup Code (Decoded)

```json
{
  "v": 1,
  "type": "device_setup",
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "deviceName": "Air-Gapped Workstation",
  "platform": "linux",
  "publicKey": "MCowBQYDK2VwAyEA...",
  "createdAt": "2026-01-22T12:00:00.000Z"
}
```

### J.4 Lease Refresh Request Code (Decoded)

```json
{
  "v": 1,
  "type": "lease_refresh_request",
  "deviceId": "550e8400-e29b-41d4-a716-446655440000",
  "entitlementId": 123,
  "jti": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
  "iat": "2026-01-22T12:00:00.000Z",
  "sig": "MEUCIQDx..."
}
```

### J.5 Activation Package (Decoded)

```json
{
  "v": 1,
  "type": "activation_package",
  "activationToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "leaseToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "leaseExpiresAt": "2026-01-29T12:00:00.000Z"
}
```

### J.6 Error Response

```json
{
  "ok": false,
  "code": "MAX_DEVICES_EXCEEDED",
  "message": "Maximum devices limit reached. Please deactivate another device first.",
  "details": {
    "maxDevices": 2,
    "activeDevices": 2
  }
}
```

---

## K. Quick Reference: All Error Codes

| Code                            | HTTP    | Meaning                              |
| ------------------------------- | ------- | ------------------------------------ |
| `VALIDATION_ERROR`              | 400     | Missing or invalid request field     |
| `UNAUTHENTICATED`               | 401     | No valid auth token                  |
| `FORBIDDEN`                     | 403     | Not authorized for this resource     |
| `NOT_FOUND`                     | 404     | Generic resource not found           |
| `ENTITLEMENT_NOT_FOUND`         | 404     | Entitlement doesn't exist            |
| `DEVICE_NOT_FOUND`              | 404     | Device doesn't exist                 |
| `DEVICE_NOT_OWNED`              | 403/409 | Device belongs to another customer   |
| `DEVICE_NOT_BOUND`              | 400/403 | Device not activated for entitlement |
| `ENTITLEMENT_NOT_ACTIVE`        | 403     | Subscription expired/canceled        |
| `MAX_DEVICES_EXCEEDED`          | 409     | Would exceed maxDevices limit        |
| `LIFETIME_NOT_SUPPORTED`        | 400     | Offline not available for lifetime   |
| `CHALLENGE_INVALID`             | 400     | Challenge JWT malformed              |
| `CHALLENGE_EXPIRED`             | 400     | Challenge JWT expired                |
| `REPLAY_REJECTED`               | 409     | Code/challenge already used          |
| `INVALID_SETUP_CODE`            | 400     | Malformed device setup code          |
| `INVALID_PUBLIC_KEY`            | 400     | Ed25519 key invalid/corrupted        |
| `INVALID_REQUEST_CODE`          | 400     | Malformed lease refresh request      |
| `INVALID_DEACTIVATION_CODE`     | 400     | Malformed deactivation code          |
| `SIGNATURE_VERIFICATION_FAILED` | 403     | Ed25519 signature invalid            |
| `RATE_LIMITED`                  | 429     | Too many requests                    |
| `RETIRED_ENDPOINT`              | 410     | Endpoint no longer available         |
| `INTERNAL_ERROR`                | 500     | Server error                         |

---

_End of app integration reference._
